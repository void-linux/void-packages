#!/bin/bash
# vim: set ts=4 sw=4 et:

die() {
    printf '%s\n' "$*" >&2
    exit 1
}

pkgname=$1

if [ -z "$pkgname" ]; then
    die "pkgname is required"
fi

XBPS_DISTDIR="$(cd "${0%/*}/../.." && pwd)"
XBPS_SRCPKGDIR="$XBPS_DISTDIR/srcpkgs"

if [ ! -f "$XBPS_SRCPKGDIR/$1/template" ]; then
    die "$pkgname: not found"
fi

source "$XBPS_DISTDIR/common/environment/setup/misc.sh"
source "$XBPS_DISTDIR/common/xbps-src/shutils/update_check.sh"

vars="pkgname|version|homepage|distfiles"
template="$(
    sed -E -n "
        /^[a-z_]*($vars)=[^\"']*\$/p
        /^[a-z_]*($vars)=\"[^\"]*\"\$/p
        /^[a-z_]*($vars)='[^']*'\$/p
        /^[a-z_]*($vars)=\"[^\"]*\$/,/^[^\"]*\"\$/p
        /^[a-z_]*($vars)='[^']*\$/,/^[^']*'\$/p
    " "$XBPS_SRCPKGDIR/$1/template"
)"

# Not really safe
case "$template" in
    *'$('* | *'`'*)
        die "command substitution in pkgname|version|homepage|distfiles"
        ;;
esac

eval "$template"
XBPS_TARGET_PKG=$pkgname

update_check
