# Template file for 'android-tools'
pkgname=android-tools
# NOTE: not all upstream updates has code changes for the parts
#       of android used by android-tools. Check for diff with:
#         curl -L http://git.io/vvC0Z | sh -s 5.0.2_r1 5.1.0_r1
version=9.0.0r35
revision=1
_distver=${version/r/_r}
create_wrksrc=yes
hostmakedepends="ruby cmake ninja perl go"
makedepends="gtest-devel zlib-devel libressl-devel libusb-devel pcre2-devel"
short_desc="Android platform tools (adb and fastboot)"
maintainer="John <johnz@posteo.net>"
license="Apache-2.0, ISC, GPL-2.0-only, MIT"
homepage="http://developer.android.com/tools/help/adb.html"
_baseurl=https://android.googlesource.com/platform
distfiles="
 ${_baseurl}/system/core/+archive/android-${_distver}.tar.gz>core.tar.gz
 ${_baseurl}/system/extras/+archive/android-${_distver}.tar.gz>extras.tar.gz
 ${_baseurl}/external/selinux/+archive/android-${_distver}.tar.gz>selinux.tar.gz
 ${_baseurl}/external/f2fs-tools/+archive/android-${_distver}.tar.gz>f2fs-tools.tar.gz
 ${_baseurl}/external/e2fsprogs/+archive/android-${_distver}.tar.gz>e2fsprogs.tar.gz
 ${_baseurl}/external/avb/+archive/android-${_distver}.tar.gz>avb.tar.gz
 https://boringssl.googlesource.com/boringssl/+archive/3359.tar.gz>boringssl.tar.gz"
# Contents checksums because the tarballs change with every download
checksum="33272788218734ff0380c0d3752c86fc6518e26c84e24be5529400dd96913ad7
 65862e215bcf8cb4f802364ec5525b7da1aeda06f8e5384447bd66af73f1e007
 41da21330831571e1b6113382e2b142a98beeb6a2d60c4a23170bc079ac54996
 b2cfeda8d58ca6ba25f5113e4f8e4d33aabe4b4ceb31a55262aef8eb81cdb53d
 8bd22363ebb21f6ed98b16a5b31fdb37de113461a5f9871665b4ea79880246a6
 036cb3e576b96fa86305b429d0c373b18ea73d78f30f2f34ed2763a63849b2f8
 2a6e3c0a4e98da2df4a4c6fe7bb8dd75fb3f9a8dc56124a5a21361aadbb525f4"

nocross="error: requested alignment 64 is larger than 8 [-Werror=attributes]"

do_extract() {
	local tarball p
	for p in ${distfiles}; do
		tarball=${p##*>}
		mkdir -p ${wrksrc}/${tarball/.*}
		tar -x --no-same-permissions --no-same-owner -f \
			${XBPS_SRCDISTDIR}/${pkgname}-${version}/${tarball} \
			-C ${wrksrc}/${tarball/.*}
	done
}

pre_configure() {
	PKGVER=${_distver} ${FILESDIR}/generate_build.rb > build.ninja

	mkdir -p boringssl/build
	cd boringssl/build

	cmake -GNinja \
		-DBUILD_SHARED_LIBS=FALSE \
		-DCMAKE_BUILD_TYPE=RELEASE \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		..
	ninja
}

do_build() {
	ninja
}

do_install() {
	for i in adb fastboot mke2fs.android e2fsdroid ext2simg \
		core/mkbootimg/mkbootimg avb/avbtool ;do
		vbin $i
	done
	vlicense boringssl/LICENSE boringssl.LICENSE
	vlicense boringssl/third_party/fiat/LICENSE fiat.LICENSE
	vlicense boringssl/third_party/googletest/LICENSE gtest.LICENSE
	vlicense boringssl/third_party/android-cmake/LICENSE android-cmake.LICENSE
	vsv adb
}

# REMARKS:
# If there is any reason at all that fastboot may not be a position independent
# executable, please document it here.
