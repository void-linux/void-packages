#!/bin/sh -e

PREREQS=""

prereqs() { echo "$PREREQS"; }

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

. /usr/share/initramfs-tools/hook-functions

copy_exec /bin/udevd      /bin
copy_exec /bin/udevadm    /bin

mkdir -p "$DESTDIR/lib/systemd"
ln -rs "$DESTDIR/bin/udevd" "$DESTDIR/lib/systemd/systemd-udevd"

mkdir -p "$DESTDIR/etc/udev"
cp -p /etc/udev/udev.conf "$DESTDIR/etc/udev/"

mkdir -p "$DESTDIR/lib/udev/rules.d/"
for rules in 50-udev-default.rules \
        60-block.rules 60-persistent-storage.rules \
        71-seat.rules 75-net-description.rules \
        80-net-name-slot.rules 80-drivers.rules; do
  if   [ -e /etc/udev/rules.d/$rules ]; then
    cp -p /etc/udev/rules.d/$rules "$DESTDIR/lib/udev/rules.d/"
  elif [ -e /lib/udev/rules.d/$rules ]; then
    cp -p /lib/udev/rules.d/$rules "$DESTDIR/lib/udev/rules.d/"
  fi
done

# now copy all custom udev rules which don't have an equivalent in /lib (e. g.
# 70-persistent-net.rules or similar); They might contain network names or
# other bits which are relevant for the initramfs.
for rules in /etc/udev/rules.d/*.rules; do
  if [ -e "$rules" ] && [ ! -e "/lib/${rules#/etc/}" ]; then
    cp -p "$rules" "$DESTDIR/lib/udev/rules.d/"
  fi
done

for program in ata_id scsi_id; do
  copy_exec /lib/udev/$program /lib/udev
done
copy_exec /sbin/blkid /sbin
