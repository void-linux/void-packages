# Template file for 'swift'
pkgname=swift
version=5.2.1
revision=1
create_wrksrc=yes
hostmakedepends="xtools clang cmake make ninja swig pkg-config rsync which
 tzdata python python-six perl tar gzip "
makedepends="python-devel libbsd-devel libxml2-devel sqlite-devel
 libatomic-devel libcurl-devel libuuid-devel libedit-devel systemtap-devel
 ncurses-devel glibc-devel icu-devel "
depends="clang "
short_desc="Apple's high-performance system programming language"
maintainer="dinama <dinama@users.noreply.github.com>"
license="Apache-2.0"
homepage="https://www.swift.org/"

archs="x86_64"
nopie=yes
nostrip=yes

_tag=${pkgname}-${version}-RELEASE

distfiles="https://github.com/apple/swift/archive/${_tag}.tar.gz>swift-${version}.tar.gz
 https://github.com/apple/swift-corelibs-libdispatch/archive/${_tag}.tar.gz>swift-corelibs-libdispatch-${version}.tar.gz
 https://github.com/apple/swift-corelibs-foundation/archive/${_tag}.tar.gz>swift-corelibs-foundation-${version}.tar.gz
 https://github.com/apple/swift-integration-tests/archive/${_tag}.tar.gz>swift-integration-tests-${version}.tar.gz
 https://github.com/apple/swift-corelibs-xctest/archive/${_tag}.tar.gz>swift-corelibs-xctest-${version}.tar.gz
 https://github.com/apple/swift-package-manager/archive/${_tag}.tar.gz>swift-package-manager-${version}.tar.gz
 https://github.com/apple/swift-llbuild/archive/${_tag}.tar.gz>swift-llbuild-${version}.tar.gz
 https://github.com/apple/swift-cmark/archive/${_tag}.tar.gz>swift-cmark-${version}.tar.gz
 https://github.com/apple/swift-xcode-playground-support/archive/${_tag}.tar.gz>swift-xcode-playground-support-${version}.tar.gz
 https://github.com/apple/sourcekit-lsp/archive/${_tag}.tar.gz>sourcekit-lsp-${version}.tar.gz
 https://github.com/apple/indexstore-db/archive/${_tag}.tar.gz>indexstore-db-${version}.tar.gz
 https://github.com/apple/llvm-project/archive/${_tag}.tar.gz>llvm-project-${version}.tar.gz
 https://github.com/apple/swift-syntax/archive/${_tag}.tar.gz>swift-syntax-${version}.tar.gz"

checksum="3488e920ad989b1c6a8d25ef241d356a9951184fefcad19e230e3263b6e80f48
 7bab5d4d1e8e0aea0d7fec80b1dbf7f897389d19566e02ef5cd0e7026b968f10
 5a223f6398d5cedb94019f61beca69eb35473ca2cc65bcbd60d93248342f417d
 c024eabdf1ff95e81761efb0ee8e3189aafe9a310ed73a9f2ff71f1480aba57f
 d25df8b4caaef8e8339ecb2344fd5cbbe10b2e0f33d9861b1ec8fdebf7364645
 73e12edffce218d1fdfd626c2000a9d9f5805a946175899600b50379e885770e
 8812862ef27079fb41f13ac3e741a1e488bd321d79c6a57d026ca1c1e25d90c7
 ac18a4a55739af8afb9009f4d8d7643a78fda47a329e1b1f8c782122db88b3b1
 1425d600563487b412ead6925506678cf28ae10f93854a65b93392fe934cbf95
 9dd65a18a3cff3efcb792b3df96385da1a095645d9c544a122dc3ec9ae7e7938
 43af8eeb9c98847bc610a2093d341b608a4120628c4aa0a410d157c4100d400e
 f21cfa75413ab290991f28a05a975b15af9289140e2f595aa981e630496907e7
 85f62606a22031f3d768350fd3068d7e0955eac796fe4af13413d7fd0c8399f9"

post_extract() {
	# Swift build directories
	mv swift-${_tag} swift
	mv swift-corelibs-libdispatch-${_tag} swift-corelibs-libdispatch
	mv swift-corelibs-foundation-${_tag} swift-corelibs-foundation
	mv swift-integration-tests-${_tag} swift-integration-tests
	mv swift-corelibs-xctest-${_tag} swift-corelibs-xctest
	mv swift-package-manager-${_tag} swiftpm
	mv swift-llbuild-${_tag} llbuild
	mv swift-cmark-${_tag} cmark
	mv swift-xcode-playground-support-${_tag} swift-xcode-playground-support
	mv sourcekit-lsp-${_tag} sourcekit-lsp
	mv indexstore-db-${_tag} indexstore-db
	mv llvm-project-${_tag} llvm-project
	mv swift-syntax-${_tag} swift-syntax

	# 5.2 fix recursive symlinks
	rm -rdf llbuild/include/llvm/Demangle/include
	rm -rdf  llbuild/lib/llvm/Demangle/include
	mkdir -p llbuild/lib/llvm/Demangle/include/llvm
	ln -s ../../../../../include/llvm/Demangle llbuild/lib/llvm/Demangle/include/llvm/Demangle

	# 5.2 fix missing path
	mkdir -p build/buildbot_linux/swiftpm-linux-x86_64/x86_64-pc-linux-gnu
	ln -s ../x86_64-unknown-linux-gnu/release build/buildbot_linux/swiftpm-linux-x86_64/x86_64-pc-linux-gnu/release
}

pre_build() {
	# default python2
	xbps-alternatives -s python python

	# fix  xbps-src hardened flags for clang
	export CFLAGS="${CFLAGS/-fstack-clash-protection/}"
	export CXXFLAGS="${CXXFLAGS/-fstack-clash-protection/}"
	export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/}"
	export CXXFLAGS="${CXXFLAGS/-D_FORTIFY_SOURCE=2/}"

	# flags
	export CC=/usr/bin/clang
	export LDFLAGS="-ldl -lpthread"
	export VERBOSE=1
}

do_build() {
	cd swift
	utils/build-script --preset=buildbot_linux,no_test \
		install_destdir=${wrksrc} \
		installable_package=${wrksrc}/${_tag}-void.tar.gz
}

do_install() {
	#rm -rdf usr
	#tar -xf ${_tag}-void.tar.gz

	# swift
	vmkdir usr/libexec/swift
	vcopy usr/* usr/libexec/swift

	# man, ldconfig
	# vinstall ${FILESDIR}/swift.conf 644 etc/ld.so.conf.d
	vman usr/share/man/man1/swift.1

	# links
	vmkdir usr/bin
	ln -fs /usr/libexec/swift/bin/swift ${DESTDIR}/usr/bin/swift
	ln -fs /usr/libexec/swift/bin/swiftc ${DESTDIR}/usr/bin/swiftc
	ln -fs /usr/libexec/swift/bin/sourcekit-lsp ${DESTDIR}/usr/bin/sourcekit-lsp
}
