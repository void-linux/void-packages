# Template file for 'curl'
pkgname=curl
version=7.70.0
revision=1
build_style=gnu-configure
configure_args="ac_cv_sizeof_off_t=8 --enable-threaded-resolver --enable-ipv6
 $(vopt_with rtmp) $(vopt_with gssapi) $(vopt_enable ldap) $(vopt_with gnutls)
 $(vopt_enable ldap ldaps) $(vopt_with ssh libssh2) $(vopt_with ssl)
 --with-ca-bundle=/etc/ssl/certs/ca-certificates.crt --without-libidn2"
hostmakedepends="groff perl pkg-config"
makedepends="nghttp2-devel zlib-devel $(vopt_if gnutls 'gnutls-devel')
 $(vopt_if gssapi 'mit-krb5-devel') $(vopt_if ldap 'libldap-devel')
 $(vopt_if rtmp 'librtmp-devel') $(vopt_if ssh 'libssh2-devel')
 $(vopt_if ssl 'libressl-devel')"
depends="ca-certificates"
checkdepends="python3"
short_desc="Client that groks URLs"
maintainer="Juan RP <xtraeme@gmail.com>"
license="MIT"
homepage="https://curl.haxx.se"
changelog="https://curl.haxx.se/changes.html#${version//./_}"
distfiles="${homepage}/download/${pkgname}-${version}.tar.bz2"
checksum=a50bfe62ad67a24f8b12dd7fd655ac43a0f0299f86ec45b11354f25fbb5829d0
patch_args="-Np1"
lib_shlib_provides="libcurl-gnutls.so.4"
build_options="gnutls gssapi ldap rtmp ssh ssl"
build_options_default="ssh ssl"
vopt_conflict ssl gnutls

pre_configure() {
	export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/}"
	export CFLAGS="${CFLAGS/-I${XBPS_CROSS_BASE}\/usr\/include/}"
	export CPPFLAGS="-D_FORTIFY_SOURCE=2"
}

post_install() {
	vlicense COPYING
}

lib_post_install() {
	ln -sf libcurl.so.4.6.0 ${PKGDESTDIR}/usr/lib/libcurl-gnutls.so.4
}

vsplit_lib "" "Multiprotocol file transfer library"
vsplit_devel
