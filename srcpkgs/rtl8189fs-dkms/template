# Template file for 'rtl8189fs-dkms'
pkgname=rtl8189fs-dkms
version=20191128
revision=1
_modver="v5.7.9_35795.20191128"
_gitrev="94cc959d56c1425fbca4f6e49e949cf58ec5dc8d"
depends="dkms"
short_desc="Realtek 8189FS WiFi driver (DKMS)"
maintainer="Emil Tomczyk <emru@emru.xyz>"
license="GPL-2.0-only"
homepage="https://github.com/jwrdegoede/rtl8189ES_linux/tree/rtl8189fs"
distfiles="https://github.com/jwrdegoede/rtl8189ES_linux/archive/${_gitrev}.tar.gz"
checksum=a621c0df9372d952449a06abb82f1edb806ad3200f9b1dd54fa9beab08d81b92
dkms_modules="rtl8189fs ${_modver}"

case "$XBPS_TARGET_MACHINE" in
	x86_64*) _karch="x86_64";;
	i686*) _karch="i386";;
	aarch64*) _karch="arm64";;
	arm*) _karch="arm";;
	ppc*) _karch="powerpc";;
	mips*) _karch="mips";;
	riscv64*) _karch="riscv64";;
	*) broken="kernel arch not defined";;
esac

post_patch() {
	if [ "$XBPS_TARGET_ENDIAN" = "be" ]; then
		vsed -i 's,@@VOID_ENDIAN@@,BIG,g' Makefile
	else
		vsed -i 's,@@VOID_ENDIAN@@,LITTLE,g' Makefile
	fi
	vsed -i "s,@@VOID_ARCH@@,${_karch},g" Makefile
	rm -f *.patch
}


do_install() {
	local dest=/usr/src/rtl8189fs-${_modver}

	cat <<-EOF >dkms.conf
	PACKAGE_NAME="rtl8189fs"
	PACKAGE_VERSION="${_modver}"
	MAKE="'make' KVER=\${kernelver}"
	BUILT_MODULE_NAME[0]="8189fs"
	DEST_MODULE_LOCATION[0]="/kernel/drivers/net/wireless"
	EOF
	vmkdir ${dest}
	cp -r dkms.conf Kconfig Makefile platform core hal include os_dep ${DESTDIR}/${dest}

	# modules-load.d(5) file.
	vmkdir usr/lib/modules-load.d
	echo "8189fs" > ${DESTDIR}/usr/lib/modules-load.d/${pkgname}.conf
	chmod 644 ${DESTDIR}/usr/lib/modules-load.d/${pkgname}.conf
}
