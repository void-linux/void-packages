# Template file for 'stremio-shell'
pkgname=stremio-shell
version=4.4.168
revision=1
_singleapplication=3.2.0
_libmpv=0.32.0
build_style=qmake
hostmakedepends="qt6-base"
makedepends="mpv-devel qt6-webview-devel qt6-webengine-devel
 qt6-declarative-devel qt6-webchannel-devel qt6-location-devel
 chromaprint-devel"
depends="virtual?nodejs-runtime"
short_desc="Hub for video content aggregation"
maintainer="mobinmob <mobinmob@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://www.stremio.com"
distfiles="https://github.com/Stremio/stremio-shell/archive/v${version}.tar.gz
 https://github.com/itay-grudev/SingleApplication/archive/v${_singleapplication}.tar.gz
 https://raw.githubusercontent.com/mpv-player/mpv/v${_libmpv}/libmpv/qthelper.hpp
 https://dl.strem.io/four/v${version}/server.js
 https://dl.strem.io/four/v${version}/stremio.asar"
checksum="764a181cc61189f0a7cff631dbc7398faf12eef33beeefb149ce5c504ab99998
 088cf1ca9e07546db280795d97703b15deea0ca69e9c01eef34412c665e37c57
 86e1fcba6001829b7e23a856db84d01ebc76e63528f74064d7bc5705015a2684
 683de7890a60ab512264b69c9c41609aa515f9b738aef18df4803ef53e17175d
 de34860e99a78f37e8c5568e56e605bc04e1853d48d2102421fcf2331a42d207"
skip_extraction="server.js stremio.asar qthelper.hpp v${_singleapplication}"

post_extract() {
	vsrcextract -C deps/singleapplication v${_singleapplication}.tar.gz
	mkdir deps/libmpv/include
	cp -a $XBPS_CROSS_BASE/usr/include/mpv deps/libmpv/include
	vsrccopy qthelper.hpp deps/libmpv/include/mpv
}

post_install() {

	# Fix the bizarre locations
	vmkdir usr/lib/stremio
	mv "${DESTDIR}/usr/opt/stremio/stremio" "${DESTDIR}/usr/lib/stremio"

	# Move .desktop file to proper location
	vmkdir usr/share/applications
	mv "${DESTDIR}/usr/opt/stremio/smartcode-stremio.desktop" "${DESTDIR}/usr/share/applications"

	# Link executable in PATH
	vmkdir usr/bin
	ln -s /usr/lib/stremio/stremio "${DESTDIR}/usr/bin/stremio"

	# Symlink node in the instalation directory
	ln -s /usr/bin/node "${DESTDIR}/usr/lib/stremio/node"

	# Install icon
	vmkdir usr/share/icons
	cp "${wrksrc}/images/stremio_window.png" "${DESTDIR}/usr/share/icons/smartcode-stremio.png"

	# Copy server
	cp "${XBPS_SRCDISTDIR}/${pkgname}-${version}/server.js" "${DESTDIR}/usr/lib/stremio"
	cp "${XBPS_SRCDISTDIR}/${pkgname}-${version}/stremio.asar" "${DESTDIR}/usr/lib/stremio"
}
