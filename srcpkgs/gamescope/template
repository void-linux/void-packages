# Template file for 'gamescope'
pkgname=gamescope
version=3.14.23
revision=1
_stb_hash=5736b15f7ea0ffb08dd38af21067c314d6a3aae9
_vkroots_hash=5106d8a0df95de66cc58dc1ea37e69c99afc9540
_reshade_hash=9fdbea6892f9959fdc18095d035976c574b268b7
_libliftoff_hash=8b08dc1c14fd019cc90ddabe34ad16596b0691f4
_wlroots_hash=a5c9826e6d7d8b504b07d1c02425e6f62b020791
build_style=meson
configure_args="-Denable_openvr_support=false"
hostmakedepends="glslang pkg-config wayland-devel"
makedepends="pipewire-devel SPIRV-Headers libX11-devel
 libXdamage-devel libXcomposite-devel libXrender-devel libXxf86vm-devel
 libXtst-devel libXres-devel libdrm-devel vulkan-loader-devel wayland-protocols
 libxkbcommon-devel libcap-devel SDL2-devel hwids glm libXmu-devel
 libdisplay-info-devel benchmark-devel libavif-devel xorg-server-xwayland
 libei-devel pixman-devel libseat-devel libinput-devel xcb-util-wm-devel"
depends="xorg-server-xwayland"
short_desc="SteamOS session compositing window manager"
maintainer="Dexter Gaon-Shatford <dexter.gaonshatford@gmail.com>"
license="BSD-2-Clause, BSD-3-Clause, MIT"
homepage="https://github.com/ValveSoftware/gamescope"
distfiles="https://github.com/ValveSoftware/gamescope/archive/refs/tags/${version}.tar.gz
 https://github.com/nothings/stb/archive/${_stb_hash}.tar.gz
 https://github.com/Joshua-Ashton/vkroots/archive/${_vkroots_hash}.tar.gz
 https://github.com/Joshua-Ashton/reshade/archive/${_reshade_hash}.tar.gz
 https://gitlab.freedesktop.org/emersion/libliftoff/-/archive/${_libliftoff_hash}/libliftoff-${_libliftoff_hash}.tar.gz
 https://gitlab.freedesktop.org/emersion/wlroots/-/archive/${_wlroots_hash}/wlroots-${_wlroots_hash}.tar.gz"
checksum="d384641fdea5941f5e91658f8dfb54e1913232300efde66764199549f6fa3af2
 d00921d49b06af62aa6bfb97c1b136bec661dd11dd4eecbcb0da1f6da7cedb4c
 37b77586e91f7ebee70380dcddd73bf01ae4acef1053e6be41d0485ede022422
 165726ad21fbfc221c0363e40b597834068a416a11a1204ae2ac6d13ec161035
 8de28aee6f90f47b7fc7037dcd2360166197c0b5d2033f3afdbd34f2ea1bf216
 f3f91b679114e565d94e87cd0c4c61444e48d7ef8a77cd101ef3081fd87f4726"
skip_extraction="${_stb_hash}.tar.gz
 ${_vkroots_hash}.tar.gz
 ${_reshade_hash}.tar.gz
 libliftoff-${_libliftoff_hash}.tar.gz
 wlroots-${_wlroots_hash}.tar.gz"

post_extract() {
	vsrcextract -C subprojects/stb "${_stb_hash}.tar.gz"
	cp subprojects/packagefiles/stb/meson.build subprojects/stb
	vsrcextract -C subprojects/vkroots "${_vkroots_hash}.tar.gz"
	vsrcextract -C subprojects/libliftoff "libliftoff-${_libliftoff_hash}.tar.gz"
	vsrcextract -C subprojects/wlroots "wlroots-${_wlroots_hash}.tar.gz"
	vsrcextract -C src/reshade "${_reshade_hash}.tar.gz"
}

post_patch() {
	# Use system SPIRV headers rather than gamescope's vendored headers
	vsed -i src/meson.build -e "s|../thirdparty/SPIRV-Headers/include/spirv/unified1|${XBPS_CROSS_BASE}/usr/include/spirv/unified1|"
	# Disable werror in libliftoff due to their test files having numerous warnings mistakes.
	vsed -i subprojects/libliftoff/meson.build -e "s|'werror=true'|'werror=false'|"
	vsed -i subprojects/wlroots/meson.build -e "s|'werror=true'|'werror=false'|"
}

post_install() {
	vlicense LICENSE
	rm ${DESTDIR}/usr/lib/pkgconfig/vkroots.pc
	rm ${DESTDIR}/usr/include/vkroots.h
}
