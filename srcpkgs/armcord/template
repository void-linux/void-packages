
# Template file for 'armcord'
pkgname=armcord
version=3.1.4
revision=1
archs="x86_64* i686* aarch64* armv7l*"
hostmakedepends="nodejs electron19 git"
depends="alsa-lib dbus-glib libnotify atk gtk+3 nss xdg-utils webrtc-audio-processing"
short_desc="Custom client designed to enhance Discord experience"
maintainer="Zoh-j02r <saulobruno@usp.br>"
license="custom:OSL-3.0"
homepage="https://github.com/ArmCord/ArmCord"
distfiles="${homepage}/archive/refs/tags/v${version}.tar.gz"
checksum="4b40b58a73b0c81b0fa75e40ae0167ee5d7f35fc09b94e4a993bc09cd2e41974"
nopie=yes

do_patch() {
	if [ "$CROSS_BUILD" ]; then
		vsed -i 's|--dir|--dir --'"$(_get_arch)"'|'  package.json
	else
		vsed -e 's|--dir|--dir -c.electronDist=/usr/lib/electron19/ -c.electronVersion=electron|' \
		-i package.json
	fi
}

do_build() {
	npm_config_arch=$(_get_arch) 
	npx --yes pnpm install --frozen-lockfile --ignore-scripts
	npm run packageQuick
}

_get_arch() {
	case "${XBPS_TARGET_MACHINE}" in
		x86_64*) echo x64 ;;
		i686*) echo ia32 ;;
		aarch64*) echo arm64 ;;
		armv7l*) echo armv7l ;;
		*) msg_error "${XBPS_TARGET_MACHINE} architecture not supported.\n" ;;
	esac
}

do_install() {
	local package_location="usr/lib/$pkgname" item
	vmkdir ${package_location}
	vinstall build/icon.png 644 /usr/share/pixmaps/ armcord.png
	vcopy dist/*-unpacked/* $package_location
	vmkdir usr/bin
	ln -sfr $DESTDIR/$package_location/$pkgname $DESTDIR/usr/bin/armcord
	vinstall ${FILESDIR}/${pkgname}.desktop 644 usr/share/applications
}

post_install() {
	vlicense LICENSE
}
