# Template file for 'autofirma'
pkgname=autofirma
version=1.9
revision=1
_jmulticard_version=2.0
_clienteafirma_external_version=1.0.6
_java_websocket_commit=8c5766a293c2dd3e0d035c0e0d70f88f57235fa8
hostmakedepends="apache-maven openjdk17"
depends="virtual?java-environment"
short_desc="Electronic signature client from the Spanish Public Administration"
maintainer="Eloi Torrents <eloitor@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://firmaelectronica.gob.es/"
distfiles="https://github.com/ctt-gob-es/clienteafirma/archive/v${version}.tar.gz
 https://github.com/ctt-gob-es/jmulticard/archive/refs/tags/v${_jmulticard_version}.tar.gz
 https://github.com/ctt-gob-es/clienteafirma-external/archive/refs/tags/v${_clienteafirma_external_version}.tar.gz
 https://github.com/TooTallNate/Java-WebSocket/archive/${_java_websocket_commit}.tar.gz"
checksum="639c14bae0c41955e74714d2eba9727eb8e1828c6ca548686195a6ac9c898f09
 c971fb195dcc52b1d3091f0e7a10e3edacc926a5772b882d4cef7a25ac2743fb
 6e3613e0929bc2ace27b3750cebbe913a3f1bbfdf6b213f2291827eb7988dd00
 da5ba254e12d2e7fd8a58b30fd4c8baa7bdc893efa63a3fb58da171bbc858542"


# maven-surefire-plugin needed
make_check=no

do_build() {
	. /etc/profile.d/jdk.sh
	cd "Java-WebSocket-${_java_websocket_commit}"
	mvn clean install -Dmaven.test.skip=true
	cd ..

	cd "jmulticard-${_jmulticard_version}"
	mvn clean install -Dmaven.test.skip=true
	cd ..

	cd "clienteafirma-external-${_clienteafirma_external_version}"
	mvn clean install -Dmaven.test.skip=true
	cd ..

	cd "clienteafirma-${version}"
	mvn clean install -Denv=devel -Dmaven.test.skip=true
	mvn clean install -Denv=install -Dmaven.test.skip=true
}

do_check() {
	cd "jmulticard-${_jmulticard_version}"
	mvn test
	cd "clienteafirma_external-${_clienteafirma_external_version}"
	mvn test
	cd "../clienteafirma-${version}"
	mvn test
}

do_install() {
	vmkdir usr/share/java/${pkgname}
	vinstall clienteafirma-${version}/afirma-simple/target/autofirma.jar 644 usr/share/java/autofirma
	vinstall clienteafirma-${version}/afirma-simple-installer/linux/instalador_deb/src/usr/share/applications/afirma.desktop 644 /usr/share/applications
	vbin "${FILESDIR}/autofirma"
}
