# Template file for 'vscode-oss'
pkgname=vscode-oss
version=1.26.1
revision=4
wrksrc="vscode-${version}"
hostmakedepends="pkg-config python nodejs-lts yarn"
makedepends="libX11-devel libxkbfile-devel libsecret-devel"
depends="GConf libXtst libxkbfile nss"
conflicts="vscode"
short_desc="Microsoft Code for Linux"
maintainer="shizonic <realtiaz@gmail.com>"
license="MIT"
homepage="https://code.visualstudio.com/"
distfiles="https://github.com/Microsoft/vscode/archive/${version}.tar.gz"
checksum=1147b8f665cc8d025d09a5250c284d5a7a2d0d1a6bc5a97eaf3a33864b21339e
patch_args="-Np1"

# Due to electron
only_for_archs="i686 x86_64"
nostrip_files="code-oss"

# Due to this bug:
# https://github.com/Microsoft/vscode/issues/23946
_software_rendering="yes"

# The default memory limit may be too low for current versions of node
# to successfully build vscode.  This sets it to 4GB, but
# change this number if it still doesn't work for your system.
_mem_limit="--max_old_space_size=4096"

case "$XBPS_TARGET_MACHINE" in
	i686)	broken="https://build.voidlinux.eu/builders/i686_builder/builds/10486/steps/shell_3/logs/stdio"
		_ARCH="ia32";;
	x86_64) _ARCH="x64";;
esac

post_extract() {
	if [ "${_software_rendering}" = "yes" ]; then
		sed -i 's/ELECTRON_RUN_AS_NODE=1/LIBGL_ALWAYS_SOFTWARE=1 ELECTRON_RUN_AS_NODE=1/' resources/linux/bin/code.sh
	fi
}

do_build() {
	export NODE_OPTIONS="${_mem_limit}"
	yarn install --ignore-engines --arch=${_ARCH}
	yarn run gulp vscode-linux-${_ARCH}
}

do_install() {
	vmkdir usr/lib
	mv ../VSCode-linux-${_ARCH} ${DESTDIR}/usr/lib/code-oss
	vmkdir usr/bin
	ln -sf /usr/lib/code-oss/bin/code-oss ${DESTDIR}/usr/bin/code
	vinstall resources/linux/code.desktop 644 usr/share/applications/
	vlicense LICENSE.txt
}
