# Template file for 'drawterm'
pkgname=drawterm
version=393
revision=3
wrksrc="drawterm"
hostmakedepends="mercurial"
makedepends="libX11-devel libXt-devel"
short_desc="Connect to Plan 9 CPU servers from other operating systems"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="LPL-1.02"
homepage="http://drawterm.9front.org/"

CFLAGS="-fno-strict-aliasing"

if [ "${XBPS_TARGET_MACHINE}" = armv5tel ]; then
	CFLAGS+=" -DARMv5"
fi

do_fetch() {
	hg clone --rev ${version} https://code.9front.org/hg/drawterm ${wrksrc}
}

post_fetch() {
	mkdir ${wrksrc}/posix-aarch64
	cp ${wrksrc}/posix-arm64/* ${wrksrc}/posix-aarch64/
	cp ${FILESDIR}/tas.c ${wrksrc}/posix-power/
}

do_configure() {
	local _arch;

	case "$XBPS_TARGET_MACHINE" in
		aarch64*) _arch=aarch64 ;;
		arm64*) _arch=arm64 ;;
		arm*) _arch=arm ;;
		i686*) _arch=386 ;;
		mips*) _arch=mips ;;
		x86_64*) _arch=amd64 ;;
		ppc*) _arch=power ;;
	esac

	sed -i Make* */Makefile \
		-e 's%$(CFLAGS)%$(_CFLAGS)%' \
		-e 's%$(LDFLAGS)%$(_LDFLAGS)%'
	sed -i -e 's%^CFLAGS=%_CFLAGS=$(CFLAGS) %' \
		-e 's%^LDFLAGS=%_LDFLAGS=$(LDFLAGS) %' \
		-e "s%arch=.*%arch=$_arch; \\\\%" Make.unix
}

do_build() {
	make AR=$AR RANLIB=$RANLIB CC=$CC CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" CONF=unix ${makejobs}
}

do_install() {
	vbin drawterm
	vlicense LICENSE
	vman drawterm.1
}
