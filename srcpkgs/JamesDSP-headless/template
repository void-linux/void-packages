# Template file for 'JamesDSP-headless'
# Keep in sync with JamesDSP
pkgname=JamesDSP-headless
version=2.7.0
revision=1
build_style=qmake
configure_args="CONFIG+=HEADLESS"
hostmakedepends="gcc make pkg-config qt6-base"
makedepends="libarchive-devel qt6-base-devel qt6-svg-devel glib-devel glibmm-devel pipewire-devel"
short_desc="Audio effect processor for PipeWire and PulseAudio clients - headless"
maintainer="Anachron <gith@cron.world>"
license="GPL-3.0-or-later"
homepage="https://github.com/Audio4Linux/JDSP4Linux"
_liveprogide_commit=b2f392480e00ca232c397610f42688b165b87640
distfiles="https://github.com/Audio4Linux/JDSP4Linux/archive/refs/tags/${version}.tar.gz
 https://github.com/timschneeb/LiveprogIDE/archive/${_liveprogide_commit}.tar.gz"
checksum="9acbc0e67fe94ecfa770b007c1d70a3efcf267be355fb15cd0ca6a307a479bc5
 83362bd38f6c8c189d71e7e48004a35ecc90075ace683c388ffb0b6bab5b87b7"
skip_extraction="
 ${_liveprogide_commit}.tar.gz"
conflicts="JamesDSP"

case "${XBPS_TARGET_MACHINE}" in
 *-musl) broken="subtree/Main/libjamesdsp/jni/jamesdsp/jdsp/jdspController.c:66:24: error: storage size of 'tv' isn't known";;
 aarch64) broken="https://github.com/Audio4Linux/JDSP4Linux/issues/187";;
esac

post_extract() {
	vsrcextract -C src/subprojects/EELEditor "${_liveprogide_commit}.tar.gz"
	vsed -i -e "s|^DEFINES += APP_VERSION=.*$|DEFINES += APP_VERSION=${version}|g" "src/src.pro"
	vsed -i -e "s|^TARGET =.*$|TARGET = jamesdsp-headless|g" "src/src.pro"
}
