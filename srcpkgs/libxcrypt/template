# Template file for 'libxcrypt'
pkgname=libxcrypt
version=4.4.33
revision=1
configure_args="--enable-hashes=all --disable-failure-tokens"
hostmakedepends="perl"
checkdepends="python3-passlib"
short_desc="Modern library for one-way hashing of passwords"
maintainer="oreo639 <oreo639@gmail.com>"
license="LGPL-2.1-or-later, BSD-3-Clause, BSD-2-Clause, 0BSD, Public Domain"
homepage="https://github.com/besser82/libxcrypt"
distfiles="https://github.com/besser82/libxcrypt/releases/download/v${version}/libxcrypt-${version}.tar.xz"
checksum=e87acf9c652c573a4713d5582159f98f305d56ed5f754ce64f57d4194d6b3a6f
subpackages="libxcrypt-devel"
build_options="compat"
build_options_default=""

desc_option_compat="Enable glibc compatibility library"

if [ "$XBPS_TARGET_LIBC" = "glibc" ]; then
build_options_default+=" compat"
fi

if [ "$build_option_compat" ]; then
subpackages+=" libxcrypt-compat"
fi

do_configure() {
if [ "$build_option_compat" ]; then
	(
		mkdir compat-build
		cd compat-build
		../configure --prefix=/usr --enable-obsolete-api=glibc ${configure_args}
	)
fi

	(
		mkdir build
		cd build
		../configure --prefix=/usr --enable-obsolete-api=no ${configure_args}
	)
}

do_build() {
if [ "$build_option_compat" ]; then
	(
		cd compat-build
		make ${makejobs} ${make_build_args} ${make_build_target}
	)
fi

	(
		cd build
		make ${makejobs} ${make_build_args} ${make_build_target}
	)
}

do_install() {
if [ "$build_option_compat" ]; then
	(
		cd compat-build
		make DESTDIR=${DESTDIR} install ${make_install_target}
		rm -r ${DESTDIR}/usr/{include,lib/{lib*.so,pkgconfig},share}
	)
fi

	(
		cd build
		make DESTDIR=${DESTDIR} install ${make_install_target}
	)
}

post_install() {
	vlicense LICENSING
}

do_check() {
	: ${make_check_target:=check}
if [ "$build_option_compat" ]; then
	${make_check_pre} make -C compat-build ${makejobs} ${make_check_args} ${make_check_target}
fi
	${make_check_pre} make -C build ${makejobs} ${make_check_args} ${make_check_target}
}

libxcrypt-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/lib/pkgconfig
		vmove usr/include
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
		vmove usr/share
	}
}

libxcrypt-compat_package() {
	short_desc+=" - legacy compatibility"
	pkg_install() {
		vmove usr/lib/libcrypt.so.1*
	}
}
