# Template file for 'python3-debugpy'
pkgname=python3-debugpy
version=1.8.9
revision=1
archs="i686* x86_64* aarch64*"
build_style=python3-pep517
make_check_args="--timeout=0 -vv --log-cli-level=DEBUG"
hostmakedepends="python3-setuptools python3-devel python3-wheel"
depends="python3"
checkdepends="python3-pytest python3-pytest-xdist python3-pytest-timeout python3-importlib_metadata python3-psutil python3-untangle python3-Flask python3-gevent python3-numpy python3-requests python3-typing_extensions"
short_desc="Implementation of the Debug Adapter Protocol for Python"
maintainer="Zachary Hanham <z@zmhanham.com>"
license="MIT"
homepage="https://github.com/microsoft/debugpy/"
distfiles="https://github.com/microsoft/debugpy/archive/refs/tags/v${version}.tar.gz"
checksum=5bfe7303e21d6cf7bfc9f81931303924ce27873e23d08699568bde52c35a405c

# Suffix for attach lib compiled in pre_build
case "$XBPS_TARGET_MACHINE" in
	i686*) _attach_lib_suffix='x86';;
	x86_64*) _attach_lib_suffix='amd64';;
	aarch64*) _attach_lib_suffix='arm64';;
	*) broken='unsupported platform for pydevd_attach_to_process';;
esac

pre_build() {
	# Compile pydevd_attach_to_process's attach_linux_*.so lib
	# Based on contents of linux_and_mac/compile_linux.sh
	cd src/debugpy/_vendored/pydevd/pydevd_attach_to_process
	${CXX} ${CXXFLAGS} linux_and_mac/attach.cpp -Ilinux_and_mac -std=c++11 -fPIC -nostartfiles -shared -o "attach_linux_${_attach_lib_suffix}.so"
}

pre_check() {
	# Do not wait for spawns/exits
	export DEBUGPY_PROCESS_SPAWN_TIMEOUT=0
	export DEBUGPY_PROCESS_EXIT_TIMEOUT=0
}

post_install() {
	vlicense LICENSE
}
