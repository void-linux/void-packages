# Template file for 'Bitwarden'
pkgname=Bitwarden
version=1.16.4
revision=1
_jslib_commit=6b82cd0380d33c83e8b242713eb173d94e16e9f4
archs="x86_64"
wrksrc="desktop-${version}"
hostmakedepends="git python nodejs-lts pkg-config"
makedepends="libsecret-devel libXScrnSaver-devel"
depends="libsecret"
short_desc="Secure and free password manager for all of your devices"
maintainer="ray851107 <ray851107@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://bitwarden.com"
distfiles="
 https://github.com/bitwarden/desktop/archive/v${version}.tar.gz
 https://github.com/bitwarden/jslib/archive/${_jslib_commit}.tar.gz"
checksum="
 f947f924dd3be6102d869324249cf3506094a6c3bf55102196ecaebeecceee9f
 0e899a128a3c602c549a991d5d10e657b1b3b88eb4c8380598a1bd84fbd02f29"

post_extract() {
	rmdir jslib
	mv -v ../jslib-${_jslib_commit} jslib
}

do_patch() {
	vsed -i package.json -e 's/ && npm run sub:init//'
}

do_build() {
	npm --prefix jslib install
	# workaround for https://github.com/npm/npm/issues/3497
	npm install --unsafe-perm
	npm run build
	./node_modules/.bin/electron-builder --dir build
}

do_install() {
	vmkdir usr/lib/Bitwarden
	vcopy dist/linux-unpacked/* usr/lib/Bitwarden

	vmkdir usr/bin
	ln -s /usr/lib/Bitwarden/bitwarden ${DESTDIR}/usr/bin/

	vmkdir usr/share/applications
	vinstall ${FILESDIR}/bitwarden.desktop 644 usr/share/applications/

	vmkdir usr/share/icons/hicolor
	for size in 16 32 48 128 256 512; do
		vinstall resources/icons/${size}x${size}.png 644 usr/share/icons/hicolor/${size}x${size}/apps/ bitwarden.png
	done
}
