# Template file for 'mathematica'
pkgname=mathematica
version=13.0.0
revision=1
archs="x86_64"
hostmakedepends="tar xz"
depends="$(vopt_if notebook 'alsa-lib xdg-user-dirs mesa-dri')"
short_desc="Computational software"
maintainer="dkwo <nicolopiazzalunga@gmail.com>"
license="custom:Proprietary"
homepage="https://wolfram.com/mathematica"
noshlibprovides=yes
noverifyrdeps=yes
nopie=yes
nostrip=yes
repository=nonfree
restricted=yes
python_version=3

build_options="nodocs notebook"
build_options_default="nodocs"
desc_option_nodocs="Remove documentation (saves 6GB+)"
desc_option_notebook="Add dependecies to run notebook"

_M_BINARIES="MathKernel Mathematica WolframKernel math mathematica mcc wolfram"

do_build() {
	if [ ! -f ${FILESDIR}/Mathematica_${version}_BNDL_LINUX.sh ]; then
		echo 'please provide the installer script'
		return 1
	fi
	cp ${FILESDIR}/Mathematica_${version}_BNDL_LINUX.sh Mathematica.sh
	chmod +x Mathematica.sh
	sh Mathematica.sh -- \
		-execdir=${DESTDIR}/usr/bin \
		-targetdir=${DESTDIR}/opt/Mathematica \
		-auto
}

do_install() {
	# fix permissions
	chmod -R go-w ${DESTDIR}/*
	vlicense ${DESTDIR}/opt/Mathematica/LICENSE.txt
	$(vopt_if nodocs "rm -rf ${DESTDIR}/opt/Mathematica/Documentation")
	# remove MacOS- and Windows-specific files
	cd ${DESTDIR}/opt/Mathematica
	find AddOns SystemFiles -type d -\( -name Windows -o -name Windows-x86-64 \
		-o -name MacOSX -o -name MacOSX-x86-64 -\) -exec rm -rv {} +
	# fix symlinks
	cd ${DESTDIR}/opt/Mathematica/Executables
	rm wolframscript
	ln -s /opt/Mathematica/SystemFiles/Kernel/Binaries/Linux-x86-64/wolframscript
	cd ${DESTDIR}/usr/bin
	rm *
	for _i in ${_M_BINARIES}; do
		ln -s /opt/Mathematica/Executables/$_i
	done
	ln -s /opt/Mathematica/SystemFiles/Kernel/Binaries/Linux-x86-64/ELProver
	ln -s /opt/Mathematica/SystemFiles/Kernel/Binaries/Linux-x86-64/wolframscript
}
