# Template file for 'uzdoom'
pkgname=uzdoom
version=4.14.3
revision=1
# Code contains compile-time checks to ensure 64bit...
archs="x86_64* aarch64*"
build_style=cmake
hostmakedepends="pkg-config"
makedepends="bzip2-devel libgomp-devel libopenal-devel SDL2-devel libvpx-devel
 libwebp-devel libwaylandpp-devel ZMusic-devel"
short_desc="Feature centric port for all Doom engine games, based on GZDoom"
maintainer="Greg Beard <gmbeard@googlemail.com>"
license="GPL-3.0-or-later"
homepage="https://github.com/UZDoom/UZDoom"
changelog="https://github.com/UZDoom/UZDoom/releases"
distfiles="https://github.com/UZDoom/UZDoom/archive/refs/tags/${version}.tar.gz"
checksum=6ee381395e249fd02a8484e0e98330afd1cdf222b26cafece7b3d3f5188d7014
# Cross-building seems to require a successful host-native build first, so
# it can import a bunch of tooling built by the project itself...
nocross=yes

if [ "$XBPS_TARGET_LIBC" = musl ]; then
	CFLAGS+=" -DZ7_AFFINITY_DISABLE"
	CXXFLAGS+=" -DZ7_AFFINITY_DISABLE"
	makedepends+=" musl-fts-devel libexecinfo-devel"
fi

post_extract() {
	# Prevent configure stage from using git to extract the version info...
	vsed -i tools/updaterevision/UpdateRevision.cmake -e 's/main()/return()/g'

	sed "
		s/@Tag@/${version}/;
		s/@Hash@/v${version}/;
		s/@Timestamp@/<unknown>/;
	" tools/updaterevision/gitinfo.h.in >src/gitinfo.h
}
