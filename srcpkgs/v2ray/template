# Template file for 'v2ray'
pkgname=v2ray
version=4.39.2
revision=1
wrksrc=${pkgname}-core-${version}
build_style=go
go_import_path="github.com/v2fly/v2ray-core/v4"
go_ldflags="-s -w"
short_desc="Platform for building proxies to bypass network restrictions"
maintainer="ipkalm <ipkalm@outlook.com>"
license="MIT"
homepage="https://github.com/v2fly/v2ray-core"
distfiles="https://github.com/v2fly/v2ray-core/archive/v${version}/${pkgname}-${version}.tar.gz"
checksum=bcb35c0fd3fed604762b4c2a0950718b0118d7f4cb0ca9987d716a6a6e471b2b
conf_files="/etc/v2ray/config.json"

system_accounts="_v2ray"

do_build() {
		export GOFLAGS="-x -p=$XBPS_MAKEJOBS -buildmode=pie -trimpath"
		go build -ldflags "${go_ldflags}" -o "${GOPATH}/bin/v2ray" ./main
		go build -ldflags "${go_ldflags}" -o "${GOPATH}/bin/v2ctl" -tags "confonly" ./infra/control/main
}

do_check() {
		go test -p 1 -tags json -v -timeout 30m ./...
}

post_install() {
		vlicense LICENSE
		vmkdir etc/v2ray
		vcopy release/config/*.json etc/v2ray/
		vsv v2ray
}
