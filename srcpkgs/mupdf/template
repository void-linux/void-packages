# Template file for 'mupdf'
pkgname=mupdf
version=1.26.11
revision=1
hostmakedepends="pkg-config zlib-devel libcurl-devel freetype-devel
 libjpeg-turbo-devel jbig2dec-devel libXext-devel libXcursor-devel
 libXrandr-devel libXinerama-devel harfbuzz-devel readline-devel
 MesaLib-devel libopenjpeg2-devel glu-devel libXi-devel libfreeglut-devel
 gumbo-parser-devel"
makedepends="$hostmakedepends"
depends="desktop-file-utils"
short_desc="Lightweight PDF and XPS viewer"
maintainer="cinerea0 <cinerea0@protonmail.com>"
license="AGPL-3.0-only"
homepage="https://mupdf.com"
changelog="https://mupdf.com/releases/history.html"
distfiles="https://mupdf.com/downloads/archive/mupdf-${version}-source.tar.lz"
checksum=1a6c78ced1f0245b378cb35cc5ab2e199450b991548df049016cffd847bd2bdc

pre_build() {
	if [ "$CROSS_BUILD" ]; then
		make ${makejobs} build=release shared=yes generate
	fi
}

do_build() {
	local _crosscompile

	if [ "$CROSS_BUILD" ]; then
		_crosscompile="CROSSCOMPILE=yes"
	fi

	make ${makejobs} USE_SYSTEM_LIBS=yes CURL_LIBS='-lcurl -lpthread' build=release shared=yes ${_crosscompile} all
}

do_install() {
	make USE_SYSTEM_LIBS=yes build=release shared=yes prefix=${DESTDIR}/usr install-apps install-docs install-extra-apps install-shared-c

	rm build/shared-release/*.so*.in
	mv -t ${DESTDIR}/usr/lib build/shared-release/libmupdf.so*

	ln -rs ${DESTDIR}/usr/bin/mupdf-x11 ${DESTDIR}/usr/bin/mupdf

	vinstall docs/logo/mupdf-icon.xpm 644 usr/share/pixmaps mupdf.xpm
	for px in 16 24 32 48 72 128 256 512; do
		vinstall docs/logo/mupdf-icon-${px}.png 644 /usr/share/icons/hicolor/${px}x${px}/apps mupdf.png
	done
	vinstall docs/logo/mupdf-icon.svg 644 /usr/share/icons/hicolor/scalable/apps mupdf.svg
	vinstall ${FILESDIR}/mupdf.desktop 644 usr/share/applications

	vmkdir usr/lib/pkgconfig
	sed "s/@VERSION@/${version}/" ${FILESDIR}/mupdf.pc.in > ${DESTDIR}/usr/lib/pkgconfig/mupdf.pc
}

post_install() {
	vlicense COPYING LICENSE
}

mupdf-devel_package() {
	short_desc+=" - development files"
	depends="libjpeg-turbo-devel jbig2dec-devel libopenjpeg2-devel"
	pkg_install() {
		vmove usr/lib/pkgconfig
		vmove usr/include
	}
}

mupdf-tools_package() {
	short_desc+=" - tools"
	pkg_install() {
		vmove usr/bin/muraster
		vmove usr/bin/mutool
		vmove usr/share/man/man1/mutool.1
	}
}
