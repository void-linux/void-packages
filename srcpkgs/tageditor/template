# Template file for 'tageditor'
pkgname=tageditor
version=3.3.4
revision=1
build_style=cmake
configure_args="-DBUILD_SHARED_LIBS:BOOL=ON"
makedepends="tagparser-devel cpp-utilities-devel"
short_desc="Tag editor for AAC, ID3, Vorbis, Opus, FLAC and Matroska"
maintainer="Andrew J. Hesford <ajh@sideband.org>"
license="GPL-2.0-only"
homepage="https://github.com/Martchus/tageditor"
distfiles="https://github.com/Martchus/${pkgname}/archive/v${version}.tar.gz"
checksum=0874301bd7644a312d259d54a8b60366c0db80e5b1179c1039cad9905c95463d

build_options="qt webengine webkit script"
build_options_default="qt"

desc_option_webengine="Enable support for qt5-webengine file views (requires qt)"
desc_option_webkit="Enable support for qt5-webkit file views (requires qt)"
desc_option_script="Enable support for qt5-script javascript (requires qt)"

# Prefer qt5-webengine to qt5-webkit, if it can be built
case "$XBPS_TARGET_MACHINE" in
	# qt5-webengine not supported on these architectures
	ppc|ppc-musl|armv5tel*);;
	*) if [ "$XBPS_WORDSIZE" = "$XBPS_TARGET_WORDSIZE" ]; then
		# webengine can be built only if word size matches
		webview_backend="webengine"
	fi;;
esac
build_options_default+=" ${webview_backend:-webkit}"

vopt_conflict webengine webkit

if [ "$build_option_qt" ]; then
	hostmakedepends+=" qt5-host-tools qt5-qmake"
	makedepends+=" qtutilities-devel qt5-tools-devel qt5-declarative-devel"

	if [ "$build_option_webengine" ]; then
		configure_args+=" -DWEBVIEW_PROVIDER=webengine"
		makedepends+=" qt5-location-devel
				qt5-webengine-devel qt5-webchannel-devel"
	elif [ "$build_option_webkit" ]; then
		configure_args+=" -DWEBVIEW_PROVIDER=webkit"
		makedepends+=" qt5-webkit-devel"
	else
		configure_args+=" -DWEBVIEW_PROVIDER=none"
	fi

	if [ "$build_option_script" ]; then
		configure_args+=" -DJS_PROVIDER=script"
		makedepends+=" qt5-script-devel"
	else
		configure_args+=" -DJS_PROVIDER=qml"
	fi
else
	configure_args+=" -DWIDGETS_GUI:BOOL=OFF -DQUICK_GUI:BOOL=OFF"
fi

pre_build() {
	if [ -z "$build_option_qt" ]; then
		vsed -i application/main.cpp -e "/^using namespace QtUtilities;$/s@^@//@"
	fi
}

post_install() {
	if [ -z "$build_option_qt" ]; then
		rm -rf "${DESTDIR}/usr/share/metainfo"
		rm -rf "${DESTDIR}/usr/share/icons"
		rm -rf "${DESTDIR}/usr/share/applications"
	fi
}
