# Template file for 'ROCR-Runtime-hsa-ext'
pkgname=ROCR-Runtime-hsa-ext
version=3.3.0
revision=1
archs="x86_64"
hostmakedepends="tar"
short_desc="Radeon Open Compute HSA runtime extensions"
maintainer="Andrew J. Hesford <ajh@sideband.org>"
license="NCSA"
homepage="https://github.com/RadeonOpenCompute"
_hsa_deb="hsa-ext-rocr-dev_1.1.30300.0-rocm-rel-3.3-19-23fc088b_amd64.deb"
distfiles="https://repo.radeon.com/rocm/apt/debian/pool/main/h/hsa-ext-rocr-dev/$_hsa_deb"
checksum=6b44e286b395d946b865ec1f3cc546356396785ac1fde591d07af02d0aa7c25d
repository=nonfree
restricted=yes

do_extract() {
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_hsa_deb}"
	tar xvf data.tar.gz
}

do_install() {
	_rocm_includes="opt/rocm-${version}/hsa/include"

	vmkdir usr
	vcopy opt/rocm-${version}/hsa/lib usr
	vcopy "$_rocm_includes" usr

	# Extract license from one of the header files
	awk 'BEGIN{HEADER=0} /\/\//{HEADER=1; print $0;} /^[^/]/{if(HEADER==1) exit;}' \
		< "${_rocm_includes}/hsa/amd_hsa_tools_interfaces.h" \
		| sed 's@^///*\( \|$\)@@' > LICENSE
	vlicense LICENSE
}

ROCR-Runtime-hsa-ext-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.so"
	}
}
