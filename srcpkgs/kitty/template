# Template file for 'kitty'
pkgname=kitty
version=0.27.1
revision=1
pycompile_dirs="usr/lib/kitty"
hostmakedepends="go pkg-config python3 wayland-devel wayland-protocols"
makedepends="dbus-devel fontconfig-devel freetype-devel gettext-devel glfw-devel harfbuzz-devel lcms2-devel libXcursor-devel libXi-devel libXinerama-devel libXrandr-devel libcanberra-devel libpng-devel librsync-devel librsync-devel libxcb-devel libxkbcommon-devel openssl-devel ncurses-devel python3-devel python3-setuptools wayland-devel wayland-protocols zlib-devel"
depends="kitty-kitten>=${version}_${revision} kitty-terminfo>=${version}_${revision} kitty-shell-integration>=${version}_${revision} python3-Pygments"
checkdepends="dejavu-fonts-ttf python3-pytest"
short_desc="Modern, hackable, featureful, OpenGL based terminal emulator"
maintainer="Benjamin Slade <slade@jnanam.net>"
license="GPL-3.0-only"
homepage="https://sw.kovidgoyal.net/kitty/"
changelog="https://sw.kovidgoyal.net/kitty/changelog.html"
distfiles="https://github.com/kovidgoyal/kitty/releases/download/v${version}/kitty-${version}.tar.xz"
checksum=e57672c5ba1973be139548eb772ff13d79c29b0ed67cbbe4418c87b6f1b1a901
python_version=3
LDFLAGS+=" -Wl,-z,stack-size=2097152"
nopie_files="/usr/bin/kitten"

# TIOCSWINSZ on ppc overflows signed int, used in ioctl()
# glibc defines it with ulong, musl with int (should be harmless)
case "$XBPS_TARGET_MACHINE" in
ppc*-musl) CFLAGS+=" -Wno-error=overflow" ;;
esac

do_build() {
	if [ "$CROSS_BUILD" ]; then
		CFLAGS+=" -I${XBPS_CROSS_BASE}/${py3_inc}"
	fi
	python3 setup.py linux-package --prefix=${DESTDIR}/usr --update-check-interval=0 --ignore-compiler-warnings --verbose
}

do_check() {
	pytest -v --ignore kitty_tests/file_transmission.py kitty_tests/crypto.py
}

do_install() {
	vsconf $(find ${DESTDIR}/usr/share/doc/kitty/html/_downloads/ -name "kitty.conf")
}

kitty-terminfo_package() {
	short_desc+=" - terminfo data"
	pkg_install() {
		vmove usr/share/terminfo
	}
}

kitty-shell-integration_package() {
	short_desc+=" - shell integration scripts"
	pkg_install() {
		vmove usr/lib/kitty/shell-integration
	}
}

kitty-kitten_package() {
	short_desc+=" - kitten client"
	pkg_install() {
		vmove usr/bin/kitten
	}
}
