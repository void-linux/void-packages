# Template file for 'prosody'
pkgname=prosody
version=0.10.0
revision=2
build_style=configure
conf_files="
 /etc/prosody/prosody.cfg.lua
 /etc/prosody/certs/localhost.cnf
 /etc/prosody/certs/openssl.cnf
 /etc/prosody/certs/Makefile"
system_accounts="prosody"
prosody_homedir="/var/lib/prosody"
make_dirs="/var/lib/prosody 0755 prosody prosody"
makedepends="lua51-devel libressl-devel libidn-devel"
depends="luasocket luafilesystem luaexpat lua51-luasec lua51-BitOp"
short_desc="Lightweight and extensible Jabber/XMPP server written in Lua"
maintainer="Duncaen <duncaen@voidlinux.eu>"
license="MIT"
homepage="https://prosody.im/"
distfiles="https://prosody.im/downloads/source/${pkgname}-${version}.tar.gz"
checksum=7414e447256c60b2645578c4a5913113cd74b419ca5a032b54db90d98a978498
checksum=1a59a322b71928a21985522aa00d0eab3552208d7bf9ecb318542a1b2fee3e8d
broken=https://build.voidlinux.eu/builders/armv6l_builder/builds/6248/steps/shell_3/logs/stdio

case "$XBPS_TARGET_MACHINE" in
	*-musl) ADDCFLAGS="-DWITHOUT_MALLINFO";;
esac

pre_build() {
	cp -f ${FILESDIR}/prosody.cfg.lua prosody.cfg.lua.dist
}

do_configure() {
	./configure --ostype=linux \
		--prefix=/usr \
		--no-example-certs \
		--c-compiler=${CC} \
		--linker=${CC} \
		--with-lua-include=${XBPS_CROSS_BASE}/usr/include/lua5.1 \
		--with-lua=${XBPS_CROSS_BASE}/usr \
		--lua-suffix=5.1 \
		--runwith=lua5.1 \
		--add-cflags="$ADDCFLAGS"
}

post_install() {
	vsv prosody
	vlicense COPYING
}
