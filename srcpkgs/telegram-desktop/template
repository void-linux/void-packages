# Template file for 'telegram-desktop'
pkgname=telegram-desktop
version=6.4.0
revision=2
build_style=cmake
build_helper="qemu gir"
configure_args="-DTDESKTOP_API_ID=209235
 -DTDESKTOP_API_HASH=169ee702e1df4b6e66d80311db36cc43
 -DDESKTOP_APP_DISABLE_CRASH_REPORTS=ON
 -Dtde2e_DIR='/usr/lib/cmake/Td'
 -DWaylandScanner_EXECUTABLE=/usr/bin/wayland-scanner
 -DQT_HOST_PATH=/usr"
hostmakedepends="pkg-config qt6-base python3 extra-cmake-modules
 qt6-declarative-host-tools wayland-devel protobuf glib-devel kf6-kcoreaddons"
makedepends="alsa-lib-devel boost-devel-minimal libboost_regex
 fmt-devel ffmpeg6-devel libglib-devel
 gobject-introspection libdbusmenu-glib-devel libopenal-devel
 minizip-devel opus-devel xxHash-devel pulseaudio-devel range-v3
 qt6-svg-devel libva-devel rapidjson liblz4-devel liblzma-devel
 MesaLib-devel qt6-wayland-devel qt6-qt5compat-devel libtd-devel
 qt6-base-private-devel kf6-kcoreaddons-devel ada-devel
 xcb-util-keysyms-devel hunspell-devel protobuf-devel
 glibmm2.68-devel tg_owt rnnoise-devel jemalloc-devel qt6-declarative-devel
 libdispatch-devel"
depends="qt6-imageformats ttf-opensans"
short_desc="Telegram Desktop messaging app"
maintainer="John <me@johnnynator.dev>"
license="GPL-3.0-or-later, OpenSSL"
homepage="https://desktop.telegram.org/"
changelog="https://github.com/telegramdesktop/tdesktop/blob/v${version}/changelog.txt"
distfiles="https://github.com/telegramdesktop/tdesktop/releases/download/v${version}/tdesktop-${version}-full.tar.gz"
checksum=1503dbdd0e4067a3918f5735c7ba8edeee20bf6e9a3b951d69643f99e8bf29f7

case $XBPS_TARGET_MACHINE in
	armv6*) configure_args+=" -DDESKTOP_APP_DISABLE_SCUDO=true";; # Requires armv6k+ due to yield
	mips*) broken="unsupported";;
esac

if [ "$XBPS_WORDSIZE" -eq 32 ]; then
	nodebug=yes
fi

if [ "$XBPS_TARGET_WORDSIZE" != "$XBPS_WORDSIZE" ]; then
	nocross="https://build.voidlinux.org/#/builders/6/builds/927"
fi

if [ "$XBPS_TARGET_ENDIAN" = "be" ]; then
	broken="UI doesn't go beyond initial screen, also LE specific code in networking"
fi

pre_configure() {
	# Significantly decrease size of debug executable
	CFLAGS="${CFLAGS/ -g/ -g1}"
	CXXFLAGS="${CXXFLAGS/ -g/ -g1}"
}
