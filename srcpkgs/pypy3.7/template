# Template file for 'pypy3.7'
pkgname=pypy3.7
version=7.3.7
revision=1
wrksrc="${pkgname}-v${version}-src"
hostmakedepends="tar perl pkg-config python python-cffi"
makedepends="bzip2-devel gdbm-devel libffi-devel liblzma-devel
 openssl-devel ncurses-devel sqlite-devel tk-devel zlib-devel"
short_desc="JIT-enabled implementation of Python 3.7 written in RPython"
maintainer="dkwo <nicolopiazzalunga@gmail.com>"
license="MIT"
homepage="https://pypy.org"
distfiles="https://downloads.python.org/pypy/${pkgname}-v${version}-src.tar.bz2"
checksum=2ed02ac9e710859c41bc82deafb08619792bb9a27eeaa1676c741ededd214dd7
nocross="Tries to execute cross-compiled code"
python_version=3

do_build() {
	cd pypy/goal
	python ../../rpython/bin/rpython -Ojit --cc=${CC} \
		--make-jobs=$XBPS_MAKEJOBS targetpypystandalone.py
	cd ../../lib_pypy
	../pypy/goal/pypy3-c pypy_tools/build_cffi_imports.py
}

do_install() {
	vdoc README.rst
	vlicense LICENSE
	vmkdir /usr/lib
	vmkdir /usr/bin
	# Upstream recommends installing under /opt and symlinking
	python pypy/tool/release/package.py --archive-name=${pkgname} \
		--targetdir=. --no-keep-debug
	tar -xpf ${pkgname}.tar.bz2 -C ${PKGDESTDIR}/usr/lib
	ln -s /usr/lib/${pkgname}/bin/pypy3 ${PKGDESTDIR}/usr/bin/${pkgname}
}
