# Template file for 'eduke32'
pkgname=eduke32
_src_tag=20241216-10600-d384b22ac
_src_date=${_src_tag%%-*}
_src_rev_and_hash=${_src_tag#*-}
_src_rev=${_src_rev_and_hash%-*}
_src_hash=${_src_rev_and_hash#*-}
#
# The version of value should be dynamically computed but this is rejected by
# the linter so instead we set it manually and later check for equality.
#
#version=${_src_date}.r${_src_rev}
version=20241216.r10600
revision=1
build_style=gnu-makefile
make_build_args="PACKAGE_REPOSITORY=1 VC_REV=${_src_rev} VC_HASH=${_src_hash} duke3d sw"
hostmakedepends="pkg-config nasm $(vopt_if setup_window gdk-pixbuf-devel)"
makedepends="$(vopt_if setup_window gtk+-devel) MesaLib-devel glu-devel libvpx-devel SDL2-devel libflac-devel libvorbis-devel alsa-lib-devel"
short_desc="Advanced Duke Nukem 3D source port"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="GPL-2.0-or-later, custom:BUILD"
homepage="https://www.eduke32.com/"
distfiles="http://dukeworld.com/$pkgname/synthesis/$_src_tag/eduke32_src_${_src_tag}.tar.xz"
checksum=6782abf41e6281b19769164bcf23c11453285b612c4828d676f7d6c1f9fd7be4
repository=nonfree
restricted=yes

build_options="setup_window"
build_options_default=" "
desc_option_setup_window="Enable the startup setup window; requires GTK+2."

if [ "$version" != "${_src_date}.r${_src_rev}" ]; then
	echo "version is not equal to ${_src_date}.r${_src_rev}; please check the package template." 2>&1
	exit 1
fi

case "$XBPS_TARGET_MACHINE" in
	*-musl) makedepends+=" libexecinfo-devel" ;;
esac

post_extract() {
	case "$XBPS_TARGET_MACHINE" in
		*-musl) sed -i 's/LIBS :=/\0 -lexecinfo/' Common.mak ;;
	esac
}

do_install() {
	vmkdir /usr/bin
	vbin eduke32
	vbin mapster32
	vlicense package/common/buildlic.txt
}

voidsw_package() {
	short_desc+="EDuke32-based sourceport of Shadow Warrior"
	pkg_install() {
		vmkdir /usr/bin
		vbin voidsw
		vlicense package/common/buildlic.txt
	}
}
