# Template file for 'gprbuild'
pkgname=gprbuild
version=20180524
revision=1
create_wrksrc=yes
only_for_archs="i686 x86_64 x86_64-musl"
makedepends="gcc-ada libada-devel"
depends="gcc-ada libada-devel"
short_desc="Advanced build system"
maintainer="John Hamilton <hamilton@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://github.com/AdaCore/gprbuild"
distfiles="http://mirrors.cdn.adacore.com/art/5b0819dfc7a447df26c27a68>${pkgname}-gpl-2018-${version}-src.tar.gz
	http://mirrors.cdn.adacore.com/art/5b0819dec7a447df26c27a40>xmlada-gpl-2018-${version}-src.tar.gz"
checksum="a06b7ee6ddc00a927db9b6207a4bd44e670ff2cceb9879a5baa98f4a38f552a1
	aacef3ae91e701690f60bde9c8a4a3f47ba8ca1f8f3c0599d01bce0173be80de"

_bin_progs="gprbuild gprconfig gprclean gprinstall gprname gprls"
_lib_progs="gprlib gprbind"

do_extract() {
	tar -xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${pkgname}-gpl-2018-${version}-src.tar.gz --strip-components=1 -C ${wrksrc}
	tar -xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/xmlada-gpl-2018-${version}-src.tar.gz -C ${wrksrc}
}

do_build() {
	$CC -c $CFLAGS gpr/src/gpr_imports.c

	xmlada=xmlada-gpl-2018-src
	inc_flags="-Isrc -Igpr/src -I${xmlada}/sax -I${xmlada}/dom \
		-I${xmlada}/schema -I${xmlada}/unicode -I${xmlada}/input_sources"

	for bin in $_bin_progs; do
		gnatmake $inc_flags ${bin}-main -o $bin $CFLAGS -j0 -largs gpr_imports.o
	done

	for lib in $_lib_progs; do
		gnatmake $inc_flags $lib $CFLAGS -j0 -largs gpr_imports.o
	done
}

do_install() {
	for bin in $_bin_progs; do
		vbin $bin
	done

	for lib in $_lib_progs; do
		vinstall $lib 755 usr/libexec/gprbuild
	done

	vmkdir usr/share/gpr
	vinstall share/_default.gpr 644 usr/share/gpr

	vmkdir usr/share/gprconfig
	vcopy "share/gprconfig/*.ent" usr/share/gprconfig
	vcopy "share/gprconfig/*.xml" usr/share/gprconfig
}
