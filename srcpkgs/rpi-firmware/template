# Template file for 'rpi-firmware'
pkgname=rpi-firmware
version=20230623
revision=1
_githash="a7f7e2da955ef01b50516ea9722f6126e8d521a8"
_gitshort="${_githash:0:7}"
archs="armv6l* armv7l* aarch64*"
short_desc="Firmware files for the Raspberry Pi (git ${_gitshort})"
maintainer="Piraty <mail@piraty.dev>"
license="BSD-3-Clause, custom:Cypress"
homepage="https://github.com/raspberrypi/firmware"
distfiles="https://github.com/raspberrypi/firmware/archive/${_githash}.tar.gz"
checksum=ead7a45c0013c0f2a56848fcde2532d2fe493533e6c1e5cc954c921893caae43
provides="linux-firmware-broadcom-${version}_${revision}"
replaces="linux-firmware-broadcom>=0"

conf_files="/boot/cmdline.txt /boot/config.txt"
nostrip=yes

_debian_firmware_nonfree_repo=https://raw.githubusercontent.com/RPi-Distro/firmware-nonfree/buster
_bluez_firmware_repo=https://raw.githubusercontent.com/RPi-Distro/bluez-firmware/master

do_install() {
	rm -f boot/*.img
	rm -rf boot/overlays
	rm -f boot/*.dtb
	rm -f boot/COPYING.linux

	vlicense boot/LICENCE.broadcom
	rm -f boot/LICENCE.broadcom

	vmkdir boot
	cp -R boot/* ${DESTDIR}/boot

	# Install configuration files.
	vinstall ${FILESDIR}/cmdline.txt 644 boot
	vinstall ${FILESDIR}/config.txt 644 boot

	$XBPS_FETCH_CMD "${_debian_firmware_nonfree_repo}/LICENCE.cypress"
	vlicense LICENCE.cypress

	_wifi_firmware_with_blob=(
		# For rpi3 b+
		"brcmfmac43455-sdio"
		# For rpi zero 2w
		"brcmfmac43436-sdio"
		# For rpi4/rpi400
		"brcmfmac43456-sdio"
	)

	_wifi_firmware=(
		# For rpi3 b and zero
		"brcmfmac43430-sdio"
		# For rpi zero 2w
		"brcmfmac43436s-sdio"
	)

	for filename in ${_wifi_firmware_with_blob[@]}; do
		for ext in bin txt clm_blob; do
			$XBPS_FETCH_CMD "${_debian_firmware_nonfree_repo}/brcm/${filename}.${ext}"
			vinstall ${filename}.${ext} 0644 usr/lib/firmware/brcm
		done
	done

	for filename in ${_wifi_firmware[@]}; do
		for ext in bin txt; do
			$XBPS_FETCH_CMD "${_debian_firmware_nonfree_repo}/brcm/${filename}.${ext}"
			vinstall ${filename}.${ext} 0644 usr/lib/firmware/brcm
		done
	done

	_bluez_firmware=(
		# For rpi3 b and zero
		"BCM43430A1.hcd"
		# For rpi3 b+
		"BCM4345C0.hcd"
		# For rpi4/rpi400
		"BCM4345C5.hcd"
		"BCM43430B0.hcd"
	)

	for firmware in ${_bluez_firmware[@]}; do
		$XBPS_FETCH_CMD "${_bluez_firmware_repo}/broadcom/${firmware}"
		vinstall $firmware 0644 usr/lib/firmware/brcm
	done
}
