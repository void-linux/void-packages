# Template file for 'python3-awscrt'
pkgname=python3-awscrt
version=0.14.7
revision=1
wrksrc="aws-crt-python-${version}"
build_style=python3-module
hostmakedepends="cmake libunwind-devel pkgconf python3-devel python3-setuptools tar"
depends="libunwind python3"
checkdepends="$depends python3-pytest python3-pytest-cov"
short_desc="Python bindings for the AWS Common Runtime. (Python 3)"
maintainer="Wiktor Ciurej <wiktor.ciurej@gmail.com>"
license="Apache-2.0"
homepage="https://github.com/awslabs/aws-crt-python"
distfiles="https://github.com/awslabs/aws-crt-python/archive/v${version}.tar.gz"
checksum="e608c46542e1076d00a7270657ddeea726893cb02f38f3c544c2f18643e0ca83"

_c_auth_ver=0.6.17
_c_cal_ver=0.5.20
_c_common_ver=0.8.3
_c_compression_ver=0.2.15
_c_event_stream_ver=0.2.15
_c_http_ver=0.6.22
_c_io_ver=0.13.5
_c_mqtt_ver=0.7.12
_c_s3_ver=0.1.49
_c_sdkutils_ver=0.1.3
_checksums_ver=0.1.13
_lc_ver=1.3.0
_s2n_ver=1.3.24
distfiles+="
	https://github.com/awslabs/aws-c-auth/archive/v${_c_auth_ver}.tar.gz>aws-c-auth-${_c_auth_ver}.tar.gz
	https://github.com/awslabs/aws-c-cal/archive/v${_c_cal_ver}.tar.gz>aws-c-cal-${_c_cal_ver}.tar.gz
	https://github.com/awslabs/aws-c-common/archive/v${_c_common_ver}.tar.gz>aws-c-common-${_c_common_ver}.tar.gz
	https://github.com/awslabs/aws-c-compression/archive/v${_c_compression_ver}.tar.gz>aws-c-compression-${_c_compression_ver}.tar.gz
	https://github.com/awslabs/aws-c-event-stream/archive/v${_c_event_stream_ver}.tar.gz>aws-c-event-stream-${_c_event_stream_ver}.tar.gz
	https://github.com/awslabs/aws-c-http/archive/v${_c_http_ver}.tar.gz>aws-c-http-${_c_http_ver}.tar.gz
	https://github.com/awslabs/aws-c-io/archive/v${_c_io_ver}.tar.gz>aws-c-io-${_c_io_ver}.tar.gz
	https://github.com/awslabs/aws-c-mqtt/archive/v${_c_mqtt_ver}.tar.gz>aws-c-mqtt-${_c_mqtt_ver}.tar.gz
	https://github.com/awslabs/aws-c-s3/archive/v${_c_s3_ver}.tar.gz>aws-c-s3-${_c_s3_ver}.tar.gz
	https://github.com/awslabs/aws-c-sdkutils/archive/v${_c_sdkutils_ver}.tar.gz>aws-c-sdkutils-${_c_sdkutils_ver}.tar.gz
	https://github.com/awslabs/aws-checksums/archive/v${_checksums_ver}.tar.gz>aws-checksums-${_checksums_ver}.tar.gz
	https://github.com/awslabs/aws-lc/archive/v${_lc_ver}.tar.gz>aws-lc-${_lc_ver}.tar.gz
	https://github.com/awslabs/s2n/archive/v${_s2n_ver}.tar.gz>s2n-tls-${_s2n_ver}.tar.gz"
checksum+="
	b43678ad3a779c9c7fccf8f931c162eaaf4d5d64d2955ac1fcfd32e538545c0f
	acc352359bd06f8597415c366cf4ec4f00d0b0da92d637039a73323dd55b6cd0
	5af2b7036a0c4ff5ca4e2f3b53ac7c4c3d2c3690890466efa92bf557cb00fe99
	11d58a229e2961b2b36493155a981dea2c8a0bc0d113b0073deb8c3189cfa04e
	4ff2ada07ede3c6afa4b8e6e20de541e717038307f29b38c27efa7c4d875ee26
	a178fd04bd1618469cd21afc5b84cbe436d1f9d9e036fefbd3a8f00356da4d4c
	8f3ff7a01cfedbbea8c00e5f7f6444fd340fac781d115ddf84fbd952639ab22c
	cf80f1b4f37aa8a6b8698315fae32cbf2bd944b67784f07b5762f392f18e64df
	71acbba41a02477a6c352172da561bc2138bf239b936490c773d7aaa83afc9ab
	13d99c0877424a8fad40f312762968012dd54ec60a4438fb601ee65ff8b2484b
	0f897686f1963253c5069a0e495b85c31635ba146cd3ac38cc2ea31eaf54694d
	ae96a3567161552744fc0cae8b4d68ed88b1ec0f3d3c98700070115356da5a37
	df6d2642e7b491f56110527bd73686d94ed3b186ff78d24e525cc0c3dd0d6b4b"
skip_extraction="aws-c-auth-${_c_auth_ver}.tar.gz
	aws-c-cal-${_c_cal_ver}.tar.gz
	aws-c-common-${_c_common_ver}.tar.gz
	aws-c-compression-${_c_compression_ver}.tar.gz
	aws-c-event-stream-${_c_event_stream_ver}.tar.gz
	aws-c-http-${_c_http_ver}.tar.gz
	aws-c-io-${_c_io_ver}.tar.gz
	aws-c-mqtt-${_c_mqtt_ver}.tar.gz
	aws-c-s3-${_c_s3_ver}.tar.gz
	aws-c-sdkutils-${_c_sdkutils_ver}.tar.gz
	aws-checksums-${_checksums_ver}.tar.gz
	aws-lc-${_lc_ver}.tar.gz
	s2n-tls-${_s2n_ver}.tar.gz"

post_extract() {
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-auth-${_c_auth_ver}.tar.gz --strip-components=1 -C crt/aws-c-auth
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-cal-${_c_cal_ver}.tar.gz --strip-components=1 -C crt/aws-c-cal
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-common-${_c_common_ver}.tar.gz --strip-components=1 -C crt/aws-c-common
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-compression-${_c_compression_ver}.tar.gz --strip-components=1 -C crt/aws-c-compression
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-event-stream-${_c_event_stream_ver}.tar.gz --strip-components=1 -C crt/aws-c-event-stream
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-http-${_c_http_ver}.tar.gz --strip-components=1 -C crt/aws-c-http
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-io-${_c_io_ver}.tar.gz --strip-components=1 -C crt/aws-c-io
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-mqtt-${_c_mqtt_ver}.tar.gz --strip-components=1 -C crt/aws-c-mqtt
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-s3-${_c_s3_ver}.tar.gz --strip-components=1 -C crt/aws-c-s3
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-c-sdkutils-${_c_sdkutils_ver}.tar.gz --strip-components=1 -C crt/aws-c-sdkutils
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-checksums-${_checksums_ver}.tar.gz --strip-components=1 -C crt/aws-checksums
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/aws-lc-${_lc_ver}.tar.gz --strip-components=1 -C crt/aws-lc
	tar xzf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/s2n-tls-${_s2n_ver}.tar.gz --strip-components=1 -C crt/s2n
}

do_check() {
	# Ignore failing integration tests
	PYTHONPATH="$(cd build/lib* && pwd)" python3 -m pytest -k 'not (test_delegate_provider_exception)' test/
}

do_build() {
	CMAKE_SYSTEM_PROCESSOR=$XBPS_TARGET_MACHINE PYTHONPATH="$(cd build/lib* && pwd)" python3 setup.py build
}
