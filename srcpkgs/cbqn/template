# Template file for 'cbqn'
pkgname=cbqn
version=0.9.0
revision=1
_bytecode_ver=0bdfb86d438a970b983afbca93011ebd92152b88
_replxx_ver=13f7b60f4f79c2f14f352a76d94860bad0fc7ce9
_singeli_ver=53f42ce4331176d281fa577408ec5a652bdd9127
build_style=gnu-makefile
make_build_args="version=${version} nogit=1 notui=1"
makedepends="libffi-devel"
short_desc="BQN implementation in C"
maintainer="ii8 <murray.calavera@protonmail.com>"
license="MIT AND (Apache-2.0 OR BSL-1.0) AND BSD-3-Clause AND custom:ConvertUTF AND HPND-Markus-Kuhn AND (LGPL-3.0-only OR GPL-3.0-only OR MPL-2.0)"
homepage="https://github.com/dzaima/CBQN"
distfiles="https://github.com/dzaima/CBQN/archive/refs/tags/v${version}.tar.gz
	https://github.com/dzaima/cbqnBytecode/archive/${_bytecode_ver}.tar.gz
	https://github.com/dzaima/replxx/archive/${_replxx_ver}.tar.gz
	https://github.com/mlochbaum/Singeli/archive/${_singeli_ver}.tar.gz"
checksum="5de7d76e70a1a560884b1a4332bc0e306d9b63331827891d0bd2ce8f2498a84e
	6672050b706f962b5b59310b6e67261a53e576fa50e9af5b5a99a7fe64dce992
	f912d0ca2ecdae345ad1e3697bcf66e0f8394f9ad3539edd0f9a581107230d23
	836a9c9f161ba905755ee2f922d58e1bb330e22954e19a74d3f9b626febb0891"
nopie=yes

case $XBPS_TARGET_MACHINE in
	i686*) broken="miscompiles" ;;
esac

if [ "$CROSS_BUILD" ]; then
	make_build_args+=" target_from_cc=1"
fi

skip_extraction="
	${_bytecode_ver}.tar.gz
	${_replxx_ver}.tar.gz
	${_singeli_ver}.tar.gz"

post_extract() {
	vsrcextract -C build/bytecodeLocal ${_bytecode_ver}.tar.gz
	vsrcextract -C build/replxxLocal ${_replxx_ver}.tar.gz
	vsrcextract -C build/singeliLocal ${_singeli_ver}.tar.gz
}

pre_build() {
	if [ "$CROSS_BUILD" ]; then
		make CC="$CC_FOR_BUILD" ${makejobs} ${make_build_args} for-build
	fi
}

post_install() {
	vlicense licenses/LICENSE-MIT-sort
	vlicense build/replxxLocal/LICENSE.md
}
