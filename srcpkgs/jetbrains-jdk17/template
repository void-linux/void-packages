# Template file for 'jetbrains-jdk17'
pkgname=jetbrains-jdk17
version=17.0.5b759.1
revision=1
_gtest_ver=1.8.1
archs="x86_64"
_tag_name="jbr-release-${version}"
_jdk_home="usr/lib/jvm/jbrsdk"
create_wrksrc=yes
build_wrksrc="JetBrainsRuntime-${_tag_name}"
build_style=gnu-configure
configure_args="
 --with-vendor-name=Void
 --with-vendor-url=https://voidlinux.org/
 --with-vendor-bug-url=https://github.com/void-linux/void-packages/issues
 --with-vendor-vm-bug-url=https://github.com/void-linux/void-packages/issues
 --with-version-pre=
 --with-version-opt=${version#*b}-void-r${revision}
 --with-stdc++lib=dynamic
 --with-libjpeg=system
 --with-giflib=system
 --with-libpng=system
 --with-lcms=system
 --with-zlib=system
 --with-jtreg=no
 --with-harfbuzz=system
 --with-jvm-features=zgc
 --enable-unlimited-crypto
 --disable-warnings-as-errors
 --with-native-debug-symbols=internal
 --with-debug-level=release
 --with-jobs=${XBPS_ORIG_MAKEJOBS}
 --with-gtest=../googletest-release-${_gtest_ver}
"
make_build_args="images"
make_install_args="INSTALL_PREFIX=\"${DESTDIR}/usr/lib\""
make_check_target="test-hotspot-gtest"
hostmakedepends="pkg-config zip unzip autoconf automake libtool which make-ca"
makedepends="alsa-lib-devel cups-devel libX11-devel libjpeg-turbo-devel harfbuzz-devel giflib-devel freetype-devel libXtst-devel libXt-devel libXrender-devel alsa-lib-devel fontconfig-devel libXrandr-devel libXi-devel zlib-devel lcms2-devel"
short_desc="JetBrains Java 17 JDK"
maintainer="Anton Afanasyev <anton@doubleasoftware.com>"
license="GPL-2.0-only, Classpath-exception-2.0"
homepage="https://github.com/JetBrains/JetBrainsRuntime"
distfiles="https://github.com/JetBrains/JetBrainsRuntime/archive/refs/tags/${_tag_name}.tar.gz
 https://github.com/google/googletest/archive/refs/tags/release-${_gtest_ver}.tar.gz"
checksum="25766e1f8bccd6e6b4b863a98b78309f3847434eff24461adc97da0b35a61dbb
 9bf1fe5182a604b4135edc1a425ae356c9ad15e9b23f9f12a02e80184c3a249c"
patch_args="-Np1 -d ${build_wrksrc}"
conflicts="jetbrains-jdk-bin"

# For whatever reason, XBPS finds libjava, libjli, etc as dependencies of this package, and decides to make it depend on openjdk8, which provides those.
# But that is not true, nor desired -- this is a full fledged JDK distribution, just not installed as such here in XBPS land.
noverifyrdeps=yes

# Build and check are still parallel, but don't use -jN.
disable_parallel_build=yes
disable_parallel_check=yes

makedepends+=" openjdk17"
configure_args+=" --with-boot-jdk=/usr/lib/jvm/openjdk17"
configure_args+=" --with-boot-jdk-jvmargs=-Xlog:disable"

do_configure() {
	CFLAGS=${CFLAGS/-D_FORTIFY_SOURCE=2/}
	CXXFLAGS=${CXXFLAGS/-D_FORTIFY_SOURCE=2/}

	configure_args=${configure_args/--with-libtool-sysroot=$XBPS_CROSS_BASE}
	if [ "$XBPS_CCACHE" ] && [ -z "$CROSS_BUILD" ]; then
		configure_args+=" --enable-ccache"
		CC="/usr/bin/cc"
		CXX="/usr/bin/c++"
	fi

	sh ./configure ${configure_args} \
		--with-extra-cflags="$CFLAGS" \
		--with-extra-cxxflags="$CXXFLAGS" \
		--with-extra-ldflags="$LDFLAGS" \
		READELF=$READELF AR=$AR STRIP=$STRIP NM=$NM \
		OBJDUMP=$OBJDUMP OBJCOPY=$OBJCOPY
}

# TODO: openjdk17 had the following hook in it. Debug it for understanding.
#post_install() {
#	vmkdir $_jdk_home/lib/security
#	make-ca -g -f --destdir "${PWD}/ca" -k "${DESTDIR}/$_jdk_home/bin/keytool"
#	mv ./ca/etc/pki/tls/java/cacerts ${DESTDIR}/$_jdk_home/lib/security/
#	chmod -R ugo+rw ./ca
#	rm -rf ./ca
#}

do_install() {
	TARGET_PATH="${_jdk_home}"

	vmkdir ${TARGET_PATH}

	vlicense ASSEMBLY_EXCEPTION
	vlicense LICENSE

	cd build/linux-*-server-release/images/jdk/
	vcopy bin ${TARGET_PATH}
	vcopy conf ${TARGET_PATH}
	vcopy include ${TARGET_PATH}
	vcopy legal ${TARGET_PATH}
	vcopy lib ${TARGET_PATH}
	vcopy release ${TARGET_PATH}

	vmkdir etc/profile.d
	cat > ${DESTDIR}/etc/profile.d/10_jbrsdk.sh <<EOF
export IDEA_JDK=\${IDEA_JDK=/${_jdk_home}}
EOF
}
