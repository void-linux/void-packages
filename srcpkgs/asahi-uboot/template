# Template file for 'asahi-uboot'
pkgname=asahi-uboot
_commit=89dbe1bf776ac909319247bd66f73c5d2cdac838
version=2022.04.rc4.20220319
revision=1
archs="aarch64*"
wrksrc="u-boot-${_commit}"
hostmakedepends="flex bc dtc openssl-devel" # until uboot supports skipping tools build...
short_desc="U-Boot for Apple Silicon Macs"
maintainer="Will Springer <skirmisher@protonmail.com>"
license="GPL-2.0-or-later, MIT"
homepage="http://asahilinux.org"
distfiles="https://github.com/AsahiLinux/u-boot/archive/${_commit}.tar.gz"
checksum="d6b90132e7ededc6529f2516475218f76596900ace3082fcd027a0f01065553f"

do_configure() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
	make ${makejobs} apple_m1_defconfig
}

do_build() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
	if [ "$CROSS_BUILD" ]; then
	        export CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-
	fi
	make ${makejobs} EXTRAVERSION=-${revision}
}

do_install() {
	vinstall u-boot-nodtb.bin 0644 usr/lib/asahi-boot
	for dtb in arch/arm/dts/t[86]*.dtb ; do
		vinstall ${dtb} 0644 usr/lib/asahi-boot/dtb
	done

	vlicense Licenses/Exceptions
	vlicense Licenses/OFL.txt
	vlicense Licenses/README
	vlicense Licenses/bsd-2-clause.txt
	vlicense Licenses/bsd-3-clause.txt
	vlicense Licenses/eCos-2.0.txt
	vlicense Licenses/gpl-2.0.txt
	vlicense Licenses/ibm-pibs.txt
	vlicense Licenses/isc.txt
	vlicense Licenses/lgpl-2.0.txt
	vlicense Licenses/lgpl-2.1.txt
	vlicense Licenses/r8a779x_usb3.txt
	vlicense Licenses/x11.txt
}
