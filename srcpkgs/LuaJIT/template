# Template file for 'LuaJIT'
pkgname=LuaJIT
# set last number to contents of .relver at repo root
version=2.1.1707061634
revision=1
_commit_hash=0d313b243194a0b8d2399d8b549ca5a0ff234db5
build_style=gnu-makefile
make_build_target=amalg
hostmakedepends="lua52-BitOp"
short_desc="Just-In-Time Compiler for Lua"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT"
homepage="http://www.luajit.org"
distfiles="https://repo.or.cz/luajit-2.0.git/snapshot/${_commit_hash}.tar.gz"
checksum=4b29f310d9e982f8bfa18f0dcd4d979a23666943e690714bef0750d56b2cd64b

build_options="lua52compat"
desc_option_lua52compat="higher compatibility with lua 5.2"

_host_cc="cc"
if [ -n "$CROSS_BUILD" ]; then
	if [ "$XBPS_WORDSIZE" != "$XBPS_TARGET_WORDSIZE" ]; then
		if [ "${XBPS_MACHINE%%-*}" = "x86_64" ]; then
			hostmakedepends+=" cross-i686-linux-musl"
			_host_cc="i686-linux-musl-gcc -static"
		else
			broken="Host and target wordsize must match when not on x86_64"
		fi
	fi

	make_build_args+=" CROSS=${XBPS_CROSS_TRIPLET}-"
fi

pre_build() {
	if [ "$build_option_lua52compat" ]; then
		make_build_args+=" XCFLAGS=-DLUAJIT_ENABLE_LUA52COMPAT"
	fi
}

do_build() {
	# if we don't unset, the build fails to cross-compile
	# due to confliction with the makefile macros
	local _cflags=$CFLAGS
	local _ldflags=$LDFLAGS
	unset CFLAGS LDFLAGS

	make ${makejobs} PREFIX=/usr HOST_LUA=lua5.2 \
		HOST_CFLAGS="$XBPS_CFLAGS" HOST_LDFLAGS="$XBPS_LDFLAGS" \
		TARGET_CFLAGS="${_cflags}" TARGET_LDFLAGS="${_ldflags}" \
		HOST_CC="${_host_cc}" ${make_build_args}
}

post_install() {
	vlicense COPYRIGHT
}

LuaJIT-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
	}
}
