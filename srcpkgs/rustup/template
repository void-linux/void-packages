# Template file for 'rustup'
pkgname=rustup
version=1.26.0
revision=2
# rustup doesn't recognize this target
archs="~armv*-musl"
build_style=cargo
build_helper=qemu
configure_args="--bin rustup-init --no-default-features
 --features curl-backend,reqwest-backend,reqwest-default-tls,no-self-update"
hostmakedepends="pkg-config"
makedepends="openssl-devel zlib-devel libcurl-devel"
short_desc="Rust toolchain installer"
maintainer="Jan Christian Gr√ºnhage <jan.christian@gruenhage.xyz>"
license="Apache-2.0, MIT"
homepage="https://www.rustup.rs"
changelog="https://github.com/rust-lang/rustup/raw/master/CHANGELOG.md"
distfiles="https://github.com/rust-lang/rustup/archive/refs/tags/${version}.tar.gz"
checksum=6f20ff98f2f1dbde6886f8d133fe0d7aed24bc76c670ea1fca18eb33baadd808

case "$XBPS_TARGET_MACHINE" in
	x86_64*|i686*|arm*|aarch64*)
		configure_args+=" --features reqwest-rustls-tls"
		;;
esac

post_build() {
	RUSTUP="target/${RUST_TARGET}/release/rustup-init"
	ln -sf "$RUSTUP" rustup

	# generate shell completions
	vtargetrun ./rustup completions zsh >rustup.zsh
	vtargetrun ./rustup completions bash >rustup.bash
	vtargetrun ./rustup completions fish >rustup.fish
}

do_install() {
	vbin target/${RUST_TARGET}/release/rustup-init

	vcompletion rustup.bash bash
	vcompletion rustup.fish fish
	vcompletion rustup.zsh zsh

	vdoc README.md
	vlicense LICENSE-APACHE
	vlicense LICENSE-MIT
}
