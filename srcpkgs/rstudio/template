# Template file for 'rstudio'
pkgname=rstudio
version=2022.07.1+554
revision=1
wrksrc="${pkgname}-${version%+*}-${version#*+}"
build_style=cmake
configure_args="-DRSTUDIO_TARGET=Electron
 -DRSTUDIO_PACKAGE_BUILD=1
 -DRSTUDIO_USE_SYSTEM_BOOST=ON
 -DRSTUDIO_USE_SYSTEM_SOCI=TRUE
 -DRSTUDIO_USE_SYSTEM_YAML_CPP=TRUE
 -DRSTUDIO_BOOST_SIGNALS_VERSION=2
 -DCMAKE_INSTALL_PREFIX=/usr/lib/rstudio"
make_cmd=make
make_install_target=install/fast
hostmakedepends="unzip pandoc openjdk apache-ant R
 qt5-host-tools which nodejs-lts yarn git"
makedepends="zlib-devel libuuid-devel openssl-devel pam-devel R mathjax
 boost-devel pango-devel hunspell-devel qt5-devel qt5-webkit-devel
 qt5-declarative-devel qt5-location-devel qt5-sensors-devel qt5-svg-devel
 qt5-xmlpatterns-devel qt5-webchannel-devel qt5-webengine-devel sqlite-devel
 qt5-plugin-pgsql qt5-plugin-mysql qt5-plugin-sqlite qt5-plugin-tds qt5-plugin-odbc
 soci-devel yaml-cpp-devel"
depends="R mathjax"
short_desc="Integrated development environment (IDE) for R"
maintainer="John <me@johnnynator.dev>"
license="AGPL-3.0-only"
homepage="https://www.rstudio.com"
distfiles="https://github.com/rstudio/rstudio/archive/v${version}.tar.gz
 https://s3.amazonaws.com/rstudio-dictionaries/core-dictionaries.zip"
checksum="1c3fd3fc64e3553ec1ec35758d177a3d4713ae5203493291d7b3b622478f4185
 4341a9630efb9dcf7f215c324136407f3b3d6003e1c96f2e5e1f9f14d5787494"
skip_extraction="core-dictionaries.zip"

LDFLAGS="-Wl,-z,stack-size=2097152"


export CMAKE_GENERATOR="Unix Makefiles"

post_extract() {
	_srcdir="${XBPS_SRCDISTDIR}/${pkgname}-${version}"

	unzip -qd ${wrksrc}/dependencies/dictionaries ${_srcdir}/core-dictionaries.zip
}

pre_configure() {
	export RSTUDIO_TOOLS_ROOT=${wrksrc}/dependencies

	ln -s /usr/share/mathjax dependencies/common/mathjax-27

	_pandoc_ver="2.18"
	mkdir -p dependencies/common/pandoc/$_pandoc_ver/bin
	ln -s /usr/bin/pandoc dependencies/common/pandoc/$_pandoc_ver/bin

	_node_ver="16.14.0"
	mkdir -p dependencies/common/node/$_node_ver/bin
	ln -s /usr/bin/node dependencies/common/node/$_node_ver/bin/node
	ln -s /usr/bin/npm dependencies/common/node/$_node_ver/bin/npm
	ln -s /usr/bin/npx dependencies/common/node/$_node_ver/bin/npx


	_maj_min=${version%*.*}
	_patch_suffix=${version#*.*.}
	export RSTUDIO_VERSION_MAJOR=${_maj_min%.*}
	export RSTUDIO_VERSION_MINOR=${_maj_min#*.}
	export RSTUDIO_VERSION_PATCH=${_patch_suffix%+*}
	export RSTUDIO_VERSION_SUFFIX=${_patch_suffix#*[0-9]}
	export PACKAGE_OS=VoidLinux
	export GIT_COMMIT=7872775ebddc40635780ca1ed238934c3345c5de


	cd src/gwt
	ant draft
}

post_install() {
	mkdir -p ${DESTDIR}/usr/bin

	ln -sf /usr/lib/rstudio/rstudio ${DESTDIR}/usr/bin/
	for f in {diagnostics,rpostback,rsession}; do
		ln -sf /usr/lib/rstudio/resources/app/bin/${f} ${DESTDIR}/usr/bin/
	done
	vlicense COPYING
}
