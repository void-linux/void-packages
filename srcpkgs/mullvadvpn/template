# Template file for 'mullvadvpn'
pkgname=mullvadvpn
version=2025.10
revision=1
_wggover=0.0.20230223-mullvad-0.1.6
# archs set by upstream (likely due to how they invoke go)
archs="x86_64* aarch64*"
build_style=cargo
build_helper=qemu
make_build_args="
 -p mullvad-daemon --bin mullvad-daemon
 -p mullvad-cli --bin mullvad
 -p mullvad-setup --bin mullvad-setup
 -p mullvad-problem-report --bin mullvad-problem-report
 -p talpid-openvpn-plugin --lib
 -p mullvad-exclude --bin mullvad-exclude
 -p mullvad-api --bin relay_list"
hostmakedepends="pkg-config go git protobuf protobuf-devel"
makedepends="dbus-devel libnftnl-devel"
short_desc="Mullvad VPN client app (cli only)"
maintainer="dkwo <npiazza@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://mullvad.net/"
changelog="https://raw.githubusercontent.com/mullvad/mullvadvpn-app/refs/heads/main/CHANGELOG.md"
distfiles="https://github.com/mullvad/mullvadvpn-app/archive/refs/tags/${version}.tar.gz
 https://github.com/mullvad/wireguard-go/archive/refs/tags/${_wggover}.tar.gz"
checksum="c797b177d0a87cdc488f360d921f51b12e71cbe56cdc60f2390dba25da830efc
 fd9fa45155098223a17ea934eaa6eb44ee990cd2a7ab638bce482f62fd8502e8"
skip_extraction="${_wggover}.tar.gz"
system_groups="_mullvad"

post_extract() {
	vsrcextract -C wireguard-go-rs/libwg/wireguard-go "${_wggover}.tar.gz"
}

post_build() {
	vtargetrun target/${RUST_TARGET}/release/relay_list > dist-assets/relays.json
}

do_install() {
	for _bin in mullvad-daemon mullvad mullvad-problem-report mullvad-setup mullvad-exclude; do
		vbin target/${RUST_TARGET}/release/${_bin}
	done

	vinstall target/${RUST_TARGET}/release/libtalpid_openvpn_plugin.so 644 usr/lib
	vinstall dist-assets/relays.json 644 usr/share/mullvad

	compdir=$(mktemp -d)
	for _shell in bash zsh fish; do
		vtargetrun ${DESTDIR}/usr/bin/mullvad shell-completions ${_shell} ${compdir}
	done

	vcompletion ${compdir}/mullvad.bash bash mullvad
	vcompletion ${compdir}/_mullvad zsh mullvad
	vcompletion ${compdir}/mullvad.fish fish mullvad

	vsv mullvad
}
