#!/bin/sh
set -e

m1n1_dir="/boot/efi/m1n1"
src=/usr/lib/asahi-boot

target="$m1n1_dir/boot.bin"
if [ -n "$1" ]; then
	target="$1"
fi

if [ ! -e "$m1n1_dir" ]; then
	echo "$m1n1_dir does not exist, is /boot/efi mounted?" 1>&2
	exit 1
fi

DTBS="/boot/dtbs/dtbs-*/apple/*"

cat "$src/m1n1.bin" $DTBS > "${target}.new"
gzip -c "$src/u-boot-nodtb.bin" >> "${target}.new"
[ -f /etc/m1n1.conf ] && cat /etc/m1n1.conf >> "${target}.new"
mv -f "${target}.new" "$target"

echo "m1n1 updated at ${target}"
