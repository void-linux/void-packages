# Template file for 'xpaint'
pkgname=xpaint
version=3.1.4
revision=1
build_style=gnu-configure
build_helper=qemu
hostmakedepends="autoconf automake pkg-config"
makedepends="libtool libXaw3dXft-devel freetype-devel libjpeg-turbo-devel tiff-devel libnetpbm-devel"
depends="desktop-file-utils hicolor-icon-theme"
short_desc="Simple paint program for X"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="GPL-3.0-or-later"
homepage="https://sourceforge.net/projects/sf-xpaint/"
distfiles="${SOURCEFORGE_SITE}/project/sf-xpaint/sf-xpaint/${pkgname}-${version}/${pkgname}-${version}.tar.bz2"
checksum=6edacc9b011e6ce356c3d989156fc62460e3bfd958856c8f133c5f3589d67851
disable_parallel_build=yes

pre_configure() {
	# For some reason a lot of files use xaw_incdir instead of X11/Xaw3dxft...

	find -iname "*.c" -exec sed -i 's|#include "xaw_incdir/\(.*\)"|#include <X11/Xaw3dxft/\1>|' {} \;

	# This package is horrible for cross builds:
	#
	# * Some paths are predefined and need to be patched
	# * /usr/bin/libtool is used although there is a libtool script in xpaintrw
	#
	# * Some programs are build with CC although they are only required for
	#   building. Although they could run with qemu, there are issues for
	#   armv7.
	#
	# * Installed programs are compiled with gcc vs CC.

	if [ "$CROSS_BUILD" ]; then
		vsed -i configure.ac -e "s|/usr/include/freetype2/freetype/|${XBPS_CROSS_BASE}&|"
		vsed -i Makefile.am -e 's|^\t\$(CC) \$(CFLAGS) substads.c \(.*\)|\tgcc substads.c \1|'
		vsed -i Makefile.am -e 's|^\t\$(CC) \$(CFLAGS) preproc.c \(.*\)|\tgcc preproc.c \1|'
		vsed -i xpaintrw/Makefile.am -e "s|LIBTOOL = /usr/bin/libtool|LIBTOOL = ./libtool|"
		vsed -i vxp2ps/Makefile -e "s|^\tgcc|\t${CC}|"
	fi

	autoreconf -fi
}

post_configure() {
	# Here we need to patch the libtool script for cross builds...

	if [ "$CROSS_BUILD" ]; then
		vsed -i xpaintrw/libtool -e "s|^CC=.*|CC=\"${CC}\"|"
		vsed -i xpaintrw/libtool -e "s|^LD=.*|LD=\"${LD}\"|"
		vsed -i xpaintrw/libtool -e "s|^LTCC=.*|LTCC=\"${CC}\"|"

		vsed -i xpaintrw/Makefile -e 's|--mode=compile|--tag=CC &|'
		vsed -i xpaintrw/Makefile -e 's|--mode=link|--tag=CC &|'
	fi
}
