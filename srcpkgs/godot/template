# Template file for 'godot'
pkgname=godot
version=3.4
revision=2
archs="x86_64* i686* aarch64* armv7* ppc64*"
wrksrc="${pkgname}-${version}-stable"
build_style=scons
# Godot contains private copies of libraries
# that already have been packaged elsewhere.
make_build_args="dev=no progress=no pulseaudio=no use_lto=yes
 builtin_bullet=false builtin_libpng=false builtin_libvpx=false
 builtin_libwebp=false builtin_libogg=false builtin_libtheora=false
 builtin_opus=false builtin_libvorbis=false builtin_enet=false
 builtin_zlib=false builtin_freetype=false builtin_mbedtls=false
 builtin_miniupnpc=false builtin_pcre2=false"
hostmakedepends="pkg-config"
makedepends="
 alsa-lib-devel freetype-devel glu-devel libXcursor-devel libXi-devel
 libXinerama-devel libXrender-devel libXrandr-devel libX11-devel
 bullet-devel libpng-devel libvpx-devel libwebp-devel libogg-devel libtheora-devel
 opus-devel opusfile-devel libvorbis-devel libenet-devel zlib-devel mbedtls-devel
 miniupnpc-devel pcre2-devel"
short_desc="Multiplatform 2D and 3D engine"
maintainer="Nick Hahn <nick.hahn@hotmail.de>"
license="MIT"
homepage="https://www.godotengine.org/"
distfiles="https://github.com/godotengine/${pkgname}/archive/${version}-stable.tar.gz"
checksum=61749d12cb094c0be2a2c451ae2aceb8bb45f59f67fcd13fcd8f0c9114262d88
nocross=https://build.voidlinux.org/builders/armv7l_builder/builds/6342/steps/shell_3/logs/stdio

CFLAGS+=" -fPIE -fPIC"
LDFLAGS+=" -pie"

post_extract() {
	vsed -e 's/#ifdef CRASH_HANDLER_ENABLED/#if defined(CRASH_HANDLER_ENABLED) \&\& defined(__GLIBC__)/' \
		-i platform/x11/crash_handler_x11.cpp
}

pre_build() {
	export CXXFLAGS=" $CXXFLAGS "
}

do_build() {
	_options="\
		yes release_debug x11    # editor
		yes release_debug server # headless
		no  release       x11    # client
		no  release_debug x11    # client with runtime checks
		no  release       server # server
		no  release_debug server # server with runtime checks"

	echo "$_options" | while read tools target platform _; do
		scons \
			${makejobs} ${make_build_args} \
			CCFLAGS="$CFLAGS" LINKFLAGS="$LDFLAGS" \
			tools=$tools target=$target platform=$platform
	done
}

do_install() {
	vlicense LICENSE.txt
	vinstall ${FILESDIR}/godot.desktop 644 /usr/share/applications/
	vinstall ${wrksrc}/icon.png 644 /usr/share/pixmaps/ godot.png

	case "$XBPS_TARGET_MACHINE" in
		x86_64*|aarch64*) _godot_arch=64;;
		ppc64le*) _godot_arch=ppc64le;;
		ppc64*) _godot_arch=ppc64;;
		*) _godot_arch=32;;
	esac

	# editors, use headless for packaging games
	vbin bin/godot.x11.opt.tools.$_godot_arch godot
	vbin bin/godot_server.x11.opt.tools.$_godot_arch godot-headless

	# export templates, use for packaging games and playing with musl libc or non-x86 CPU
	vbin bin/godot.x11.opt.$_godot_arch godot-client
	vbin bin/godot.x11.opt.debug.$_godot_arch godot-client-debug
	vbin bin/godot_server.x11.opt.$_godot_arch godot-server
	vbin bin/godot_server.x11.opt.debug.$_godot_arch godot-server-debug
}
