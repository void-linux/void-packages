From e68feab7db036838d9521ba3b9f00717c37c024c Mon Sep 17 00:00:00 2001
From: JayYang <jay.yang@intel.com>
Date: Tue, 21 Mar 2023 17:17:55 +0800
Subject: [PATCH] [Media Common] Enable MMC in free kernel build

Add mmc build definition in free kernel build
---
 media_driver/agnostic/gen9/codec/hal/media_srcs.cmake          | 2 +-
 media_driver/cmake/linux/media_feature_flags_linux.cmake       | 3 +--
 .../media_interfaces_m9_bxt/media_interfaces_g9_bxt.cpp        | 2 +-
 .../media_interfaces_m9_cfl/media_interfaces_g9_cfl.cpp        | 2 +-
 .../media_interfaces_m9_glk/media_interfaces_g9_glk.cpp        | 2 +-
 .../media_interfaces_m9_kbl/media_interfaces_g9_kbl.cpp        | 2 +-
 .../media_interfaces_m9_skl/media_interfaces_g9_skl.cpp        | 2 +-
 7 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/media_driver/agnostic/gen9/codec/hal/media_srcs.cmake b/media_driver/agnostic/gen9/codec/hal/media_srcs.cmake
index 8bb36bafe..78902a22d 100644
--- a/media_driver/agnostic/gen9/codec/hal/media_srcs.cmake
+++ b/media_driver/agnostic/gen9/codec/hal/media_srcs.cmake
@@ -27,7 +27,7 @@ set(TMP_1_HEADERS_
     ${CMAKE_CURRENT_LIST_DIR}/codechal_hw_g9_X.h
 )
 
-if(${MMC_Supported} STREQUAL "yes")
+if(${MMC_Supported} STREQUAL "yes" AND ENABLE_NONFREE_KERNELS AND ENABLE_KERNELS)
     set(TMP_1_SOURCES_
         ${TMP_1_SOURCES_}
         ${CMAKE_CURRENT_LIST_DIR}/codechal_memdecomp_g9.cpp
diff --git a/media_driver/cmake/linux/media_feature_flags_linux.cmake b/media_driver/cmake/linux/media_feature_flags_linux.cmake
index de0ca853f..8121ea60c 100644
--- a/media_driver/cmake/linux/media_feature_flags_linux.cmake
+++ b/media_driver/cmake/linux/media_feature_flags_linux.cmake
@@ -35,7 +35,6 @@ if(NOT ENABLE_KERNELS OR NOT ENABLE_NONFREE_KERNELS)
     bs_set_if_undefined(HEVC_Encode_VME_Supported "no")
     bs_set_if_undefined(MPEG2_Encode_VME_Supported "no")
     bs_set_if_undefined(CMRT_HEVC_ENC_FEI_Supported "no")
-    bs_set_if_undefined(MMC_Supported "no")
     bs_set_if_undefined(VC1_Decode_Supported "no")
     bs_set_if_undefined(Decode_Processing_Supported "no")
     bs_set_if_undefined(Kernel_Auto_Denoise_Supported "no")
@@ -46,7 +45,6 @@ else()
     bs_set_if_undefined(HEVC_Encode_VME_Supported "${Encode_VME_Supported}")
     bs_set_if_undefined(MPEG2_Encode_VME_Supported "${Encode_VME_Supported}")
     bs_set_if_undefined(CMRT_HEVC_ENC_FEI_Supported "yes")
-    bs_set_if_undefined(MMC_Supported "yes")
     bs_set_if_undefined(VC1_Decode_Supported "yes")
     bs_set_if_undefined(Decode_Processing_Supported "yes")
     bs_set_if_undefined(Kernel_Auto_Denoise_Supported "yes")
@@ -64,6 +62,7 @@ bs_set_if_undefined(VP9_Decode_Supported "yes")
 bs_set_if_undefined(VP_SFC_Supported "yes")
 bs_set_if_undefined(Common_Encode_Supported "yes")
 bs_set_if_undefined(Media_Scalability_Supported "yes")
+bs_set_if_undefined(MMC_Supported "yes")
 
 # features controlled by global flag Encode_VDEnc_Supported
 bs_set_if_undefined(AVC_Encode_VDEnc_Supported "${Encode_VDEnc_Supported}")
diff --git a/media_driver/media_interface/media_interfaces_m9_bxt/media_interfaces_g9_bxt.cpp b/media_driver/media_interface/media_interfaces_m9_bxt/media_interfaces_g9_bxt.cpp
index 3f306ee2a..8e4c0f532 100644
--- a/media_driver/media_interface/media_interfaces_m9_bxt/media_interfaces_g9_bxt.cpp
+++ b/media_driver/media_interface/media_interfaces_m9_bxt/media_interfaces_g9_bxt.cpp
@@ -135,7 +135,7 @@ MOS_STATUS MhwInterfacesG9Bxt::Initialize(
 
     return MOS_STATUS_SUCCESS;
 }
-#ifdef _MMC_SUPPORTED
+#if defined(_MMC_SUPPORTED) && defined(ENABLE_KERNELS) && !defined(_FULL_OPEN_SOURCE)
 static bool bxtRegisteredMmd =
     MediaFactory<uint32_t, MmdDevice>::
     Register<MmdDeviceG9Bxt>((uint32_t)IGFX_BROXTON);
diff --git a/media_driver/media_interface/media_interfaces_m9_cfl/media_interfaces_g9_cfl.cpp b/media_driver/media_interface/media_interfaces_m9_cfl/media_interfaces_g9_cfl.cpp
index b8fa1eec0..84e0fad1d 100644
--- a/media_driver/media_interface/media_interfaces_m9_cfl/media_interfaces_g9_cfl.cpp
+++ b/media_driver/media_interface/media_interfaces_m9_cfl/media_interfaces_g9_cfl.cpp
@@ -44,7 +44,7 @@ static bool cflRegisteredMhw =
     MediaFactory<uint32_t, MhwInterfaces>::
     Register<MhwInterfacesG9Kbl>((uint32_t)IGFX_COFFEELAKE);
 
-#ifdef _MMC_SUPPORTED
+#if defined(_MMC_SUPPORTED) && defined(ENABLE_KERNELS) && !defined(_FULL_OPEN_SOURCE)
 static bool cflRegisteredMmd =
     MediaFactory<uint32_t, MmdDevice>::
     Register<MmdDeviceG9Kbl>((uint32_t)IGFX_COFFEELAKE);
diff --git a/media_driver/media_interface/media_interfaces_m9_glk/media_interfaces_g9_glk.cpp b/media_driver/media_interface/media_interfaces_m9_glk/media_interfaces_g9_glk.cpp
index de81e6091..2638cb3a6 100644
--- a/media_driver/media_interface/media_interfaces_m9_glk/media_interfaces_g9_glk.cpp
+++ b/media_driver/media_interface/media_interfaces_m9_glk/media_interfaces_g9_glk.cpp
@@ -65,7 +65,7 @@ static bool glkRegisteredMhw =
     MediaFactory<uint32_t, MhwInterfaces>::
     Register<MhwInterfacesG9Kbl>((uint32_t)IGFX_GEMINILAKE);
 
-#ifdef _MMC_SUPPORTED
+#if defined(_MMC_SUPPORTED) && defined(ENABLE_KERNELS) && !defined(_FULL_OPEN_SOURCE)
 static bool glkRegisteredMmd =
     MediaFactory<uint32_t, MmdDevice>::
     Register<MmdDeviceG9Kbl>((uint32_t)IGFX_GEMINILAKE);
diff --git a/media_driver/media_interface/media_interfaces_m9_kbl/media_interfaces_g9_kbl.cpp b/media_driver/media_interface/media_interfaces_m9_kbl/media_interfaces_g9_kbl.cpp
index 99d786185..4e9c6e7f1 100644
--- a/media_driver/media_interface/media_interfaces_m9_kbl/media_interfaces_g9_kbl.cpp
+++ b/media_driver/media_interface/media_interfaces_m9_kbl/media_interfaces_g9_kbl.cpp
@@ -131,7 +131,7 @@ MOS_STATUS MhwInterfacesG9Kbl::Initialize(
 
     return MOS_STATUS_SUCCESS;
 }
-#ifdef _MMC_SUPPORTED
+#if defined(_MMC_SUPPORTED) && defined(ENABLE_KERNELS) && !defined(_FULL_OPEN_SOURCE)
 static bool kblRegisteredMmd =
     MediaFactory<uint32_t, MmdDevice>::
     Register<MmdDeviceG9Kbl>((uint32_t)IGFX_KABYLAKE);
diff --git a/media_driver/media_interface/media_interfaces_m9_skl/media_interfaces_g9_skl.cpp b/media_driver/media_interface/media_interfaces_m9_skl/media_interfaces_g9_skl.cpp
index e2520edf7..4b0012c64 100644
--- a/media_driver/media_interface/media_interfaces_m9_skl/media_interfaces_g9_skl.cpp
+++ b/media_driver/media_interface/media_interfaces_m9_skl/media_interfaces_g9_skl.cpp
@@ -139,7 +139,7 @@ MOS_STATUS MhwInterfacesG9Skl::Initialize(
 
     return MOS_STATUS_SUCCESS;
 }
-#ifdef _MMC_SUPPORTED
+#if defined(_MMC_SUPPORTED) && defined(ENABLE_KERNELS) && !defined(_FULL_OPEN_SOURCE)
 static bool sklRegisteredMmd =
     MediaFactory<uint32_t, MmdDevice>::
     Register<MmdDeviceG9Skl>((uint32_t)IGFX_SKYLAKE);
-- 
2.40.0

