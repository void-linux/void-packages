# Template file for 'brother-dcp8410-lpr'
pkgname=brother-dcp8410-lpr
version=1.5.0
revision=1
archs="i686 x86_64"
create_wrksrc=yes
hostmakedepends="curl"
depends="ghostscript"
short_desc="LPR driver for the Brother DCP-L8410CDW machines"
maintainer="Shahab Vahedi <list+void@vahedi.org>"
license="custom:BrotherEULA"
homepage="https://support.brother.com/g/b/producttop.aspx?c=eu_ot&lang=en&prod=dcpl8410cdw_eu"
distfiles="https://download.brother.com/welcome/dlf103239/dcpl8410cdwlpr-${version}-0.i386.deb"
checksum="1e97cd530e7b6162bf436d16e94098e524b438fdecf0a8044c5e07efa9300080"
repository="nonfree"
conf_files="/opt/brother/Printers/dcpl8410cdw/inf/brdcpl8410cdwrc"
nopie=yes
nodebug=yes
_license_checksum=4ab8b9269a74377ee85458cc4dfbacfbf6d26665426572fe16f7102af214bd3c

# Copied from brother-brscan3/template
post_extract() {
	curl -sk https://support.brother.com/g/s/agreement/English_lpr/agree.html | \
		sed -n \
			-e 's,</\?p>,,' \
			-e 's/\&quot;/"/g' \
			-e 's, \?^M,,' \
			-e 's,^[ \t]\+,,' \
			-e '14,18p' \
			-e '28,45p' \
		> LICENSE

	filesum="$(xbps-digest LICENSE)"
	if [ "$filesum" != "$_license_checksum" ]; then
		msg_error "SHA256 mismatch for LICENSE:\n$filesum\n"
	fi
}

do_install() {
	vmkdir opt/brother/Printers/dcpl8410cdw/lpd 755

	vcopy opt/brother/Printers/dcpl8410cdw/inf opt/brother/Printers/dcpl8410cdw
	vinstall opt/brother/Printers/dcpl8410cdw/lpd/filter_dcpl8410cdw \
		755 opt/brother/Printers/dcpl8410cdw/lpd

	# Copy the executables based on architecture type
	if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
		_arch="x86_64"
	elif [ "$XBPS_TARGET_MACHINE" = "i686" ]; then
		_arch="i686"
	else
		_arch="unknown"
	fi
	for bin in brdcpl8410cdwfilter brprintconf_dcpl8410cdw; do
		vinstall opt/brother/Printers/dcpl8410cdw/lpd/${_arch}/${bin} \
			755 opt/brother/Printers/dcpl8410cdw/lpd/
	done

	vmkdir usr/bin 755
	ln -sf /opt/brother/Printers/dcpl8410cdw/lpd/brprintconf_dcpl8410cdw \
		${DESTDIR}/usr/bin/brprintconf_dcpl8410cdw

	vlicense LICENSE
}
