# Template file for 'dkms'
pkgname=dkms
version=3.0.3
revision=1
conf_files="/etc/dkms/framework.conf"
depends="bash kmod gcc make coreutils"
checkdepends="linux-headers runit-void"
short_desc="Dynamic Kernel Modules System"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-or-later"
homepage="https://github.com/dell/dkms"
distfiles="${homepage}/archive/v${version}.tar.gz"
checksum=89e57cf90298f020646a5fa61d11983406631486b9f5591bb9da9465ee969f3d
make_check=ci-skip

case "$XBPS_TARGET_MACHINE" in
	# Too many competing kernels for arm* to depend on linux-headers
	arm*) ;;
	*) depends+=" linux-headers" ;;
esac

if [ "$CROSS_BUILD" ]; then
	depends+=" openssl-devel gmp-devel libada-devel libmpc-devel flex"
fi

do_build() {
	make dkms
}

do_check() {
	if [ $(id -u) = 0 ]; then
		./run_test.sh
	fi
}

do_install() {
 	# We are only interested in the bare minimum.
	make DESTDIR=${DESTDIR} SBIN=${DESTDIR}/usr/bin install
	rm    ${DESTDIR}/etc/dkms/sign_helper.sh
	rm -r ${DESTDIR}/etc/kernel
	rm -r ${DESTDIR}/usr/lib
	# Kernel hooks.
	vinstall ${FILESDIR}/kernel.d/dkms.postinst 754 etc/kernel.d/post-install 10-dkms
	vinstall ${FILESDIR}/kernel.d/dkms.prerm 754 etc/kernel.d/pre-remove 10-dkms
}
