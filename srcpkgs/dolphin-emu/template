# Template file for 'dolphin-emu'
pkgname=dolphin-emu
version=5.0.20347
revision=1
_dolphin_commit=dc0814ae4622313d513468bdc377ee9c031de199
_mgba_commit=8739b22fbc90fdf0b4f6612ef9c0520f0ba44a51
_googletest_commit=58d77fa8070e8cec2dc1ed015d66b454c8d78850
_zlib_ng_commit=ce01b1e41da298334f8214389cc9369540a7560f
_cubeb_commit=27d2a102b0b75d9e49d43bc1ea516233fb87d778
_sanitizers_cmake_commit=c3dc841af4dbf44669e65b82cb68a575864326bd
_implot_commit=cc5e1daa5c7f2335a9460ae79c829011dc5cef2d
_libspng_commit=dc5b1032c08efac68ad30170f7ccbf0aa8dd55c9
_rcheevos_commit=d9e990e6d13527532b7e2bb23164a1f3b7f33bb5
_vma_commit=498e20dfd1343d99b9115201034bb0219801cdec
_spirv_cross_commit=50b4d5389b6a06f86fb63a2848e1a7da6d9755ca
_fmt_commit=f5e54359df4c26b6230fc61d38aa294581393084
#Version/hash pair can be found at https://dolphin-emu.org/download/
archs="x86_64* aarch64* ppc64le* i686"
build_style=cmake
configure_args="
 -DDOLPHIN_WC_DESCRIBE=${version%.*}-${version##*.}
 -DDOLPHIN_WC_REVISION=$_dolphin_commit
 -DDOLPHIN_WC_BRANCH=master
 -DDISTRIBUTOR=voidlinux.org
 -DENABLE_ANALYTICS=OFF
 -DUSE_DISCORD_PRESENCE=OFF
 -DUSE_RETRO_ACHIEVEMENTS=OFF"
hostmakedepends="pkg-config qt6-tools qt6-base gettext python3"
makedepends="
 zlib-devel glew-devel libusb-devel qt6-base-devel miniupnpc-devel libevdev-devel
 SDL2-devel pulseaudio-devel alsa-lib-devel ffmpeg-devel libgomp-devel libcurl-devel
 portaudio-devel libopenal-devel soundtouch-devel lzo-devel libbluetooth-devel
 mbedtls-devel SFML-devel libenet-devel liblzma-devel pugixml-devel qt6-svg-devel
 liblz4-devel"
depends="desktop-file-utils"
short_desc="Gamecube / Wii / Triforce emulator"
maintainer="Henry Naguski <henry@nilsu.org>"
license="GPL-2.0-or-later"
homepage="http://dolphin-emu.org"
distfiles="https://github.com/dolphin-emu/dolphin/archive/${_dolphin_commit}.tar.gz
 https://github.com/mgba-emu/mgba/archive/${_mgba_commit}.tar.gz
 https://github.com/google/googletest/archive/${_googletest_commit}.tar.gz
 https://github.com/zlib-ng/zlib-ng/archive/${_zlib_ng_commit}.tar.gz
 https://github.com/mozilla/cubeb/archive/${_cubeb_commit}.tar.gz
 https://github.com/arsenm/sanitizers-cmake/archive/${_sanitizers_cmake_commit}.tar.gz
 https://github.com/epezent/implot/archive/${_implot_commit}.tar.gz
 https://github.com/randy408/libspng/archive/${_libspng_commit}.tar.gz
 https://github.com/RetroAchievements/rcheevos/archive/${_rcheevos_commit}.tar.gz
 https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator/archive/${_vma_commit}.tar.gz
 https://github.com/KhronosGroup/SPIRV-Cross/archive/${_spirv_cross_commit}.tar.gz
 https://github.com/fmtlib/fmt/archive/${_fmt_commit}.tar.gz"
checksum="232195245dd096e84cb34e1df745fa741c2043effae3a2b97a4f6aa3541ea5c3
 07e73f02198affccf83cc9740d377b78ba27866b0d654a5e55cafae69d1dfa1c
 c6ab3b6b33f51ef7465921f8f8c10c15d7cbc510761a15a18ad85babf6d73278
 64a6d355d2d5c9449fc047e5bb0ca32875fc385061dfaf1df3aa791577b7ff5e
 9326a22d41b30b6d613c248a8ea2eb56c5ffc76a7080b0127165682fd8eba13e
 19d511a3a4ddc872c89ab62c070dd8d1fcc733e6ea4655f5876a60237cd556ba
 af51940ae6482c0e96ffb4309982fa309f9aa383cd8f980081681010c8c3a835
 2486cf203f8a201448ebd34949bc7f73038781a9099e205e55f1907fa91931bc
 dc165d4e7ce7b2b36169d94cc3291012e4b1fdf6a49b6b1d33c5126b289c888f
 4cb34c92b57d132d3200aa8c9b7f758e963eaeb31b6127d6edd0cd0902dc177e
 ed27481a78470fe9905cdfec8fd2ebb6c8f68a17377c2879527c2fcb2a01751c
 ff9d0525ee224e400aed21a6a858fe5a6b155ee1ca1bd2577742497941d99550"
nopie=yes

case "$XBPS_TARGET_MACHINE" in
	i686*) CFLAGS=-msse2 ;;
esac

case "$XBPS_TARGET_MACHINE" in
	x86_64*|aarch64*) ;;
	*) configure_args+=" -DENABLE_GENERIC=ON" ;;
esac

post_extract() {
	mv dolphin-${_dolphin_commit}/* .
	rmdir Externals/mGBA/mgba
	rmdir Externals/cubeb/cubeb
	rmdir Externals/gtest
	rmdir Externals/zlib-ng/zlib-ng
	rmdir Externals/implot/implot
	rmdir Externals/libspng/libspng
	rmdir Externals/rcheevos/rcheevos
	rmdir Externals/VulkanMemoryAllocator
	rmdir Externals/spirv_cross/SPIRV-Cross
	mv mgba-${_mgba_commit} Externals/mGBA/mgba
	mv cubeb-${_cubeb_commit} Externals/cubeb/cubeb
	cp -r googletest-${_googletest_commit} Externals/gtest
	mv zlib-ng-${_zlib_ng_commit} Externals/zlib-ng/zlib-ng
	mv implot-${_implot_commit} Externals/implot/implot
	mv libspng-${_libspng_commit} Externals/libspng/libspng
	mv rcheevos-${_rcheevos_commit} Externals/rcheevos/rcheevos
	mv VulkanMemoryAllocator-${_vma_commit} Externals/VulkanMemoryAllocator
	mv SPIRV-Cross-${_spirv_cross_commit} Externals/spirv_cross/SPIRV-Cross
	rmdir Externals/cubeb/cubeb/googletest
	rmdir Externals/cubeb/cubeb/cmake/sanitizers-cmake
	mv googletest-${_googletest_commit} Externals/cubeb/cubeb/googletest
	mv sanitizers-cmake-${_sanitizers_cmake_commit} Externals/cubeb/cubeb/cmake/sanitizers-cmake
	rmdir Externals/fmt/fmt
	mv fmt-${_fmt_commit} Externals/fmt/fmt
}

post_install() {
	rm -f ${DESTDIR}/usr/lib/*.a
	vmkdir usr/lib/udev/rules.d
	vcopy Data/51-usb-device.rules usr/lib/udev/rules.d
}
