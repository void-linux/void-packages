# Template file for 'lemmy'
pkgname=lemmy
version=0.18.5
revision=1
_translation_commit=1c42c579460871de7b4ea18e58dc25543b80d289
build_style=cargo
configure_args="--features=embed-pictrs"
hostmakedepends="pkg-config protobuf"
makedepends="openssl-devel libpqxx-devel libzstd-devel"
depends="ImageMagick ffmpeg exiftool"
short_desc="Link aggregator and forum for the fediverse"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="AGPL-3.0-only"
homepage="https://join-lemmy.org/"
changelog="https://raw.githubusercontent.com/LemmyNet/lemmy/main/RELEASES.md"
distfiles="https://github.com/LemmyNet/lemmy/archive/refs/tags/${version}.tar.gz
 https://github.com/LemmyNet/lemmy-translations/archive/${_translation_commit}.tar.gz"
checksum="d366d805c0e57001cfc8a3d927a3313828bb75a415a1c13485a897af07f98b29
 7775b2a3070205f9b4b099215b30ee6bef3d5fb0c4e95aab52697e2bcb7cf9f7"
system_accounts="_lemmy"
make_dirs="/var/lib/lemmy 0700 _lemmy _lemmy"
_lemmy_homedir="/var/lib/lemmy"
conf_files="/etc/lemmy/lemmy.hjson"

post_extract() {
	cp -r lemmy-${version}/. .
	cp -r lemmy-translations-${_translation_commit}/. crates/utils/translations
	rm -rf lemmy-${version} lemmy-translations-${_translation_commit}
}

post_patch() {
	vsed -i "s/unknown version/$version/" crates/utils/src/version.rs
}

post_install() {
	vsconf config/defaults.hjson
	vinstall config/config.hjson 644 etc/lemmy lemmy.hjson
	vsv lemmy
	vlicense LICENSE
}
