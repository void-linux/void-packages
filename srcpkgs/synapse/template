# Template file for 'synapse'
pkgname=synapse
version=1.146.0
revision=1
build_style=python3-pep517
build_helper=rust
hostmakedepends="maturin cargo"
makedepends="rust-std python3-devel"
depends="python3-jsonschema python3-immutabledict python3-unpaddedbase64
 python3-canonicaljson python3-signedjson python3-pynacl
 python3-service_identity python3-Twisted python3-openssl python3-yaml
 python3-pyasn1 python3-pyasn1-modules python3-bcrypt python3-Pillow
 python3-msgpack python3-phonenumbers python3-prometheus_client python3-attrs
 python3-netaddr python3-bleach python3-Jinja2 python3-psycopg2 python3-lxml
 python3-saml2 python3-treq python3-macaroons python3-sortedcontainers
 python3-typing_extensions python3-cryptography python3-ijson
 python3-matrix-common python3-packaging python3-pydantic
 python3-python-multipart python3-setuptools-rust python3-rpds-py python3-cffi
 python3-parsing python3-pyrsistent python3-requests python3-urllib3
 python3-zope.interface"
checkdepends="$depends python3-parameterized python3-idna python3-txredisapi
 python3-hiredis xmlsec1"
short_desc="Matrix reference homeserver"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="AGPL-3.0-or-later"
homepage="https://element-hq.github.io/synapse"
changelog="https://raw.githubusercontent.com/element-hq/synapse/develop/CHANGES.md"
distfiles="https://github.com/element-hq/synapse/archive/refs/tags/v${version}.tar.gz"
checksum=7791f0ee45659eea19c057cb9a00a9bc1f51d71bb8cc3b4cfa180b8cdb4e0438

system_accounts="synapse"
synapse_homedir="/var/lib/synapse"

make_dirs="
	/var/lib/synapse 0700 synapse synapse
	/etc/synapse 755 synapse synapse
	/var/log/synapse 0755 synapse synapse"


do_check() {
	local testdir="${wrksrc}/.xbps-testdir/$(date +%s)"
	python3 -m installer --destdir "${testdir}" dist/*.whl
	cp -r tests "${testdir}/${py3_sitelib}"
	PYTHONPATH="${testdir}/${py3_sitelib}" trial3 ${makejobs} tests
}

post_install() {
	vsv synapse

	vsconf docs/sample_config.yaml homeserver.yaml
	vsconf docs/sample_log_config.yaml log.yaml

	vlicense LICENSE-AGPL-3.0
}
