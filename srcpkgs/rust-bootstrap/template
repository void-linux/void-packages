# Template file for 'rust-bootstrap'
pkgname=rust-bootstrap
version=1.57.0
revision=2
create_wrksrc=yes
short_desc="Rust programming language bootstrap toolchain"
maintainer="q66 <daniel@octaforge.org>"
license="MIT, Apache-2.0"
homepage="https://www.rust-lang.org/"
conflicts="rust>=0"
lib32disabled=yes
nostrip=yes

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	depends="libexecinfo-devel"
fi

case "$XBPS_MACHINE" in
	x86_64*|i686|ppc64le|ppc) _bootstrap_url="https://static.rust-lang.org/dist" ;;
	*) _bootstrap_url="https://alpha.de.repo.voidlinux.org/distfiles" ;;
esac

# we don't use upstream cargo binaries for ppc32, as they are busted (probably
# a dependency is wrong, which results in failed signature verification when
# updating the crates.io index)
if [ "$XBPS_MACHINE" = "ppc" ]; then
	_cargo_bootstrap_url="https://alpha.de.repo.voidlinux.org/distfiles"
else
	_cargo_bootstrap_url="$_bootstrap_url"
fi

distfiles="
 ${_bootstrap_url}/rustc-${version}-${RUST_TARGET}.tar.xz
 ${_bootstrap_url}/rust-std-${version}-${RUST_TARGET}.tar.xz
 ${_cargo_bootstrap_url}/cargo-${version}-${RUST_TARGET}.tar.xz"

case "$XBPS_TARGET_MACHINE" in
	i686)
		checksum="
		 9bade3fcd246b0ad6859fcf5d0a80d3eb833e5410efa3a5552c241865562461e
		 586e7fd521a058cbf4778abb67d7d078dd4820d356351d0b6a719e21d00966db
		 9898a1fae2647f930fa14b9c160a1d22e67ccc70ac0d2d8f79ef1ffcf8d89af7"
		;;
	x86_64)
		checksum="
		 c42f40c5279a3a9d539cae93dbcab9d333777ad9a60a5b9f1086b874ef63db86
		 ccdc72d06c90841b7227ec3630337881eeda3da5fbe87328d2e9d705f6f8016c
		 ed2013713ae742895af5df8d91c5430ba9ba3c781e3bc7f3471b220cc06d565d"
		;;
	x86_64-musl)
		checksum="
		 5b04e0e0bbf140f7c49baa6280114c28f59f6de50481bdd45074eebf629c174c
		 818213a6444503ed6adf0231d3c71de990d4c26926c62e8c602bb7e2d636fb94
		 0d8564d0348843d6c08d98990d9eac50b7b7ab790f89d514b4f45079e786d932"
		;;
	ppc64le)
		checksum="
		 f43cb99109c3438c77c7079cdce4673df3320e310158e0b4d949c1babc4300fc
		 fc07eb3e9f3d227428cc5b53ca868e3de375bc198ce4dce7b87a9246e6fec81a
		 599cf1b5a8cdbf76d591621bc9222aefa60e2f5fd378ae71c4dcf4514c47122e"
		;;
	ppc64le-musl)
		checksum="
		 6b48e521ba8a070a7b992595e82c5a164cc01c93bbd9a7b3d4db362f4b060df8
		 d7876e817fc95df2e81858fc9ddb95b10fb83b413277ea6dbdfa9a80fa0d990e
		 99ae7661c62617ac42adacb50cce9ae8d019bcf85e987b98fbc27240bceb1dd9"
		;;
	ppc64)
		checksum="
		 2ea5b66d2cd8b9c251590fd5bd3e23cedec658b61f541e2824ce3fdcda263982
		 e9c1394771b1b24241d8938ad75c4a6ed8bfa043522c74767b3528f2289095c0
		 c64b9cce7a3ceaf5c310fad70be33077f1e6dea1384767fcf744732c0daa7473"
		;;
	ppc)
		checksum="
		 a1d7611b2d39224ba9a915009ae2a6639def42767370f50effd57770b3eb2150
		 bc117ce5f0c81d2e14ea2d1832c0e908b1153caf49f295a9d28af2128f5fae44
		 e67c2a7d16b3c732a1dcb663d031daf6eaca4b74d1d15196086c53c0c3a5b0a2"
		;;
	*) broken="rust/cargo bootstrap binaries unavailable for ${XBPS_MACHINE}";;
esac


do_install() {
	for d in rust*; do
		cd $d
		./install.sh --prefix=/usr --destdir="${DESTDIR}"
		cd ..
	done

	vlicense rustc-${version}-${RUST_TARGET}/COPYRIGHT
	vlicense rustc-${version}-${RUST_TARGET}/LICENSE-APACHE
	vlicense rustc-${version}-${RUST_TARGET}/LICENSE-MIT

	rm -f ${DESTDIR}/usr/lib/rustlib/${RUST_TARGET}/bin/rust-ll*
}

cargo-bootstrap_package() {
	short_desc="Bootstrap binaries of Rust package manager"
	conflicts="cargo>=0"
	lib32disabled=yes
	nostrip=yes
	pkg_install() {
		cd cargo-${version}-${RUST_TARGET}
		./install.sh --prefix=/usr --destdir="${PKGDESTDIR}"
		cd ..
		rm -rf ${PKGDESTDIR}/usr/lib/rustlib/
	}
}
