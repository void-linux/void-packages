# Template file for 'rust-bootstrap'
pkgname=rust-bootstrap
version=1.67.1
revision=1
short_desc="Rust programming language bootstrap toolchain"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT, Apache-2.0"
homepage="https://www.rust-lang.org/"
conflicts="rust>=0"
lib32disabled=yes
nostrip=yes
repository=bootstrap

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	depends="libexecinfo-devel"
fi

_bootstrap_url="https://static.rust-lang.org/dist"

case "$XBPS_TARGET_MACHINE" in
	x86_64*|i686) ;;
	# See srcpkgs/rust-bootstrap/files/generating-distfiles.md for details
	*) _bootstrap_url="https://repo-default.voidlinux.org/distfiles";;
esac

# hardcode platform triplets
# because this info isn't avaialble here without hacky workarounds
case "$XBPS_TARGET_MACHINE" in
	i686)
		distfiles="
		 ${_bootstrap_url}/rustc-${version}-i686-unknown-linux-gnu.tar.xz
		 ${_bootstrap_url}/rust-std-${version}-i686-unknown-linux-gnu.tar.xz"
		checksum="
		 0c77fde6daa80825f8cb81a5525c99db238a3ab4f0b226470964062e74603dd6
		 aab2d7aa76793e78c9c8810e93ed8978f6422843b1277e9c60337b0f943a4409"
		;;
	x86_64)
		distfiles="
		 ${_bootstrap_url}/rustc-${version}-x86_64-unknown-linux-gnu.tar.xz
		 ${_bootstrap_url}/rust-std-${version}-x86_64-unknown-linux-gnu.tar.xz"
		checksum="
		 e27ec0c6d1a2b2b38e5258904c3741ddb246bff5715aa95e595f818aa77f7bee
		 f4dc8468dfc1dbd86f865b10f06e0e4b4e76f5a3a1cc27317a520ab1660844e9"
		;;
	x86_64-musl)
		distfiles="
		 ${_bootstrap_url}/rustc-${version}-x86_64-unknown-linux-musl.tar.xz
		 ${_bootstrap_url}/rust-std-${version}-x86_64-unknown-linux-musl.tar.xz"
		checksum="
		 55fa8c61c767d23357075162ebd8c2be7297f2127e683c40d5db53ebcf6a737f
		 89741cd2ac00c3a3f565bcccdf442cc1f9ec58ea419f1f0d09e911be0ff86c87"
		;;
	*) broken="rust bootstrap binaries unavailable for ${XBPS_TARGET_MACHINE}";;
esac

do_install() {
	for d in *; do
		cd $d
		./install.sh --prefix=/usr --destdir="${DESTDIR}"
		cd ..
	done

	vlicense rustc-${version}-${RUST_TARGET}/COPYRIGHT
	vlicense rustc-${version}-${RUST_TARGET}/LICENSE-APACHE
	vlicense rustc-${version}-${RUST_TARGET}/LICENSE-MIT

	rm -rf ${DESTDIR}/usr/share/doc/rust
	rm -f ${DESTDIR}/usr/lib/rustlib/${RUST_TARGET}/bin/rust-ll*
}
