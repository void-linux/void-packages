From 391c12b65643c7db6075547cce9addea5dcfb082 Mon Sep 17 00:00:00 2001
From: Nathan Owens <ndowens@artixlinux.org>
Date: Mon, 23 Nov 2020 18:38:08 -0600
Subject: [PATCH] cmake

---
 master/CMakeLists.txt       |  6 +++++-
 zap/bitfighter_client.cmake | 18 ++++++++++++++----
 zap/bitfighterd.cmake       |  5 +++--
 3 files changed, 22 insertions(+), 7 deletions(-)

diff --git master/CMakeLists.txt master/CMakeLists.txt
index 28303fa..7dd2988 100644
--- master/CMakeLists.txt
+++ master/CMakeLists.txt
@@ -41,7 +41,11 @@ else()
 endif()
 
 
-set(MASTER_DEPS tnl tomcrypt)
+set(MASTER_DEPS tnl)
+# Add tomcypt if not already found on system
+if(NOT TOMCRYPT_FOUND)
+	list(APPEND MASTER_DEPS tomcrypt)
+endif()
 
 set(MASTER_LIBS 
 	tnl
diff --git zap/bitfighter_client.cmake zap/bitfighter_client.cmake
index 5dcbd3c..444a365 100644
--- zap/bitfighter_client.cmake
+++ zap/bitfighter_client.cmake
@@ -11,13 +11,23 @@ add_library(bitfighter_client OBJECT
 	${OTHER_HEADERS}
 )
 
+# If certain system libs were not found, add the in-tree variants as dependencies
+set(CLIENT_EXTRA_DEPS "")
+if(NOT ALURE_FOUND)
+	list(APPEND CLIENT_EXTRA_DEPS alure)
+endif()
+if(NOT TOMCRYPT_FOUND)
+	list(APPEND CLIENT_EXTRA_DEPS tomcrypt)
+endif()
+
+if(NOT CLIPPER_FOUND)
+	list(APPEND CLIENT_EXTRA_DEPS clipper)
+endif()
+
 add_dependencies(bitfighter_client
-	alure
-	${LUA_LIB}
 	tnl
-	tomcrypt
-	clipper
 	poly2tri
+	${CLIENT_EXTRA_DEPS}
 )
 
 if(USE_GLES)
diff --git zap/bitfighterd.cmake zap/bitfighterd.cmake
index 3363a7b..917fb8d 100644
--- zap/bitfighterd.cmake
+++ zap/bitfighterd.cmake
@@ -11,13 +11,14 @@ add_executable(bitfighterd
 add_dependencies(bitfighterd
 	tnl
 	${LUA_LIB}
-	tomcrypt
-	clipper
 	poly2tri
 )
 
 target_link_libraries(bitfighterd
 	${SHARED_LIBS}
+	${LUA_LIB}
+	${CLIPPER_LIBRARIES}
+	${TOMCRYPT_LIBRARIES}
 )
 
 set_target_properties(bitfighterd
-- 
2.29.2

diff --git zap/bitfighterd.cmake zap/bitfighterd.cmake
index 917fb8d..9b7f1b7 100644
--- zap/bitfighterd.cmake
+++ zap/bitfighterd.cmake
@@ -10,7 +10,6 @@ add_executable(bitfighterd
 
 add_dependencies(bitfighterd
 	tnl
-	${LUA_LIB}
 	poly2tri
 )
 
