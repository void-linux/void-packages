# Template file for 'textadept'
pkgname=textadept
version=11.4
revision=1
build_wrksrc="src"
build_style="gnu-makefile"
make_use_env=yes
hostmakedepends="tar unzip pkg-config"
makedepends="gtk+3-devel ncurses-devel"
short_desc="Fast, minimalist, and extensible text editor for programmers"
maintainer="reback00 <reback00@protonmail.com>"
license="MIT"
homepage="https://orbitalquark.github.io/textadept/"
# Note: The dependency urls and filenames must be checked and updated manually
# for distfiles and skip_extraction variables on every new release (and
# checksums updated accordingly). This is so that XBPS can cache them. Details:
# https://github.com/void-linux/void-packages/pull/15627#issuecomment-549018252
distfiles="https://github.com/orbitalquark/textadept/archive/textadept_${version}.tar.gz
 https://www.scintilla.org/scintilla524.tgz
 https://www.scintilla.org/lexilla510.tgz
 https://github.com/orbitalquark/scinterm/archive/475d8d43f3418590c28bd2fb07ee9229d1fa2d07.zip
 https://github.com/orbitalquark/scintillua/archive/9088723504b19f8611b66c119933a4dc7939d7b8.zip
 https://www.lua.org/ftp/lua-5.4.4.tar.gz
 http://www.inf.puc-rio.br/~roberto/lpeg/lpeg-1.0.2.tar.gz
 https://github.com/keplerproject/luafilesystem/archive/v1_8_0.zip
 https://github.com/orbitalquark/gtdialog/archive/444af9ca8a73151dbf759e6676d1035af469f01a.zip
 https://invisible-mirror.net/archives/cdk/cdk-5.0-20200923.tgz
 https://www.leonerd.org.uk/code/libtermkey/libtermkey-0.22.tar.gz"
checksum="fe10cbe9949e3a2ec4445ace16e26eb4b905cee2e36de76295ea9a7ca6c3aba8
 4aef1488c9a43b172e05ab762566049e135d1b91ca9d5d5f9f50a59c985acc66
 6b3595274005498671b854cf57bdeec2254966f371712fcf3a716d97aa7f3fd8
 94d30ad1115c38b83d4511396ba55e9614b3518565e538808977237b624e79d1
 576b7592debe4a9650bd04b32e187c9fe5a2027037d92455167adb4da26b1d1a
 164c7849653b80ae67bec4b7473b884bf5cc8d2dca05653475ec2ed27b9ebf61
 48d66576051b6c78388faad09b70493093264588fcd0f258ddaab1cdd4a15ffe
 e3a6beca7a8a90522eed31db6ccdc5ed65a433826500c6862784e27671b9e18a
 ec0917ece59726dccaab7878b8978bcc7a5fea6aeccfaed25ed3ef9b2039c718
 007f5de880cb2eebd8556df7e4cd8673d5e64c9970147eee6923a814c29faaed
 6945bd3c4aaa83da83d80a045c5563da4edd7d0374c62c0d35aec09eb3014600"
skip_extraction="scintilla524.tgz
 lexilla510.tgz
 475d8d43f3418590c28bd2fb07ee9229d1fa2d07.zip
 9088723504b19f8611b66c119933a4dc7939d7b8.zip
 lua-5.4.4.tar.gz
 lpeg-1.0.2.tar.gz
 v1_8_0.zip
 444af9ca8a73151dbf759e6676d1035af469f01a.zip
 cdk-5.0-20200923.tgz
 libtermkey-0.22.tar.gz"

post_extract() {
	# We copy the downloaded dep files to src directory so that they are found
	# and not downloaded again by the build process. This helps to utilize caching.
	echo "${skip_extraction}" | while read archive; do
		if [ -f "${XBPS_SRCDISTDIR}/${sourcepkg}-${version}/${archive}" ]; then
			cp "${XBPS_SRCDISTDIR}/${sourcepkg}-${version}/${archive}" \
				"${wrksrc}/${build_wrksrc}/"
		fi
	done
}

pre_configure() {
	# For cross builds
	vsed -i \
		-e '/CC :=/d' \
		-e '/^CFLAGS :=/d' \
		-e '/CXX :=/d' \
		-e 's/^CXXFLAGS :=.*/CXXFLAGS += -std=c++17/' Makefile
}

pre_build() {
	make deps
}

post_install() {
	# Binaries in /usr/share/textadept are not allowed
	# So we relocate to /usr/lib/textadept
	mv "${DESTDIR}/usr/share/textadept" "${DESTDIR}/usr/lib/textadept"
	ln -sf "/usr/lib/textadept/textadept" "${DESTDIR}/usr/bin/textadept"
	ln -sf "/usr/lib/textadept/textadept-curses" \
		"${DESTDIR}/usr/bin/textadept-curses"

	vlicense ../LICENSE
}
