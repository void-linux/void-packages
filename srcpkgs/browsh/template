# Template file for 'browsh'
pkgname=browsh
version=1.5.0
revision=1
build_style=go
go_import_path="github.com/browsh-org/browsh"
go_package="$go_import_path/interfacer/src/browsh"
hostmakedepends="curl dep go-bindata"
short_desc="Fully-modern text-based browser, rendering to TTY and browsers"
maintainer="zhengqunkoo <zhengqun.koo@gmail.com>"
license="LGPL-2.1-only"
homepage="https://www.brow.sh/"
distfiles="https://$go_import_path/archive/v$version.tar.gz"
checksum=df23c86f27f19c42bf7c42753a80f202d24c01b447c6ebd8f898f68fdd3889c0

# Manipulate paths, because nested dir of repo is a go package
pre_build() {
	INTERFACER_ROOT="$GOSRCPATH/interfacer"
	cd $INTERFACER_ROOT

	dep ensure
	# main.go expects browsh/interfacer/src/browsh in GOPATH/src
	cd $GOPATH
	ln -nfs "$GOSRCPATH" src/browsh

	# Build the URI for the webextension file
	base='https://github.com/browsh-org/browsh/releases/download'
	release_url="$base/v$version/browsh-${version}-an.fx.xpi"

	xpi_file=$INTERFACER_ROOT/browsh.xpi
	destination=$INTERFACER_ROOT/src/browsh/webextension.go

	# Download the web extension
	curl -L -o $xpi_file $release_url

	# Convert the web extension into binary data that can be compiled into a
	# cross-platform Go binary.
	XPI_FILE=$xpi_file BIN_FILE=$destination \
		$INTERFACER_ROOT/contrib/xpi2bin.sh
}

do_build() {
	cd "$GOSRCPATH/interfacer"
	go build -o browsh src/main.go
}

do_install() {
	vbin interfacer/browsh
}

post_install() {
	vlicense LICENSE
}
