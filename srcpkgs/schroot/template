# Template file for 'schroot'
pkgname=schroot
reverts="1.7.2_9"
version=1.6.12
revision=1
_debian_version=2
build_style=cmake
# Upstream has dchroot OFF
configure_args="
	-DSCHROOT_LIBEXEC_DIR=/usr/libexec/schroot
	-Ddebug=OFF
	-Ddchroot=ON
	-Dbash_completion_dir=/usr/share/bash-completion/completions
	-Dlvm-snapshot=ON
	-Dbtrfs-snapshot=ON
	-Dzfs-snapshot=ON
	-Dblock-device=ON
	-Dloopback=ON
	-DLOSETUP_EXECUTABLE=/usr/sbin/losetup
	-Duuid=ON
	-DBTRFS_EXECUTABLE=/usr/sbin/btrfs
	-DLVCREATE_EXECUTABLE=/usr/sbin/lvcreate
	-DLVREMOVE_EXECUTABLE=/usr/sbin/lvremove
	-DZFS_EXECUTABLE=/usr/sbin/zfs"
conf_files="
	/etc/schroot/minimal/nssdatabases
	/etc/schroot/minimal/fstab
	/etc/schroot/minimal/copyfiles
	/etc/schroot/buildd/nssdatabases
	/etc/schroot/buildd/fstab
	/etc/schroot/buildd/copyfiles
	/etc/schroot/default/nssdatabases
	/etc/schroot/default/fstab
	/etc/schroot/default/copyfiles
	/etc/schroot/schroot.conf
	/etc/schroot/desktop/nssdatabases
	/etc/schroot/desktop/fstab
	/etc/schroot/desktop/copyfiles
	/etc/schroot/sbuild/nssdatabases
	/etc/schroot/sbuild/fstab
	/etc/schroot/sbuild/copyfiles"
make_dirs="
	/var/lib/schroot/unpack 0755 root root
	/var/lib/schroot/union/underlay 0755 root root
	/var/lib/schroot/union/overlay 0755 root root
	/var/lib/schroot/session 0755 root root
	/var/lib/schroot/mount 0755 root root
	/etc/schroot/chroot.d 0755 root root"
hostmakedepends="pkg-config gettext xz po4a groff"
makedepends="boost-devel pam-devel lockdev-devel libuuid-devel
 e2fsprogs-devel gettext-devel libcppunit-devel"
short_desc="Allows users to execute commands in different chroots"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-3.0-only"
homepage="https://wiki.debian.org/Schroot"
distfiles="${DEBIAN_SITE}/main/s/${pkgname}/${pkgname}_${version}.orig.tar.xz
 ${DEBIAN_SITE}/main/s/${pkgname}/${pkgname}_${version}-${_debian_version}.debian.tar.xz"
checksum="0bed8a069856a82261046b2e549af60ee32b79ebcdbf642424f378ec7aea6b77
 8ff03534007c6d55eb4032b637232954eaddba5cf18c91b42ff3016697ba0f93"
skip_extraction="${pkgname}_${version}-${_debian_version}.debian.tar.xz"

pre_patch() {
	rm -rf debian
	bsdtar -xf "$XBPS_SRCDISTDIR/$pkgname-$version/$skip_extraction"
	grep '^[^#]' debian/patches/series | while read p; do
		msg_normal "Patching (Debian): $p\n"
		patch -Np1 -s -F0 -i debian/patches/$p
	done
}

do_check() {
	# expect to be run with root
	cd build
	ctest -E "(sbuild-chroot-config)"
}

post_install() {
	# Remove development files
	rm -rf ${DESTDIR}/usr/include \
		${DESTDIR}/usr/lib/*.a \
		${DESTDIR}/usr/lib/pkgconfig
}
