# Template file for 'ghc'
pkgname=ghc
# Keep this synchronized with http://www.stackage.org/lts
version=8.6.5
revision=2
wrksrc="ghc-${version%[!0-9]}"
patch_args="-Np1"
build_style=gnu-configure
configure_args="--with-system-libffi"
hostmakedepends="automake docbook-xsl ghc-bin libxslt python-Sphinx"
makedepends="gmp-devel libffi-devel libnuma-devel ncurses-devel"
depends="perl gcc libffi-devel gmp-devel libnuma-devel"
short_desc="Glorious Haskell Compiler"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="BSD"
homepage="http://www.haskell.org/ghc/"
distfiles="http://www.haskell.org/ghc/dist/${version%[!0-9]}/${pkgname}-${version%[!0-9]}-src.tar.xz"
checksum=4d4aa1e96f4001b934ac6193ab09af5d6172f41f5a5d39d8e43393b9aafee361
nocross=yes  # ask leah2 before wasting time trying to do that
_bindir="/usr/lib/${pkgname}-${version}/bin"
nopie_files="
 ${_bindir}/ghc
 ${_bindir}/ghc-iserv
 ${_bindir}/ghc-iserv-dyn
 ${_bindir}/ghc-iserv-prof
 ${_bindir}/ghc-pkg
 ${_bindir}/haddock
 ${_bindir}/hp2ps
 ${_bindir}/hpc
 ${_bindir}/hsc2hs
 ${_bindir}/runghc
 ${_bindir}/unlit
"
shlib_provides="
 libHSCabal-2.4.0.1-ghc8.6.5.so
 libHSarray-0.5.3.0-ghc8.6.5.so
 libHSbase-4.12.0.0-ghc8.6.5.so
 libHSbinary-0.8.6.0-ghc8.6.5.so
 libHSbytestring-0.10.8.2-ghc8.6.5.so
 libHScontainers-0.6.0.1-ghc8.6.5.so
 libHSdeepseq-1.4.4.0-ghc8.6.5.so
 libHSdirectory-1.3.3.0-ghc8.6.5.so
 libHSfilepath-1.4.2.1-ghc8.6.5.so
 libHSghc-8.6.5-ghc8.6.5.so
 libHSghc-boot-8.6.5-ghc8.6.5.so
 libHSghc-boot-th-8.6.5-ghc8.6.5.so
 libHSghc-compact-0.1.0.0-ghc8.6.5.so
 libHSghc-heap-8.6.5-ghc8.6.5.so
 libHSghc-prim-0.5.3-ghc8.6.5.so
 libHSghci-8.6.5-ghc8.6.5.so
 libHShaskeline-0.7.4.3-ghc8.6.5.so
 libHShpc-0.6.0.3-ghc8.6.5.so
 libHSinteger-gmp-1.0.2.0-ghc8.6.5.so
 libHSlibiserv-8.6.3-ghc8.6.5.so
 libHSmtl-2.2.2-ghc8.6.5.so
 libHSparsec-3.1.13.0-ghc8.6.5.so
 libHSpretty-1.1.3.6-ghc8.6.5.so
 libHSprocess-1.6.5.0-ghc8.6.5.so
 libHSrts-ghc8.6.5.so
 libHSrts_debug-ghc8.6.5.so
 libHSrts_l-ghc8.6.5.so
 libHSrts_thr-ghc8.6.5.so
 libHSrts_thr_debug-ghc8.6.5.so
 libHSrts_thr_l-ghc8.6.5.so
 libHSstm-2.5.0.0-ghc8.6.5.so
 libHStemplate-haskell-2.14.0.0-ghc8.6.5.so
 libHSterminfo-0.4.1.2-ghc8.6.5.so
 libHStext-1.2.3.1-ghc8.6.5.so
 libHStime-1.8.0.2-ghc8.6.5.so
 libHStransformers-0.5.6.2-ghc8.6.5.so
 libHSunix-2.7.2.2-ghc8.6.5.so
 libHSxhtml-3000.2.2.1-ghc8.6.5.so
"

pre_configure() {
	export CONF_CC_OPTS_STAGE0=$CFLAGS_FOR_BUILD
	export CONF_CC_OPTS_STAGE1=$CFLAGS
	export CONF_CC_OPTS_STAGE2=$CFLAGS
	export CONF_GCC_LINKER_OPTS_STAGE0=$LDFLAGS_FOR_BUILD
	export CONF_GCC_LINKER_OPTS_STAGE1=$LDFLAGS
	export CONF_GCC_LINKER_OPTS_STAGE2=$LDFLAGS
	export CONF_CPP_OPTS_STAGE0=$CPPFLAGS_FOR_BUILD
	export CONF_CPP_OPTS_STAGE1=$CPPFLAGS
	export CONF_CPP_OPTS_STAGE2=$CPPFLAGS

	autoreconf -fi
}

post_install() {
	sed -i 's#/usr/lib/ccache/bin/##g' ${DESTDIR}/usr/lib/ghc-${version%[!0-9]}/settings
	vlicense LICENSE
}

ghc-doc_package() {
	archs=noarch
	short_desc+=" -- documentation"
	pkg_install() {
		vmove usr/share/doc
	}
}
