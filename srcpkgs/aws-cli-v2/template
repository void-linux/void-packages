# Template file for 'aws-cli-v2'
pkgname=aws-cli-v2
version=2.8.3
revision=1
archs="i686 x86_64*"
wrksrc="aws-cli-${version}"
build_style=python3-pep517
hostmakedepends="python3-awscrt python3-colorama python3-cryptography python3-dateutil
	python3-dateutil python3-distro python3-docutils python3-flit_core python3-jmespath
	python3-prompt_toolkit python3-ruamel.yaml python3-urllib3 python3-wcwidth"
depends="python3 python3-awscrt python3-colorama python3-cryptography python3-dateutil
	python3-distro python3-docutils python3-jmespath python3-prompt_toolkit
	python3-ruamel.yaml python3-urllib3"
checkdepends="$depends python3-jsonschema python3-mock python3-pytest python3-pytest-cov"
short_desc="Universal Command Line Interface for Amazon Web Services v2"
maintainer="Wiktor Ciurej <wiktor.ciurej@gmail.com>"
license="Apache-2.0"
homepage="https://github.com/aws/aws-cli"
distfiles="https://github.com/aws/aws-cli/archive/${version}.tar.gz"
checksum=d96d176262b65f03eab6ef9728ff79e9a30a082aa51285ee012ab58cefb39d55
conflicts="aws-cli"

do_check() {
        # integration tests want aws credentials, have some other issues not worth fixing
        # some unit/functional tests are failing too
	PATH="${PWD}/bin:${PATH}" PYTHONPATH="${PWD}" python3 -m pytest tests/unit tests/functional --ignore=tests/functional/autoprompt/ --ignore=tests/functional/botocore/leak/test_resource_leaks.py --ignore=tests/functional/autocomplete/test_main.py --ignore=tests/unit/customizations/wizard/ -W ignore::DeprecationWarning
}

do_install() {
	TMPDIR="${PWD}/build" python3 -m pip install --use-pep517 --prefix /usr --root ${DESTDIR} --no-deps --no-build-isolation --no-clean awscli-${version}-py3-none-any.whl
}

post_install() {
	vinstall bin/aws_bash_completer 644 usr/share/bash-completion/completions aws
	vinstall bin/aws_zsh_completer.sh 644 usr/share/zsh/site-functions _aws
	rm "${DESTDIR}/usr/bin/aws_bash_completer"
	rm "${DESTDIR}/usr/bin/aws_zsh_completer.sh"
	rm "${DESTDIR}/usr/bin/aws.cmd"
}
