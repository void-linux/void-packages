# Template file for 'mstflint'
pkgname=mstflint
version=4.11.0.3
revision=1
_major=${version%.*}
_minor=${version##*.}
wrksrc="${pkgname}-${_major}"
build_style=gnu-configure
configure_args="--enable-fw-mgr --enable-openssl"
makedepends="boost-devel libcurl-devel libibmad-devel liblzma-devel
 libressl-devel libxml2-devel rdma-core-devel zlib-devel"
short_desc="Mellanox firmware burning and diagnostics tools"
maintainer="Rich Gannon <rich@richgannon.net>"
license="GPL-2.0-or-later"
homepage="https://github.com/Mellanox/mstflint"
distfiles="https://github.com/Mellanox/mstflint/releases/download/v${_major}-${_minor}/mstflint-${_major}-${_minor}.tar.gz"
checksum=ede5f897b5a772ef35faa49a94517059510764b3d50df52b267555e17c0c6594

pre_configure() {
	vsed -e "s;\(/usr/include/libxml2\);${XBPS_CROSS_BASE}\1;" \
	 -e "s;\(CURL_INC_DIR=\)\(/usr/include/curl\);\1${XBPS_CROSS_BASE}\2;" \
	 -i configure

	case "$XBPS_TARGET_MACHINE" in
	*-musl)
		export CFLAGS+=" -D_GNU_SOURCE"
		;;
	esac
}

mstflint-devel_package() {
	depends="mstflint-${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/libmstarchive.a
		vmove usr/lib/mstflint/libmtcr_ul.a
	}
}
