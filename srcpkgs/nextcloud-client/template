# Template file for 'nextcloud-client'
pkgname=nextcloud-client
version=3.17.2
revision=1
build_style=cmake
configure_args="-DBUILD_UPDATER=NO -DKDE_INSTALL_QTPLUGINDIR=lib/qt6/plugins"
hostmakedepends="pkg-config inkscape extra-cmake-modules
 qt6-base qt6-tools kf6-kconfig"
makedepends="qt6-base-devel qt6-declarative-devel qt6-qt5compat-devel
 qt6-svg-devel qt6-websockets-devel qt6-plugin-sqlite
 kf6-kio-devel kf6-karchive-devel kf6-kguiaddons-devel qtkeychain-qt6-devel
 openssl-devel libp11-devel zlib-devel sqlite-devel libcloudproviders-devel
 dbus-devel libglib-devel"
checkdepends="cmocka-devel"
conf_files="/etc/Nextcloud/sync-exclude.lst"
short_desc="NextCloud Desktop client"
maintainer="Rodrigo Oliveira <mdkcore@qtrnn.io>"
license="GPL-2.0-or-later"
homepage="https://nextcloud.com/clients/"
changelog="https://github.com/nextcloud/desktop/releases"
distfiles="https://github.com/nextcloud/desktop/archive/v${version}.tar.gz"
checksum=c79c7e05ae3b141e2c4b19da0cde479b63af80eb49164c99af8fa28a38e05aeb
# https://github.com/void-linux/void-packages/pull/33358#discussion_r724518549
make_check=ci-skip
replaces="nextcloud-client-kwallet>=0 nextcloud-client-dolphin>=0"

if [ "$XBPS_TARGET_ENDIAN" = "le" ] &&
   [ "$XBPS_WORDSIZE$XBPS_WORDSIZE" = "64$XBPS_TARGET_WORDSIZE" ]; then
	configure_args+=" -DBUILD_WITH_WEBENGINE=ON"
	makedepends+=" qt6-webengine-devel"
else
	configure_args+=" -DBUILD_WITH_WEBENGINE=OFF"
fi
# argp.h is used only by testing and is not a requirement.
# since unusable (linking fails), let's disable it instead
if [ "$XBPS_TARGET_LIBC" = musl ]; then
	configure_args+=" -DHAVE_ARGP_H=0"
fi

if [ "$XBPS_CHECK_PKGS" ]; then
	configure_args+=" -DUNIT_TESTING=1"
fi

post_install() {
	# nextcloud-client-kwallet
	vbin ${FILESDIR}/kwallet/nextcloud.kwallet
	vmkdir usr/share/applications
	cp build/src/gui/com.nextcloud.desktopclient.nextcloud.desktop \
		build/nextcloud-kwallet.desktop
	vsed -i -e 's,^Exec=.*,Exec=/usr/bin/nextcloud.kwallet,' \
	     -e 's,\(^Name=.*\),\1 - use kwallet,' \
	     -e 's,\(^Comment=.*\),\1 - use kwallet credential storage,' \
	     -e '/^# Translations/,$d' \
	     build/nextcloud-kwallet.desktop
	vinstall build/nextcloud-kwallet.desktop 0644 \
		usr/share/applications/
	vdoc ${FILESDIR}/kwallet/README.voidlinux
}

nextcloud-client-devel_package() {
	depends="nextcloud-client>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/libnextcloudsync.so
	}
}
