# Template file for 'redis'
pkgname=redis
version=6.2.6
revision=1
build_style=gnu-makefile
make_check_target="test"
hostmakedepends="pkg-config"
makedepends="jemalloc-devel libatomic-devel"
checkdepends="which tcl procps-ng"
short_desc="Advanced key-value store"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="BSD-3-Clause"
homepage="https://redis.io"
changelog="https://github.com/redis/redis/releases/tag/${version}"
distfiles="https://github.com/redis/redis/archive/refs/tags/${version}.tar.gz"
checksum=5d452038e346b5f31d7d277a41a4ec583bc8bf04403db620403638f79bdda891

system_accounts="redis"
redis_homedir="/var/lib/redis"
conf_files="/etc/redis/redis.conf"
make_dirs="/var/lib/redis 0700 redis redis"

do_configure() {
	vsed -i \
		-e "s|^# bind 127.0.0.1|bind 127.0.0.1|" \
		-e "s|^dir .*|dir ${redis_homedir}|" \
		-e "s|^pidfile .*|pidfile /run/redis/redis.pid|" redis.conf
	vsed -i -e "s|^FINAL_LIBS=.*|& -latomic|" src/Makefile
}

do_build() {
	case "$XBPS_TARGET_MACHINE" in
		*-musl) _malloc="none";;
		*) _malloc="jemalloc";;
	esac
	make CC=$CC CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" V=1 MALLOC=${_malloc} ${makejobs}
}

do_install() {
	make INSTALL_BIN=${DESTDIR}/usr/bin PREFIX=/usr install
	vlicense COPYING

	vinstall redis.conf 644 etc/redis
	vsv redis
}
