# Template file for 'lua-language-server'
pkgname=lua-language-server
version=git.0
revision=1
wrksrc=${pkgname}
hostmakedepends="ninja git"
depends="lua"
short_desc="Lua Language Server coded by Lua"
maintainer="Gabriel Sanches <gabriel@gsr.dev>"
license="MIT"
homepage="https://github.com/sumneko/lua-language-server"
patch_args=-Np1

do_fetch() {
	git clone https://github.com/sumneko/${pkgname}.git ${wrksrc}
	cd ${wrksrc}
	git submodule update --init --recursive
}

do_build() {
	cd ${wrksrc}/3rd/luamake
	ninja -f ninja/linux.ninja
	cd ../..
	./3rd/luamake/luamake rebuild
}

do_install() {
	vlicense LICENSE

	# main script
	vmkdir usr/lib/${pkgname}
	vcopy "${wrksrc}/bin/Linux/*" usr/lib/${pkgname}

	# entrypoint and files
	vmkdir usr/share/${pkgname}
	for script in main.lua script libs locale platform.lua; do
		vcopy "${wrksrc}/${script}" usr/share/${pkgname}
	done

	vmkdir usr/bin
	sed ${FILESDIR}/wrapper \
		-e "s;@PKGNAME@;$pkgname;g" \
		> ${DESTDIR}/usr/bin/${pkgname}
	chmod 755 ${DESTDIR}/usr/bin/${pkgname}
}
