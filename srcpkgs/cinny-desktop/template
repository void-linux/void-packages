# Template file for 'cinny-desktop'
pkgname=cinny-desktop
version=3.2.1
revision=1
# used for the cargo environment config
build_style=cargo
hostmakedepends="cargo-tauri nodejs pkg-config"
makedepends="dbus-devel gtk+3-devel libayatana-appindicator-devel libsoup-devel openssl-devel webkit2gtk-devel"
depends="libayatana-appindicator"
short_desc="Yet another matrix client for desktop"
maintainer="Marcin Puc <tranzystorek.io@protonmail.com>"
license="AGPL-3.0-or-later"
homepage="https://cinny.in/"
changelog="https://github.com/cinnyapp/cinny/releases"
distfiles="https://github.com/cinnyapp/cinny-desktop/releases/download/v${version}/cinny-desktop-v${version}.zip"
checksum=3f1c71737f274a948ae483ecfa7d30dda54ad24c31271bc044bda7ce35cdd26e

do_build() {
	(
		cd cinny
		npm ci
	)

	cat > cargo-auditable <<'_EOF'
#!/bin/sh
exec cargo auditable --locked "$@"
_EOF
	chmod +x cargo-auditable

	export NODE_OPTIONS=--max_old_space_size=6144
	cargo tauri build --target ${RUST_TARGET} --runner ${PWD}/cargo-auditable --bundles deb
}

do_check() {
	cd src-tauri
	cargo auditable test --release --locked --target ${RUST_TARGET}
}

do_install() {
	local _deb_arch
	case "${XBPS_TARGET_MACHINE}" in
		x86_64*) _deb_arch=amd64 ;;
		i686*) _deb_arch=i386 ;;
		aarch64*) _deb_arch=arm64 ;;
		armv*) _deb_arch=armhf ;;
	esac

	vbin src-tauri/target/${RUST_TARGET}/release/cinny
	vcopy src-tauri/target/${RUST_TARGET}/release/bundle/deb/cinny_${version}_${_deb_arch}/data/usr/share usr/share
	vlicense LICENSE
}
