# Template file for 'dpdk'
pkgname=dpdk
version=19.08
revision=1
archs="x86_64 i686"
build_style=meta
hostmakedepends="cmake meson doxygen python3-Sphinx pkg-config elfutils"
makedepends="libnuma-devel linux-headers jansson-devel libpcap-devel zlib-devel libressl-devel libbsd-devel libelf libmnl"
depends="jansson zlib libbsd libressl"
short_desc="Data Plane Development Kit"
maintainer="Hans-J. Schmid <knock@myopendoor.de>"
license="BSD-3-Clause, GPL-2.0-only"
homepage="https://www.dpdk.org/"
distfiles="https://github.com/DPDK/${pkgname}/archive/v${version}.tar.gz"
checksum=1ceff1a6f4f8d5f6f62c1682097249227ac5225ccd9638e0af09f5411c681038

do_configure() {
	meson --prefix /usr -Denable_kmods=false -Denable_docs=true build
	# meson --prefix /usr build
	# sed -i -e 's:/lib:/usr/lib:' ./kernel/linux/meson.build
}

do_build() {
	ninja -C build
}

do_install() {
	DESTDIR=${DESTDIR} ninja -C build install
}

post_install() {
	vlicense license/bsd-3-clause.txt
	vlicense license/gpl-2.0.txt
}

dpdk-doc_package() {
	short_desc+=" - documentation"
	archs=noarch
	pkg_install() {
		vmove usr/share/doc
	}
}

dpdk-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/dpdk-pdump
		vmove usr/bin/dpdk-proc-info
		vmove usr/bin/dpdk-test*
		vmove usr/include
		vmove usr/lib/*.so
		vmove usr/lib/*.a
		vmove usr/lib/dpdk/pmds-${version}/*.so
		vmove usr/lib/pkgconfig
		vmove usr/share/dpdk/examples
	}
}

dpdk-libs_package() {
	short_desc+=" - runtime libraries"
	pkg_install() {
		vmove usr/lib/*.so.*
		vmove usr/lib/dpdk/pmds-${version}/*.so.*
	}
}

dpdk-igb-uio-dkms_package() {
	short_desc+=" - DKMS igb-uio kernel module"
	dkms_modules="dpdk-igb-uio $version"
	depends="dkms dpdk-devel"
	pkg_install() {
		vmkdir /usr/src/dpdk-igb-uio-${version}
		vcopy "kernel/linux/igb_uio/*" usr/src/dpdk-igb-uio-${version}
		vcopy ${FILESDIR}/dkms_igb_uio.conf usr/src/dpdk-igb-uio-${version}/dkms.conf
		sed -i -e "s/@VERSION@/${version}/" ${PKGDESTDIR}/usr/src/dpdk-igb-uio-${version}/dkms.conf
	}
}

dpdk-rte-kni-dkms_package() {
	short_desc+=" - DKMS rte-kni kernel module"
	dkms_modules="dpdk-rte-kni $version"
	depends="dkms dpdk-devel"
	pkg_install() {
		vmkdir /usr/src/dpdk-rte-kni-${version}
		vcopy "kernel/linux/kni/*" usr/src/dpdk-rte-kni-${version}
		vcopy ${FILESDIR}/dkms_rte_kni.conf usr/src/dpdk-rte-kni-${version}/dkms.conf
		sed -i -e "s/@VERSION@/${version}/" ${PKGDESTDIR}/usr/src/dpdk-rte-kni-${version}/dkms.conf
	}
}
