# Template file for 'marble'
pkgname=marble
version=25.08.3
revision=2
build_style=cmake
configure_args="-DMARBLE_PRI_INSTALL_DIR=/usr/lib/qt6/mkspecs/modules
 -DKDE_INSTALL_QMLDIR=lib/qt6/qml
 -DKDE_INSTALL_QTPLUGINDIR=lib/qt6/plugins"
hostmakedepends="extra-cmake-modules perl gettext protobuf pkg-config
 qt6-base qt6-tools qt6-declarative-host-tools
 kf6-kdoctools kf6-kconfig kf6-kpackage"
makedepends="qt6-base-devel qt6-declarative-devel qt6-svg-devel
 qt6-qt5compat-devel qt6-webchannel-devel qt6-tools-devel
 qt6-position-devel qt6-serialport-devel
 kf6-kcoreaddons-devel kf6-ki18n-devel kf6-kconfig-devel kf6-kcrash-devel
 kf6-kparts-devel kf6-kdoctools-devel kf6-krunner-devel kf6-kpackage-devel
 phonon-devel libplasma-devel
 abseil-cpp-devel protobuf-devel zlib-devel gpsd-devel shapelib-devel"
short_desc="Virtual globe and world atlas"
maintainer="Piotr WÃ³jcik <chocimier@tlen.pl>"
license="LGPL-2.1-or-later, GFDL-1.2-only"
homepage="https://marble.kde.org"
changelog="https://kde.org/announcements/changelogs/gear/${version}/#marble"
distfiles="${KDE_SITE}/release-service/${version}/src/marble-${version}.tar.xz"
checksum=65c034dacc7a2d5bbf534fca6574289e8b1dbf2bd50e4f63ff4d1ab64ff07198
replaces="marble5>=0"

if [ "64$XBPS_TARGET_WORDSIZE" = "$XBPS_WORDSIZE$XBPS_WORDSIZE" ]; then
	makedepends+=" qt6-webengine-devel"
fi

case $XBPS_TARGET_MACHINE in
	# fixes tests
	i686*) CXXFLAGS="-mfpmath=sse -msse2" ;;
esac


post_patch() {
	sed -i 's/Qt6LinguistTools/Qt6Linguist/' MarbleMacros.cmake
	sed -i "s!@@WRKSRC@@!$wrksrc!" tests/CMakeLists.txt
	sed -i tests/CMakeLists.txt -e '
		/MarbleRunnerManagerTest/d
		/MarbleMapTest/d
		/MarbleWidgetTest/d
		/RenderPluginTest/d
		/AbstractDataPluginModelTest/d
		/AbstractDataPluginTest/d
		/AbstractFloatItemTest/d
	'
}

pre_check() {
	mkdir -p $HOME/.local/share/marble
	ln -sf $wrksrc/data "$HOME/.local/share/marble/"
}

marble-devel_package() {
	short_desc+=" - development files"
	depends="${makedepends} ${sourcepkg}>=${version}_${revision}"
	replaces="marble5-devel>=0"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.so"
		vmove usr/lib/cmake
		vmove usr/lib/qt6/mkspecs
	}
}

marble5_package() {
	metapackage=yes
	short_desc+=" - transition"
	depends="marble>=25.08.1_1"
}
