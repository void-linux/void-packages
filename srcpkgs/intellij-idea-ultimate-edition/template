# Template file for 'intellij-idea-ultimate-edition'
pkgname=intellij-idea-ultimate-edition
version=2023.1
revision=1
archs="x86_64"
create_wrksrc="true"
depends="giflib libXtst jetbrains-jdk17"
short_desc="Most intelligent Java IDE"
maintainer="Anton Afanasyev <anton@doubleasoftware.com>"
license="custom:Commercial"
homepage="https://www.jetbrains.com/idea"
_filename="ideaIU-${version}.tar.gz"
distfiles="https://download.jetbrains.com/idea/${_filename}"
checksum=3029c751c36d86fef0021feceb8f3010d37aebd42aef6d6aed9e3b9207c2d2ac
repository=nonfree
restricted=yes
nopie=yes
# JetBrains' tools are self-sufficient and while they include code that appears to be linked to libs from other packages, these libs are either included in the tool package, or the code works by looking for one of several supported libs.
noverifyrdeps=yes
noshlibprovides=yes
python_version=3
nostrip=yes

do_extract() {
	bsdtar xf ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_filename} --strip-components=1 -C .
}

post_extract() {
	# Remove files for other OSes and unsupported CPU architectures.
	rm -rf plugins/android/resources/native/{mac,mac_arm,win}
	rm -rf plugins/cwm-plugin/quiche-native/{darwin-aarch64,darwin-x86-64,linux-aarch64,win32-x86-64}
	rm -rf plugins/Kotlin/bin/{macos,windows}
	rm -rf plugins/Kotlin/kotlinc/*.bat
	rm -rf plugins/maven/lib/maven3/bin/*.cmd
	rm -rf plugins/maven/lib/maven3/lib/jansi-native/{freebsd32,freebsd64,linux32,osx,windows32,windows64}
	rm -rf plugins/webp/lib/libwebp/linux/libwebp_jni.so
}

do_install() {
	TARGET_PATH="usr/lib/${pkgname}"
	LICENSE_PATH="usr/share/licenses/${pkgname}"

	vmkdir usr/bin
	vmkdir ${TARGET_PATH}
	vmkdir ${LICENSE_PATH}

	# Ideally vlicense should be called here, but vcopy is more terse.
	vcopy license/* ${LICENSE_PATH}

	vcopy bin ${TARGET_PATH}
	vcopy help ${TARGET_PATH}
	vcopy lib ${TARGET_PATH}
	vcopy plugins ${TARGET_PATH}
	vcopy product-info.json ${TARGET_PATH}
	vcopy build.txt ${TARGET_PATH}

	ln -sf /${TARGET_PATH}/bin/idea.sh ${DESTDIR}/usr/bin/idea-ultimate
}
