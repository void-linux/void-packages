# Template file for 'nvidia-open-dkms'
pkgname=nvidia-open-dkms
version=580.95.05
revision=1
archs="x86_64"
depends="dkms nvidia"
short_desc="NVIDIA drivers for linux - open DKMS kernel module"
maintainer="JkktBkkt <apkabikov@gmail.com>"
license="GPL-2.0-only, MIT"
homepage="https://github.com/NVIDIA/open-gpu-kernel-modules"
distfiles="https://download.nvidia.com/XFree86/NVIDIA-kernel-module-source/NVIDIA-kernel-module-source-${version}.tar.xz"
checksum=5aa71eb68d54485780e6f56dd59cbabd1d105b6a374110d38dbbbf14ca6a89fb
replaces="nvidia-dkms>=0"
conflicts="nvidia390-dkms>=0 nvidia470-dkms>=0"
dkms_modules="nvidia-open-dkms ${version}"
triggers="dkms initramfs-regenerate"
provides="nvidia-dkms-${version}_${revision}"

do_install() {
	vmkdir usr/src/nvidia-open-dkms-${version}
	vcopy "*" usr/src/nvidia-open-dkms-${version}
	cp ${FILESDIR}/dkms.conf ${DESTDIR}/usr/src/nvidia-open-dkms-${version}/dkms.conf
	vsed -e "s/__PKGVER/${version}/" -i ${DESTDIR}/usr/src/nvidia-open-dkms-${version}/dkms.conf

	# Blacklist nouveau
	vmkdir usr/lib/modprobe.d
	cat <<- END > ${DESTDIR}/usr/lib/modprobe.d/nvidia.conf
		blacklist nouveau
		blacklist nova_core
		blacklist nova_drm
	END
	chmod 644 ${DESTDIR}/usr/lib/modprobe.d/nvidia.conf

	vdoc README.md
	vlicense COPYING
}
