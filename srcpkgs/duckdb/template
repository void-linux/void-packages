# Template file for 'duckdb'
pkgname=duckdb
version=1.4.3
revision=1
archs="x86_64* aarch64*" # 32-bit FTBFS
build_style=cmake
build_helper="python3"
build_wrksrc="${pkgname}-${version}"
configure_args="-DOVERRIDE_GIT_DESCRIBE=v${version}-0-gdeadbeeff
 -DBUILD_EXTENSIONS='autocomplete;icu;json;parquet'"
hostmakedepends="pkg-config cmake ninja python3-build python3-installer python3-scikit-build-core
 python3-pybind11 python3-setuptools_scm"
makedepends="openssl-devel"
short_desc="In-process SQL OLAP database management system"
maintainer="icp <pangolin@vivaldi.net>"
license="MIT"
homepage="https://duckdb.org"
changelog="https://github.com/duckdb/duckdb/releases"
distfiles="https://github.com/duckdb/duckdb/archive/refs/tags/v${version}.tar.gz>duckdb.tar.gz
 https://github.com/duckdb/duckdb-python/archive/refs/tags/v${version}.tar.gz>duckdb-python.tar.gz"
checksum="b6a2afd09d9cf07e50d5cd07077df7f7697b61cca2eb00754f5adf89a1ae6c64
 af6d368ed8f95690fadae958b538f89f697657d88a53159d72e73523619277ff"

_pypkg_wrksrc="${XBPS_BUILDDIR}/duckdb-${version}/duckdb-python-${version}"

case "${XBPS_TARGET_MACHINE}" in
	x86_64*) configure_args+=" -DDUCKDB_EXPLICIT_PLATFORM=linux_amd64" ;;
	aarch64*) configure_args+=" -DDUCKDB_EXPLICIT_PLATFORM=linux_arm64" ;;
esac

post_extract() {
	rmdir "${_pypkg_wrksrc}/external/duckdb"
	cp -a "${wrksrc}/duckdb-${version}" "${_pypkg_wrksrc}/external/duckdb"
	vsed -e "s/pybind11\[global\]/pybind11/g" -i "${_pypkg_wrksrc}/pyproject.toml"
	touch "${_pypkg_wrksrc}/.git"
}

post_build() {
	OVERRIDE_GIT_DESCRIBE="v${version}" CMAKE_EXECUTABLE="${XBPS_MASTERDIR}/usr/bin/cmake" python3 -m build \
		--no-isolation --wheel ${_pypkg_wrksrc}
}

post_install() {
	python3 -m installer --destdir "${DESTDIR}" --no-compile-bytecode \
		${_pypkg_wrksrc}/dist/duckdb-${version}-*-*-*.whl

	vlicense LICENSE
}

duckdb-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
	}
}

python3-duckdb_package() {
	short_desc+=" - python bindings"
	pkg_install() {
		vmove "${py3_sitelib}"
	}
}
