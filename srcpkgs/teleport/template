# Template file for 'teleport'
pkgname=teleport
version=9.3.4
revision=1
_webassets_ref="e53be3321bece0a3a7bbbc25b406d6131243409d"
create_wrksrc=yes
build_style=gnu-makefile
build_heler=go
hostmakedepends="go"
short_desc="Identity aware access proxy"
maintainer="Jan Christian Gr√ºnhage <jan.christian@gruenhage.xyz>"
license="Apache-2.0"
homepage="https://goteleport.com/"
distfiles="https://github.com/gravitational/teleport/archive/refs/tags/v${version}.tar.gz
 https://github.com/gravitational/webassets/archive/${_webassets_ref}.tar.gz"

checksum="4561a069e87ab9e9cededa12b8ba1e7373b8aba47ebf48c6f3c02c8b23a0ccd0
 bc31a5400acfc85e842be98055a764da41a83c385420a8afac19a801f4d609c8"
make_dirs="/var/lib/teleport 755 root root"

do_extract() {
	local f curfile

	mkdir -p "${wrksrc}"
	for f in ${distfiles}; do
		curfile="${f#*>}"
		curfile="${curfile##*/}"
		cp ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${curfile} "${wrksrc}/${curfile}"
	done
}

post_extract() {
	bsdtar -xf "v${version}.tar.gz"
	bsdtar -xf ${_webassets_ref}.tar.gz
	mv webassets-${_webassets_ref}/* teleport-${version}/webassets
	rm v${version}.tar.gz ${_webassets_ref}.tar.gz webassets-${_webassets_ref} -r
	mv teleport-${version}/* .
	rm teleport-${version} -r
}

pre_build() {
	export ADDFLAGS="-buildmode=pie"
}

do_install() {
	vbin build/teleport
}

teleport-client_package() {
	short_desc+=" - client binaries"
	pkg_install() {
		vbin build/tsh
		vbin build/tctl
	}
}
