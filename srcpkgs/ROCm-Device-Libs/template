# Template file for 'ROCm-Device-Libs'
pkgname=ROCm-Device-Libs
version=3.3.0
revision=1
archs="x86_64*"
wrksrc="${pkgname}-rocm-ocl-${version}"
build_style=cmake
configure_args="-DLLVM_DIR:PATH=/usr/lib/rocm-llvm
	-DCMAKE_INSTALL_LIBDIR:PATH=lib/rocm-device-libs"
hostmakedepends="cmake ROCm-llvm"
short_desc="Radeon Open Compute device libraries"
maintainer="Andrew J. Hesford <ajh@sideband.org>"
license="NCSA"
homepage="https://github.com/RadeonOpenCompute/ROCm-Device-Libs"
distfiles="${homepage}/archive/rocm-ocl-${version}.tar.gz"
checksum=706b08230790e08ca6a7a2fb7687d6131fd39a562148340e00fa37a6c06769c5
nocross=yes

pre_configure() {
	# Put bytecodes in a lib/ subdirectory
	vsed -i Packages.cmake -e 's@/lib/@/${CMAKE_INSTALL_LIBDIR}/@'
	vsed -i OCL.cmake -e 's@DESTINATION lib$@DESTINATION ${CMAKE_INSTALL_LIBDIR}@'

	# Build the prepare-builtins executable with native compiler
	mkdir -p utils/build
	cd utils/build
	_prepare_builtins="$PWD/prepare-builtins/prepare-builtins"
	cmake ${configure_args} ..
	make ${makejobs}

	# Add path to prepare-builtins for cmake
	configure_args+=" -DPREPARE_BUILTINS='${_prepare_builtins}'"
}

post_install() {
	vlicense LICENSE
}
