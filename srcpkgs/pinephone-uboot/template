# Template file for 'pinephone-uboot'
pkgname=pinephone-uboot
version=0.0.20220303
revision=1
archs="aarch64*"
create_wrksrc=yes
hostmakedepends="flex cross-or1k-none-elf-gcc dtc python3 python3-devel python3-setuptools bc swig openssl-devel"
depends="u-boot-tools"
conf_files="/etc/default/${pkgname}-config"
short_desc="U-Boot for Pinephone with Crust support"
maintainer="John Sullivan <jsullivan@csumb.edu>"
license="GPL-2.0-only, BSD-3-Clause"
homepage="http://www.denx.de/wiki/U-Boot/WebHome"

_tag_uboot=pinephone-2021-06-22
_ver_armtf=crust-20210410
_ver_crust=0.5

_uboot=u-boot-$_tag_uboot
_armtf=arm-trusted-firmware-$_ver_armtf
_crust=crust-$_ver_crust

distfiles="https://gitlab.com/pine64-org/u-boot/-/archive/${_tag_uboot}/${_uboot}.tar.gz
 https://github.com/crust-firmware/arm-trusted-firmware/archive/${_ver_armtf}.tar.gz
 https://github.com/crust-firmware/crust/archive/v${_ver_crust}.tar.gz"

checksum="e705b99ea8a5b7d41ca41dc9b31cdbeeebbddebbab72daabe7eccdae0e3a2b8d
 43e0f0c8d891937a902072045500dcba6851f2dd679d9cdc4fbc71c46c4dbec4
 8b23b2649bbd19dfb84ae00b2419539b8236c6ae9a380beff7dffafd3f41f31b"

# Note about _cross/_hostcc
#
# The Allwinner A64 has an "embedded controller" of sorts for managing
# peripherals when the A53 cores are turned off. This EC is a custom CPU core
# that uses the OpenRISC 1000 ISA, and it's what the Crust firmware runs
# on. or1k is the gcc platform for OpenRISC, and it has nothing to do with any
# real Void system targets. This is why the two cross-compilers are needed, or1k
# is used ONLY for the crust portion of the firmware.

_or1k="CROSS_COMPILE=or1k-none-elf-"

if [ "$CROSS_BUILD" ]; then
	_cross="CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-"
	_hostcc="HOST_COMPILE=${XBPS_CROSS_TRIPLET}-"
fi

do_configure() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS

	make -C $_crust $_hostcc $_or1k pinephone_defconfig
	make -C $_uboot $_cross pinephone_defconfig
	echo 'CONFIG_IDENT_STRING=" VoidLinux"' >> $_uboot/.config
}

do_build() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS

	make -C $_armtf $_cross PLAT=sun50i_a64 DEBUG=1 $makejobs bl31
	make -C $_crust $_hostcc $_or1k $makejobs scp

	export BL31=$wrksrc/$_armtf/build/sun50i_a64/debug/bl31.bin
	export SCP=$wrksrc/$_crust/build/scp/scp.bin

	make -C $_uboot $_cross $makejobs
}

do_install() {
	vmkdir boot
	vinstall $wrksrc/$_uboot/u-boot-sunxi-with-spl.bin 0644 boot

	vinstall $FILESDIR/uboot.default 0644 etc/default ${pkgname}-config
	vinstall $FILESDIR/kernel.d/uboot 0750 etc/kernel.d/post-install 60-uboot

	cd $wrksrc/$_uboot
	vlicense Licenses/Exceptions
	vlicense Licenses/OFL.txt
	vlicense Licenses/README
	vlicense Licenses/bsd-2-clause.txt
	vlicense Licenses/bsd-3-clause.txt
	vlicense Licenses/eCos-2.0.txt
	vlicense Licenses/gpl-2.0.txt
	vlicense Licenses/ibm-pibs.txt
	vlicense Licenses/isc.txt
	vlicense Licenses/lgpl-2.0.txt
	vlicense Licenses/lgpl-2.1.txt
	vlicense Licenses/r8a779x_usb3.txt
	vlicense Licenses/x11.txt
}
