# Template file for 'mesa'
pkgname=mesa
version=25.3.3
revision=1
build_style=meson
build_helper="qemu"
_llvmver=21
#Disable LTO flag should be present, see https://gitlab.freedesktop.org/mesa/mesa/-/issues/6911
configure_args="-Dglvnd=enabled -Dgbm=enabled -Degl=enabled -Dlibunwind=disabled
 -Dgles1=enabled -Dgles2=enabled -Dglx=dri
 -Dlmsensors=enabled -Dplatforms=x11$(vopt_if wayland ,wayland)
 -Dllvm=enabled -Db_lto=false -Dcpp_std=gnu++17"
hostmakedepends="gettext flex pkg-config python3-Mako glslang llvm${_llvmver}
 $(vopt_if wayland 'wayland-protocols wayland-devel') python3-pycparser python3-yaml"
makedepends="elfutils-devel expat-devel libXdamage-devel
 libXxf86vm-devel libdrm-devel libffi-devel libva-devel libdisplay-info
 libxshmfence-devel ncurses-devel zlib-devel
 $(vopt_if wayland 'wayland-devel wayland-protocols') llvm${_llvmver}-devel libsensors-devel
 libXrandr-devel libglvnd-devel libzstd-devel libxml2-devel lua54-devel
 libarchive-devel libXext-devel libpng-devel"
depends="libglvnd"
short_desc="Open source implementation of OpenGL and Vulkan"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT, LGPL-2.1-or-later"
homepage="https://www.mesa3d.org/"
changelog="https://docs.mesa3d.org/relnotes.html"
distfiles="https://mesa3d.org/archive/mesa-${version}.tar.xz"
checksum=05328b3891c000e6a110a3e7321d8bfbb21631d132bf86bd3d4a8f45c535ef6b

# XXX: use `common/scripts/gen-wrap-distfiles.py masterdir-*/builddir/mesa-*/subprojects/*-rs.wrap` to generate
# BEGIN GENERATED
distfiles+="
 https://crates.io/api/v1/crates/bitflags/2.9.1/download>bitflags-2.9.1.tar.gz
 https://crates.io/api/v1/crates/cfg-if/1.0.0/download>cfg-if-1.0.0.tar.gz
 https://crates.io/api/v1/crates/equivalent/1.0.1/download>equivalent-1.0.1.tar.gz
 https://crates.io/api/v1/crates/errno/0.3.12/download>errno-0.3.12.tar.gz
 https://crates.io/api/v1/crates/hashbrown/0.14.1/download>hashbrown-0.14.1.tar.gz
 https://crates.io/api/v1/crates/indexmap/2.2.6/download>indexmap-2.2.6.tar.gz
 https://crates.io/api/v1/crates/libc/0.2.168/download>libc-0.2.168.tar.gz
 https://crates.io/api/v1/crates/log/0.4.27/download>log-0.4.27.tar.gz
 https://crates.io/api/v1/crates/once_cell/1.8.0/download>once_cell-1.8.0.tar.gz
 https://crates.io/api/v1/crates/paste/1.0.14/download>paste-1.0.14.tar.gz
 https://crates.io/api/v1/crates/pest/2.8.0/download>pest-2.8.0.tar.gz
 https://crates.io/api/v1/crates/pest_derive/2.8.0/download>pest_derive-2.8.0.tar.gz
 https://crates.io/api/v1/crates/pest_generator/2.8.0/download>pest_generator-2.8.0.tar.gz
 https://crates.io/api/v1/crates/pest_meta/2.8.0/download>pest_meta-2.8.0.tar.gz
 https://crates.io/api/v1/crates/proc-macro2/1.0.86/download>proc-macro2-1.0.86.tar.gz
 https://crates.io/api/v1/crates/quote/1.0.35/download>quote-1.0.35.tar.gz
 https://crates.io/api/v1/crates/remain/0.2.12/download>remain-0.2.12.tar.gz
 https://crates.io/api/v1/crates/roxmltree/0.20.0/download>roxmltree-0.20.0.tar.gz
 https://crates.io/api/v1/crates/rustc-hash/2.1.1/download>rustc-hash-2.1.1.tar.gz
 https://crates.io/api/v1/crates/rustix/1.0.7/download>rustix-1.0.7.tar.gz
 https://crates.io/api/v1/crates/syn/2.0.87/download>syn-2.0.87.tar.gz
 https://crates.io/api/v1/crates/thiserror/2.0.11/download>thiserror-2.0.11.tar.gz
 https://crates.io/api/v1/crates/thiserror-impl/2.0.11/download>thiserror-impl-2.0.11.tar.gz
 https://crates.io/api/v1/crates/ucd-trie/0.1.6/download>ucd-trie-0.1.6.tar.gz
 https://crates.io/api/v1/crates/unicode-ident/1.0.12/download>unicode-ident-1.0.12.tar.gz
 https://crates.io/api/v1/crates/zerocopy/0.8.13/download>zerocopy-0.8.13.tar.gz
 https://crates.io/api/v1/crates/zerocopy-derive/0.8.13/download>zerocopy-derive-0.8.13.tar.gz
"
checksum+="
 1b8e56985ec62d17e9c1001dc89c88ecd7dc08e47eba5ec7c29c7b5eeecde967
 baf1de4339761588bc0619e3cbc0120ee582ebb74b53b4efbf79117bd2da40fd
 5443807d6dff69373d433ab9ef5378ad8df50ca6298caf15de6e52e24aaf54d5
 cea14ef9355e3beab063703aa9dab15afd25f0667c341310c1e5274bb1d0da18
 7dfda62a12f55daeae5015f81b0baea145391cb4520f86c248fc615d72640d12
 168fb715dda47215e360912c096649d23d58bf392ac62f73919e831745e40f26
 5aaeb2981e0606ca11d79718f8bb01164f1d6ed75080182d3abf017e6d244b6d
 13dc2df351e3202783a1fe0d44375f7295ffb4049267b0f3018346dc122a1d94
 692fcb63b64b1758029e0a96ee63e049ce8c5948587f2f7208df04625e5f6b56
 de3145af08024dea9fa9914f381a17b8fc6034dfb00f3a84013f7ff43f29ed4c
 198db74531d58c70a361c42201efde7e2591e976d518caf7662a47dc5720e7b6
 d725d9cfd79e87dccc9341a2ef39d1b6f6353d68c4b33c177febbe1a402c97c5
 db7d01726be8ab66ab32f9df467ae8b1148906685bbe75c82d1e65d7f5b3f841
 7f9f832470494906d1fca5329f8ab5791cc60beb230c74815dff541cbd2b5ca0
 5e719e8df665df0d1c8fbfd238015744736151d4445ec0836b8e628aae103b77
 291ec9ab5efd934aaf503a6466c5d5251535d108ee747472c3977cc5acc868ef
 1ad5e011230cad274d0532460c5ab69828ea47ae75681b42a841663efffaf794
 6c20b6793b5c2fa6553b250154b78d6d0db37e72700ae35fad9387a46f487c97
 357703d41365b4b27c590e3ed91eabb1b663f07c4c084095e60cbed4362dff0d
 c71e83d6afe7ff64890ec6b71d6a69bb8a610ab78ce364b3352876bb4c801266
 25aa4ce346d03a6dcd68dd8b4010bcb74e54e62c90c573f394c46eae99aba32d
 d452f284b73e6d76dd36758a0c8684b1d5be31f92b89d07fd5822175732206fc
 26afc1baea8a989337eeb52b6e72a039780ce45c3edfcc9c5b9d112feeb173c2
 ed646292ffc8188ef8ea4d1e0e0150fb15a5c2e12ad9b8fc191ae7a8a7f3c4b9
 3354b9ac3fae1ff6755cb6db53683adb661634f67557942dea4facebec0fee4b
 67914ab451f3bfd2e69e5e9d2ef3858484e7074d63f204fd166ec391b54de21d
 7988d73a4303ca289df03316bc490e934accf371af6bc745393cf3c2c5c4f25d
"
skip_extraction+="
 bitflags-2.9.1.tar.gz
 cfg-if-1.0.0.tar.gz
 equivalent-1.0.1.tar.gz
 errno-0.3.12.tar.gz
 hashbrown-0.14.1.tar.gz
 indexmap-2.2.6.tar.gz
 libc-0.2.168.tar.gz
 log-0.4.27.tar.gz
 once_cell-1.8.0.tar.gz
 paste-1.0.14.tar.gz
 pest-2.8.0.tar.gz
 pest_derive-2.8.0.tar.gz
 pest_generator-2.8.0.tar.gz
 pest_meta-2.8.0.tar.gz
 proc-macro2-1.0.86.tar.gz
 quote-1.0.35.tar.gz
 remain-0.2.12.tar.gz
 roxmltree-0.20.0.tar.gz
 rustc-hash-2.1.1.tar.gz
 rustix-1.0.7.tar.gz
 syn-2.0.87.tar.gz
 thiserror-2.0.11.tar.gz
 thiserror-impl-2.0.11.tar.gz
 ucd-trie-0.1.6.tar.gz
 unicode-ident-1.0.12.tar.gz
 zerocopy-0.8.13.tar.gz
 zerocopy-derive-0.8.13.tar.gz
"
# END GENERATED

build_options="wayland"
build_options_default="wayland"

# only use llvmpipe on targets where it's supported and reliable
# especially on big endian it's all kinds of broken, and e.g. on
# 32-bit powerpc it does not work at all, so fall back to softpipe
case "$XBPS_TARGET_MACHINE" in
	i686*|x86_64*|aarch64*|ppc64le*|arm*|riscv64*)
		_have_llvmpipe=yes
		;;
esac

# Set subpackages manually to set proper rdeps in 32bit pkgs.
subpackages="mesa-libgallium libgbm libgbm-devel"

# Replace old mesa pkgs, superseded by libglvnd.
replaces="libGL>=10_1<19.2.5_2 libEGL>=10_1<19.2.5_2 libGLES>=10_1<19.2.5_2"

# Driver configuration
# Check for correctness on major mesa version updates
# Particularly, check if any new worthwhile drivers were added

# softpipe always present
_gallium_drivers=" -Dgallium-drivers=softpipe"
_vulkan_drivers=" -Dvulkan-drivers="

# amd and nvidia drivers on all platforms except where it makes no sense
# amd implicitly enables clover opencl, also enable hwdec and virgl too
case "$XBPS_TARGET_MACHINE" in
	armv5*|mips*) ;;
	*)
		_have_nv=yes
		_have_amd=yes
		_have_hwdec=yes
		_have_virgl=yes
		;;
esac

# x86 additionally gets intel, vmware and gallium nine
# arm gets its own drivers (for mali, tegra etc.)
case "$XBPS_TARGET_MACHINE" in
	i686*|x86_64*)
		_have_intel=yes
		_have_vmware=yes
		;;
	armv[67]*|aarch64*)
		_have_arm=yes
		;;
esac

# Direct3D 12 for Hyper-V GPU-P / WSLg. This relies on additional
# closed-source drivers which are only available on 64-bit glibc.
case "$XBPS_TARGET_MACHINE" in
	aarch64|x86_64)
		_have_d3d12=yes
		;;
esac

if [ "$_have_llvmpipe" ]; then
	subpackages+=" mesa-vulkan-lavapipe"
	_vulkan_drivers+=",swrast"
	# note: swrast IS valid for vulkan drivers still, not gallium
else
	configure_args+=" -Ddraw-use-llvm=false"
fi

if [ "$_have_amd" ]; then
	# amd cards can use clover
	_have_opencl=yes
	_have_vulkan=yes
	_gallium_drivers+=",r300,r600,radeonsi"
	_vulkan_drivers+=",amd"
	subpackages+=" mesa-vulkan-radeon"
	# transitional dummy packages
	subpackages+=" mesa-ati-dri"
	configure_args+=" -Dvideo-codecs=all"
fi

if [ "$_have_intel" ]; then
	_have_vulkan=yes
	_gallium_drivers+=",crocus,iris,i915"
	_vulkan_drivers+=",intel,intel_hasvk"
	subpackages+=" mesa-vulkan-intel"
	# transitional dummy packages
	subpackages+=" mesa-intel-dri"

	case "$XBPS_TARGET_MACHINE" in
	x86_64*) configure_args+=" -Dintel-rt=enabled" ;;
	esac
fi

if [ "$_have_nv" ]; then
	_gallium_drivers+=",nouveau"
	if [ "$_have_arm" ]; then
		_gallium_drivers+=",tegra"
		# transitional dummy packages
		subpackages+=" mesa-tegra-dri"
	fi
	_vulkan_drivers+=",nouveau"
	hostmakedepends+=" cbindgen"
	subpackages+=" mesa-vulkan-nouveau"
	# transitional dummy packages
	subpackages+=" mesa-nouveau-dri"
fi

if [ "$_have_arm" ]; then
	_have_vulkan=yes
	_have_opencl=yes
	_gallium_drivers+=",v3d,vc4,freedreno,etnaviv,lima,panfrost,asahi"
	_vulkan_drivers+=",broadcom,freedreno,panfrost,asahi"
	subpackages+=" mesa-vulkan-broadcom mesa-vulkan-freedreno mesa-vulkan-panfrost"
	# transitional dummy packages
	subpackages+=" mesa-kmsro-dri mesa-v3d-dri mesa-vc4-dri"
	subpackages+=" mesa-etnaviv-dri mesa-freedreno-dri"
	subpackages+=" mesa-lima-dri mesa-panfrost-dri"
fi

if [ "$_have_virgl" ]; then
	_gallium_drivers+=",virgl"
	_vulkan_drivers+=",virtio"
fi

if [ "$_have_vmware" ]; then
	_gallium_drivers+=",svga"
	# transitional dummy packages
	subpackages+=" mesa-vmwgfx-dri"
fi

# enabled currently by amd drivers
if [ "$_have_opencl" ]; then
	hostmakedepends+=" clang${_llvmver} rust rust-bindgen"
	makedepends+=" clang${_llvmver} libclc${_llvmver} rust
	 SPIRV-LLVM-Translator${_llvmver}-devel SPIRV-Tools-devel"
	subpackages+=" mesa-opencl"
	configure_args+=" -Dgallium-rusticl=true -Drust_std=2021"
fi

if [ "$_have_hwdec" ]; then
	configure_args+=" -Dgallium-va=enabled"
	subpackages+=" mesa-vaapi"
else
	configure_args+=" -Dgallium-va=disabled"
fi

if [ "$_have_d3d12" ]; then
	_gallium_drivers+=",d3d12"
	makedepends+=" DirectX-Headers"
fi

# empty values introduced by leading comma are not allowed; the whole enumeration can be empty
# _gallium_drivers is not affected by this problem
_vulkan_drivers=${_vulkan_drivers/=,/=}

configure_args+=" ${_vulkan_drivers}"

if [ "$_have_vulkan" ]; then
	_have_zink=yes
	configure_args+=" -Dvulkan-layers=device-select,overlay,screenshot,vram-report-limit,anti-lag"
	if [ "$_have_intel" ]; then
		configure_args+=",intel-nullhw"
	fi
	subpackages+=" mesa-vulkan-overlay-layer"
fi

if [ "$_have_zink" ]; then
	_gallium_drivers+=",zink"
	makedepends+=" vulkan-loader-devel"
fi

configure_args+=" ${_gallium_drivers}"

# must be the last one for proper order
subpackages+=" mesa-dri MesaLib-devel"

case "$XBPS_TARGET_MACHINE" in
	ppc64le*) configure_args+=" -Dpower8=true" ;;
	ppc*) configure_args+=" -Dpower8=false" ;;
esac

post_configure() {
	if [ "$CROSS_BUILD" ]; then
		find -iname "*.ninja" -exec sed -i "{}" \
			-e "/rustc/s; --sysroot ${XBPS_CROSS_BASE}/usr;;g" \
			-e "s|-isystem/usr/include||g" \
		\;
	fi
}

post_install() {
	vlicense docs/license.rst

	# ensure that each eligible architecture ships its multilib icd files
	# in some cases, multiple counterpart architectures may exist (aarch64)
	# this allows us to not have to ship these files in the current *-32bit packages
	local arch=${XBPS_TARGET_MACHINE%-*}
	local oarchs
	local olibdir="/usr/lib32/"
	local owordsize=32
	if [ "$XBPS_TARGET_WORDSIZE" = "32" ]; then
		olibdir="/usr/lib64/"
		owordsize=64
	fi
	case "${arch}" in
		aarch64) oarchs="armv6l armv7l";;
		armv[67]l) oarchs="aarch64";;
		x86_64) oarchs="i686";;
		i686) oarchs="x86_64";;
		ppc64le) oarchs="ppcle";;
		ppc64) oarchs="ppc";;
		ppcle) oarchs="ppc64le";;
		ppc) oarchs="ppc64";;
		riscv64) oarchs="riscv64";;
		*) ;; # no counterparts
	esac
	for oarch in $oarchs; do
		for icd in ${DESTDIR}/usr/share/vulkan/icd.d/*_icd.${arch}.json; do
			sed "s#/usr/lib${XBPS_TARGET_WORDSIZE}/#${olibdir}#g; /library_arch/ s/${XBPS_TARGET_WORDSIZE}/${owordsize}/" \
				${icd} > ${icd/.${arch}/.${oarch}}
		done
	done
}

mesa-libgallium_package() {
	short_desc="Mesa internal shared platform for building graphics drivers"
	pkg_install() {
		vmove "usr/lib/libgallium-*.so"
	}
}

libgbm_package() {
	short_desc="Mesa Generic buffer management API - runtime"
	pkg_install() {
		vmove "usr/lib/libgbm.so.*"
	}
}

libgbm-devel_package() {
	short_desc="Mesa Generic buffer management API - development files"
	depends="libgbm>=${version}_${revision}"
	pkg_install() {
		vmove usr/include/gbm.h
		vmove usr/lib/libgbm.so
		vmove usr/lib/pkgconfig/gbm.pc
	}
}

MesaLib-devel_package() {
	depends="mesa>=${version}_${revision} libgbm-devel>=${version}_${revision}"
	if [ "$_have_opencl" ]; then
		depends+=" mesa-opencl>=${version}_${revision}"
	fi
	depends+=" libdrm-devel libglvnd-devel"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/libEGL_mesa.so
		vmove usr/lib/libGLX_mesa.so
		if [ "$_have_opencl" ]; then
			vmove usr/lib/libRusticlOpenCL.so
		fi
	}
}

mesa-opencl_package() {
	short_desc="Mesa implementation of OpenCL (r600+ only)"
	depends="libclc${_llvmver}"
	pkg_install() {
		vmove etc/OpenCL
		vmove "usr/lib/libRusticlOpenCL.so.*"
	}
}

mesa-dri_package() {
	short_desc="Mesa DRI drivers"
	depends="mesa-${version}_${revision}"
	shlib_provides="libgallium_dri.so" # workaround for mesa-dri-32bit
	pkg_install() {
		vmove usr/lib/dri
	}
}

mesa-vaapi_package() {
	short_desc="Mesa VA-API drivers"
	shlib_provides="libgallium_drv_video.so" # workaround for mesa-vaapi-32bit
	pkg_install() {
		vmove "usr/lib/dri/*_drv_video.so"
	}
}

mesa-vulkan-intel_package() {
	short_desc="Mesa Intel Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/intel*.json"
		vmove "usr/lib/libvulkan_intel*.so"
	}
}

mesa-vulkan-nouveau_package() {
	short_desc="Mesa Nouveau Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/nouveau*.json"
		vmove "usr/lib/libvulkan_nouveau*.so"
	}
}

mesa-vulkan-radeon_package() {
	short_desc="Mesa Radeon Vulkan driver"
	pkg_install() {
		vmove "usr/share/drirc.d/00-radv-defaults.conf"
		vmove "usr/share/vulkan/icd.d/radeon_icd*.json"
		vmove "usr/lib/libvulkan_radeon.so"
	}
}

mesa-vulkan-broadcom_package() {
	short_desc="Mesa Broadcom Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/broadcom_icd*.json"
		vmove "usr/lib/libvulkan_broadcom.so"
	}
}

mesa-vulkan-freedreno_package() {
	short_desc="Mesa Freedreno Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/freedreno_icd*.json"
		vmove "usr/lib/libvulkan_freedreno.so"
	}
}

mesa-vulkan-panfrost_package() {
	short_desc="Mesa Panfrost Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/panfrost_icd*.json"
		vmove "usr/lib/libvulkan_panfrost.so"
	}
}

mesa-vulkan-lavapipe_package() {
	short_desc="Mesa Lavapipe Vulkan driver"
	pkg_install() {
		vmove "usr/share/vulkan/icd.d/lvp_icd*.json"
		vmove "usr/lib/libvulkan_lvp*.so"
	}
}

mesa-vulkan-overlay-layer_package() {
	short_desc="Vulkan layer to display information about the running application"
	pkg_install() {
		vmove "usr/share/vulkan/explicit_layer.d/VkLayer_*.json"
		vmove "usr/share/vulkan/implicit_layer.d/VkLayer_*.json"
		vmove "usr/bin/mesa-overlay-control.py"
		vmove "usr/lib/libVkLayer_*.so"
	}
}

mesa-ati-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for ATI GPUs (transitional dummy package)"
	depends="mesa-dri mesa-vulkan-radeon"
	if [ "$_have_hwdec" ]; then
		depends+=" mesa-vaapi"
	fi
}

mesa-etnaviv-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Vivante GPUs (transitional dummy package)"
	depends="mesa-dri"
}

mesa-freedreno-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Adreno GPUs (transitional dummy package)"
	depends="mesa-dri"
}

mesa-intel-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Intel GPUs (transitional dummy package)"
	depends="mesa-dri mesa-vulkan-intel"
}

mesa-kmsro-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="KMS Render-only Mesa DRI drivers (transitional dummy package)"
	depends="mesa-dri"
}

mesa-lima-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Mali GPUs (Utgard) (transitional dummy package)"
	depends="mesa-dri"
}

mesa-nouveau-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for NVIDIA GPUs (transitional dummy package)"
	depends="mesa-dri"
	if [ "$_have_hwdec" ]; then
		depends+=" mesa-vaapi mesa-vulkan-nouveau"
	fi
}

mesa-panfrost-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Mali GPUs (Midgard/Bifrost) (dummy package)"
	depends="mesa-dri"
}

mesa-tegra-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Tegra GPU (transitional dummy package)"
	depends="mesa-dri"
}

mesa-v3d-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Videocore VI GPU (transitional dummy package)"
	depends="mesa-dri"
}

mesa-vmwgfx-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for VMware (transitional dummy package)"
	depends="mesa-dri"
}

mesa-vc4-dri_package() {
	metapackage=yes
	lib32mode=full
	short_desc="Mesa DRI drivers for Videocore IV GPU (transitional dummy package)"
	depends="mesa-dri"
}
