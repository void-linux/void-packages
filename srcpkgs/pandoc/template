# Template file for 'pandoc'
pkgname=pandoc
# Keep in sync with http://www.stackage.org/lts
version=2.19.2
revision=1
_sidenote_version=0.22.1.0
_monad_gen_version=0.3.0.1
_crossref_version=0.3.14.0
create_wrksrc=yes
build_style=haskell-stack
stackage="lts-20.0"
make_build_args="
 --flag pandoc:embed_data_files
 --flag=lua:pkg-config"
hostmakedepends="pkg-config unzip wget"
makedepends="zlib-devel lua54-devel tar"
short_desc="Universal converter between markup formats"
maintainer="slotThe <soliditsallgood@mailbox.org>"
license="GPL-2.0-or-later, BSD-3-Clause"
homepage="http://johnmacfarlane.net/pandoc/"
distfiles="https://hackage.haskell.org/package/${pkgname}-${version}/${pkgname}-${version}.tar.gz
 https://hackage.haskell.org/package/${pkgname}-sidenote-${_sidenote_version}/${pkgname}-sidenote-${_sidenote_version}.tar.gz
 https://hackage.haskell.org/package/monad-gen-${_monad_gen_version}/monad-gen-${_monad_gen_version}.tar.gz
 https://hackage.haskell.org/package/${pkgname}-crossref-${_crossref_version}/${pkgname}-crossref-${_crossref_version}.tar.gz"
checksum="36e83694c36a5af35a4442c4d5abd4273289d9d309793466f59c1632e87d4245
 c39dd7343b9cb4dc5b1c91c9e47c3d357874e9e1a30b8d377bbea0b1d50323b2
 be8485023fce236b5b915f2f6074f7b0470a2040f84cdd137c5227f1b4c98465
 06d163e2cec3f285919295c41a0580f203bb157d05eb06a494dbc093cbefa5b8"
subpackages="
 pandoc-sidenote
 pandoc-crossref"
nocross=yes
nopie_files="
 /usr/bin/pandoc
 /usr/bin/pandoc-sidenote
 /usr/bin/pandoc-crossref"

post_extract() {
	sed -i 's/tasty .*,/tasty,/' pandoc-*/pandoc.cabal
	sed -i 's/zip-archive .*,/zip-archive,/' pandoc-*/pandoc.cabal
	# See https://github.com/lierdakil/pandoc-crossref/issues/342#issuecomment-1073256586
	cp "${FILESDIR}/pandoc-crossref.cabal" pandoc-crossref-${_crossref_version}
}

post_install() {
	vman pandoc-${version}/man/pandoc.1
	vlicense pandoc-${version}/COPYRIGHT LICENSE
}

# pandoc filters should be built with pandoc to ensure compatibility and speed up compiliation
pandoc-sidenote_package() {
	depends="pandoc-${version}_${revision}"
	short_desc="Pandoc filter to convert Markdown-style footnotes into sidenotes"
	short_desc+=" - version ${_sidenote_version}"
	license="MIT"
	pkg_install() {
		vmove usr/bin/pandoc-sidenote
		vlicense pandoc-sidenote-${_sidenote_version}/LICENSE
	}
}

pandoc-crossref_package() {
	depends="pandoc-${version}_${revision}"
	short_desc="Pandoc filter for cross-references"
	short_desc+=" - version ${_crossref_version}"
	license="GPL-2.0-or-later"
	pkg_install() {
		vmove usr/bin/pandoc-crossref
		$DESTDIR/usr/bin/pandoc -s -t man pandoc-crossref-${_crossref_version}/docs/index.md -o pandoc-crossref-${_crossref_version}/docs/pandoc-crossref.1
		vman pandoc-crossref-${_crossref_version}/docs/pandoc-crossref.1
	}
}
