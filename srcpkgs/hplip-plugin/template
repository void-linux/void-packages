# Template file for 'hplip-plugin'
# Must be in sync with main hplip package
pkgname=hplip-plugin
version=3.22.6
revision=1
archs="i686 x86_64 armv[67] aarch64"
hostmakedepends="tar"
short_desc="Binary plugin for HPs hplip printer driver library"
maintainer="biopsin <biopsin@teknik.io>"
license="custom:proprietary"
homepage="https://developers.hp.com/hp-linux-imaging-and-printing/binary_plugin.html"
changelog="https://developers.hp.com/hp-linux-imaging-and-printing/release_notes"
distfiles="https://developers.hp.com/sites/default/files/hplip-${version}-plugin.run"
checksum=3124023e749754bad74b59cf208be5531d31b216f25343a5a5f2ce82164c82fb
repository=nonfree
restricted=yes

ignore_elf_dirs="/usr/share/hplip"

do_extract() {
	/bin/sh ${XBPS_SRCDISTDIR}/${pkgname}-${version}/hplip-${version}-plugin.run \
		--noexec --target ${wrksrc}
}

do_install() {
	vmkdir usr/share/hplip/data/firmware
	vmkdir usr/share/hplip/fax/plugins
	vmkdir usr/share/hplip/prnt/plugins
	vmkdir usr/share/hplip/scan/plugins
	vmkdir usr/share/licenses/hplip-plugin
	vmkdir var/lib/hp

	if [ $XBPS_TARGET_MACHINE = "i686" ]; then
		_arch='x86_32'
	elif [ $XBPS_TARGET_MACHINE = "x86_64" ]; then
		_arch='x86_64'
	elif [ $XBPS_TARGET_MACHINE = "armv[67]" ]; then
		_arch='arm32'
	elif [ $XBPS_TARGET_MACHINE = "aarch64" ]; then
		_arch='arm64'
	fi

	vcopy plugin.spec usr/share/hplip/
	vcopy hp_laserjet_*.fw.gz usr/share/hplip/data/firmware/
	vcopy fax_marvell-"$_arch".so usr/share/hplip/fax/plugins/
	vcopy hbpl1-"$_arch".so usr/share/hplip/prnt/plugins/
	vcopy lj-"$_arch".so usr/share/hplip/prnt/plugins/
	vcopy bb_*-"$_arch".so usr/share/hplip/scan/plugins/
	vlicense license.txt

	cat << EOF > hplip.state
[plugin]
installed = 1
eula = 1
version = ${version}
EOF
	vcopy hplip.state var/lib/hp

	find "${DESTDIR}/usr/share/hplip" -type f -name "*.so" | while read f; do
		lib_dir="${f%/*}"
		lib_name="${f##*/}"
		ln -sf "$lib_name" "$lib_dir/${lib_name%%-*}.so"
	done
}
