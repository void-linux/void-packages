# Template file for 'shadow'
pkgname=shadow
version=4.17.4
revision=1
build_style=gnu-configure
configure_args="--bindir=/usr/bin --sbindir=/usr/bin
 --enable-shared --disable-static
 --with-libpam --without-selinux --with-acl --with-attr --without-su
 --disable-nls --enable-subordinate-ids --disable-account-tools-setuid
 --with-group-name-max-length=32
 --libdir=/usr/lib --enable-lastlog --with-yescrypt --without-bcrypt
 --without-libbsd --without-nscd"
hostmakedepends="libtool pkg-config"
makedepends="acl-devel pam-devel"
depends="pam"
short_desc="Shadow password file utilities"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="BSD-3-Clause"
homepage="https://github.com/shadow-maint/shadow"
distfiles="${homepage}/releases/download/${version}/shadow-${version}.tar.xz"
checksum=554801054694ff7d8a7abdf0d6ece34e2f16e111673cc01b8c9ee1278451181e
conf_files="/etc/pam.d/* /etc/default/useradd /etc/login.defs"

if [ "$XBPS_TARGET_LIBC" = "glibc" ]; then
	makedepends+=" libxcrypt-devel"
fi

post_install() {
	make -C man DESTDIR="$DESTDIR" install-man
	mv ${DESTDIR}/usr/sbin/* ${DESTDIR}/usr/bin

	# Install our pam files not the ones supplied with shadow.
	rm -f ${DESTDIR}/etc/pam.d/*
	for f in chage passwd; do
		vinstall ${FILESDIR}/${f}.pam 644 etc/pam.d ${f}
	done
	for f in chpasswd chgpasswd groupadd groupdel groupmems \
		 groupmod newusers useradd userdel usermod; do
		vinstall $DESTDIR/etc/pam.d/chage 644 etc/pam.d ${f}
	done

	vinstall ${FILESDIR}/login.defs 644 etc
	vinstall ${FILESDIR}/default.useradd 644 etc/default useradd
	vinstall ${FILESDIR}/shadow.cron-daily 744 etc/cron.daily shadow

	# Remove utilities provided by util-linux and logoutd.
	mv ${DESTDIR}/usr/bin/{newgrp,sg}

	rm \
		$DESTDIR/usr/bin/{login,chsh,chfn} \
		$DESTDIR/usr/bin/{nologin,logoutd,vipw,vigr}

	# ...and their many man pages
	find $DESTDIR/usr/share/man \
		'(' -name 'chsh.1'  -o \
		-name 'chfn.1'  -o \
		-name 'su.1'    -o \
		-name 'login.1' -o \
		-name 'vipw.8'  -o \
		-name 'vigr.8'  -o \
		-name 'logoutd.8' -o \
		-name 'nologin.8' -o \
		-name 'newgrp.1' ')' \
		-delete

	vlicense $FILESDIR/LICENSE
}
