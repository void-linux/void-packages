# Template file for 'libdpp'
pkgname=libdpp
version=10.0.10
revision=1
wrksrc=DPP-${version}
build_style=cmake
cmake_builddir=build
hostmakedepends="pkg-config git"
makedepends="libsodium-devel opus-devel zlib-devel openssl-devel fmt-devel json-c++"
short_desc="C++ Discord API Library for Bots"
maintainer="Bo-Ru Ju <school.shsps@gmail.com>"
license=Apache-2.0
homepage="https://dpp.dev"
distfiles="https://github.com/brainboxdotcc/DPP/archive/refs/tags/v${version}.tar.gz"
checksum=2a1c26f606298e5b683d1e140219c434e61c4b22e8510fa2a2d5f7b6758dff95

post_extract() {
	git apply ${FILESDIR}/fix-headers-and-cmakefiles
	mv "${wrksrc}/cmake/libdpp-config.cmake" "${wrksrc}/cmake/dpp-config.cmake"
	rm -r include/dpp/fmt
	rm -r include/dpp/nlohmann
}

libdpp-devel_package() {
	depends="${makedepends} ${sourcepkg}-${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/lib/pkgconfig
		vmove usr/include
		vmkdir usr/lib/cmake/dpp
		find "${DESTDIR}/usr/lib" -iname "*.cmake" | while read file; do vinstall "$file" 644 "usr/lib/cmake/dpp"; done
		vcopy ${FILESDIR}/fix-installed-cmakefiles usr/lib/cmake
		patch -d${PKGDESTDIR} -i ${PKGDESTDIR}/usr/lib/cmake/fix-installed-cmakefiles -p0
		rm ${PKGDESTDIR}/usr/lib/cmake/fix-installed-cmakefiles
		mv ${PKGDESTDIR}/usr/lib/cmake/dpp_patch ${PKGDESTDIR}/usr/lib/cmake/dpp
		vmove "usr/lib/*.so"
	}
}
