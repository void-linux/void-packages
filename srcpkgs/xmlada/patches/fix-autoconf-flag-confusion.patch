From a8be28e067456dc2c700719d09ab08e20fccc0ea Mon Sep 17 00:00:00 2001
From: "Estevan Castilho (Tevo)" <estevan.cps@gmail.com>
Date: Fri, 20 Dec 2024 00:05:37 +0000
Subject: [PATCH] Fix Autoconf cross-compilation flag confusion

Previously, we used the --host and --target arguments of the configure
script to mean the build machine and the machine the package will run
on, mirroring GPRBuild's own usage of the terminology. By convention,
however, autoconf scripts usually take --build to mean the build
machine, --host to mean the machine the package will run on and
--target to mean the target of the toolchain being configured (if
relevant). Our non-standard usage tends to cause problems with some
distribution's packaging machinery (such as Void Linux's, or RHEL's),
which often follow autoconf's conventions instead.

When in Rome, do as the Romans do; hopefully this won't confuse
GPRBuild users (too much)!

Fixes #15
---
 Makefile.in | 6 +++---
 aclocal.m4  | 4 ++--
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index e03b63c..880262b 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -16,9 +16,9 @@ GPRBUILD_OPTIONS=
 PROCESSORS?=0
 GPRBUILD=@gprbuild@ -j${PROCESSORS} -m ${GPRBUILD_OPTIONS}
 GPRINSTALL=@gprinstall@
-TARGET=@target@
-TARGET_ALIAS=@target_alias@
-HOST=@host@
+TARGET=@host@
+TARGET_ALIAS=@host_alias@
+HOST=@build@
 
 # Compiler mode: one of "distrib", "Debug", "Production", "profile", "coverage"
 MODE=@BUILD_TYPE@
diff --git a/aclocal.m4 b/aclocal.m4
index 39392bc..e17b338 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -91,8 +91,8 @@ project Lib is
 end Lib;
 EOF
 
-      if test "x$host_alias" != "x$target_alias"; then
-          $gprbuild --target=$target_alias -c -q -P$tmp/lib 2>/dev/null
+      if test "x$build_alias" != "x$host_alias"; then
+          $gprbuild --target=$host_alias -c -q -P$tmp/lib 2>/dev/null
       else
           $gprbuild -c -q -P$tmp/lib 2>/dev/null
       fi
-- 
2.48.1

