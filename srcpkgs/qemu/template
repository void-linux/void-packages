# Template file for 'qemu'
# This package should be updated together with qemu-user-static
pkgname=qemu
version=9.0.0
revision=1
build_style=configure
configure_args="--prefix=/usr --sysconfdir=/etc --libexecdir=/usr/libexec --localstatedir=/var
 --disable-glusterfs --disable-xen --enable-docs --enable-kvm --enable-libusb --enable-pie
 --enable-snappy --enable-tpm --enable-usb-redir --enable-vhost-net --enable-virtfs --enable-png
 --audio-drv-list=alsa$(vopt_if sdl2 ,sdl)$(vopt_if jack ,jack)$(vopt_if pulseaudio ,pa)
 $(vopt_enable opengl) $(vopt_enable pulseaudio pa) $(vopt_enable sdl2 sdl) $(vopt_enable smartcard)
 $(vopt_enable spice) $(vopt_enable virgl virglrenderer) $(vopt_if gtk3 '--enable-gtk')"
hostmakedepends="flex glib-devel gettext pkg-config perl python3 python3-Sphinx python3-sphinx_rtd_theme ninja"
makedepends="capstone-devel dtc-devel libpng-devel libjpeg-turbo-devel pixman-devel
 snappy-devel libuuid-devel libX11-devel alsa-lib-devel libaio-devel gnutls-devel
 libsasl-devel ncurses-devel libseccomp-devel nss-devel
 libcurl-devel xfsprogs-devel libcap-ng-devel vde2-devel usbredir-devel
 libbluetooth-devel libssh2-devel libusb-devel libnfs-devel libslirp-devel
 libxkbcommon-devel libzstd-devel $(vopt_if sdl2 'SDL2-devel SDL2_image-devel')
 $(vopt_if gtk3 'gtk+3-devel vte3-devel')
 $(vopt_if spice 'spice-devel pcsclite-devel') $(vopt_if virgl virglrenderer-devel)
 $(vopt_if opengl 'libepoxy-devel libdrm-devel MesaLib-devel')
 $(vopt_if iscsi 'libiscsi-devel')
 $(vopt_if smartcard libcacard-devel) $(vopt_if numa 'libnuma-devel')
 $(vopt_if jack 'jack-devel') $(vopt_if pulseaudio 'pulseaudio-devel')"
short_desc="Open Source Processor Emulator"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-only, LGPL-2.1-only"
homepage="https://www.qemu.org"
distfiles="https://wiki.qemu.org/download/qemu-${version}.tar.bz2"
checksum=f816255215ed495d164311210e05aec867c4cb22576b41b2d723209de579ed61
ignore_elf_dirs="/usr/share/qemu"
nostrip_files="hppa-firmware.img hppa-firmware64.img openbios-ppc
 openbios-sparc32 openbios-sparc64 palcode-clipper s390-ccw.img
 s390-netboot.img u-boot.e500"

build_options="gtk3 iscsi jack numa opengl pulseaudio sdl2 smartcard spice virgl"
build_options_default="gtk3 iscsi jack numa opengl pulseaudio sdl2 smartcard spice virgl"
desc_option_sdl2="Enable SDL (2.x) video output"
desc_option_spice="Enable support for SPICE"
desc_option_virgl="Enable support for VirGL (A Virtual 3D GPU renderer)"
desc_option_smartcard="Enable smartcard support"
desc_option_numa="Enable support for host NUMA"
desc_option_iscsi="Enable support for iSCSI"

if [ "$CROSS_BUILD" ]; then
	configure_args+=" --cross-prefix=${XBPS_CROSS_TRIPLET}-"
fi

post_install() {
	vdoc "${FILESDIR}/README.voidlinux"

	# qemu-bridge-helper must be setuid for non privileged users.
	chmod u+s ${DESTDIR}/usr/libexec/qemu-bridge-helper

	vsv qemu-ga
}

qemu-ga_package() {
	short_desc="QEMU Guest Agent"
	pkg_install() {
		vmove usr/bin/qemu-ga
		vmove etc/sv/qemu-ga
	}
}
