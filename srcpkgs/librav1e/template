# Template file for 'librav1e'
pkgname=librav1e
version=0.6.2
revision=1
build_helper="rust"
hostmakedepends="cargo cargo-auditable cargo-c nasm pkg-config"
makedepends="rust"
short_desc="AV1 video encoder suitable for cases where libaom is too slow"
maintainer="Eugen Zagorodniy <zag@disroot.org>"
license=BSD-2-Clause
homepage="https://github.com/xiph/rav1e"
distfiles="https://github.com/xiph/rav1e/archive/refs/tags/v${version}.tar.gz"
checksum=8fe8d80bc80a05ee33113c0ee19779d9c57189e5434c8e1da8f67832461aa089

do_build() {
	cargo auditable cbuild --release --target ${RUST_TARGET} \
		--destdir ${DESTDIR} --prefix usr
	cargo auditable build --release --target ${RUST_TARGET}
}

do_check() {
	cargo auditable ctest --release --target ${RUST_TARGET}
	if [ "$XBPS_TARGET_MACHINE" -ne "i686" ]; then
		# Some tests fail on i686 with message:
		#
		# error: ran out of registers during register allocation
		#
		# LLVM ERROR: Cannot emit physreg copy instruction
		# Couldn't compile the test.
		cargo auditable test --release --target ${RUST_TARGET}
	fi
}

do_install() {
	vlicense LICENSE
	cargo auditable cinstall --release --target=${RUST_TARGET} \
		--destdir ${DESTDIR} --prefix usr
}

librav1e-devel_package() {
	depends="librav1e>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.a"
		if [ "$XBPS_TARGET_LIBC" -ne "musl" ]; then
			# Shared libs are missing on musl build - how to fix this?
			vmove "usr/lib/*.so"
		fi
		vmove usr/lib/pkgconfig
	}
}

rav1e_package() {
	short_desc+=" - standalone binary"
	pkg_install() {
		vbin target/${RUST_TARGET}/release/rav1e
	}
}
