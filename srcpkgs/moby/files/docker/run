#!/bin/sh
[ -r conf ] && . ./conf
[ -r /etc/runit/functions ] && . /etc/runit/functions && detect_virt
if [ -z $VIRTUALIZATION ]; then  # we're not in a container
    modprobe -q loop || exit 1
    mountpoint -q /sys/fs/cgroup/systemd || {
        mkdir -p /sys/fs/cgroup/systemd;
        mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd;
    }
else
    mount -t cgroup2 cgroup2 /sys/fs/cgroup/
fi
exec chpst -o 1048576 -p 1048576 dockerd $OPTS 2>&1
