# Template file for 'systemd-boot'
pkgname=systemd-boot
version=241
revision=1
archs="x86_64* i686* aarch64* armv*"
wrksrc="systemd-${version}"
build_style=meson
configure_args="-Dblkid=true -Defi=true -Dgnu-efi=true
 -Defi-cc=$CC -Dsplit-usr=false -Dacl=false -Dapparmor=false
 -Daudit=false -Dbzip2=false -Delfutils=false -Dgcrypt=false
 -Dgnutls=false -Dkmod=false -Dlibcryptsetup=false -Dlibcurl=false
 -Dlibidn=false -Dlibidn2=false -Dlibiptc=false -Dlz4=false -Dmicrohttpd=false
 -Dmyhostname=false -Dpam=false -Dqrencode=false -Dseccomp=false
 -Dselinux=false -Dxkbcommon=false -Dxz=false
 -Defi-includedir=${XBPS_CROSS_BASE}/usr/include/efi
 -Defi-ldsdir=${XBPS_CROSS_BASE}/usr/lib -Defi-ld=${XBPS_CROSS_BASE}/usr/bin/ld
 -Defi-libdir=${XBPS_CROSS_BASE}/usr/lib"
hostmakedepends="gperf patchelf pkg-config libxslt intltool m4 docbook-xsl"
makedepends="libcap-devel gnu-efi-libs libblkid-devel libmount-devel"
short_desc="UEFI boot manager from systemd"
maintainer="maxice8 <thinkabit.ukim@gmail.com>"
license="LGPL-2.1-or-later"
homepage="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot"
distfiles="https://github.com/systemd/systemd/archive/v${version}.tar.gz"
checksum=b2561a8e1d10a2c248253f0dda31a85dd6d69f2b54177de55e02cd1d2778316e

case "$XBPS_TARGET_MACHINE" in
	x86_64*) efi_arch=x64 ;;
	armv*) efi_arch=arm ;;
	aarch64*) efi_arch=aa64 ;;
	i686*) efi_arch=ia32 ;;
esac

case "$XBPS_TARGET_MACHINE" in
	*-musl) broken="see elogind musl_missing.h for what is missing" ;;
esac

do_build() {
	local targets="bootctl man/bootctl.1 man/kernel-install.8
	 src/boot/efi/linux${efi_arch}.efi.stub
	 src/boot/efi/systemd-boot${efi_arch}.efi"

	 cd build
	 ninja $targets
	 patchelf --remove-rpath bootctl
}

do_install() {
	vbin build/bootctl
	vman build/man/bootctl.1
	vman build/man/kernel-install.8

	vmkdir usr/lib/systemd/boot/efi
	vinstall build/src/boot/efi/linux${efi_arch}.efi.stub 644 usr/lib/systemd/boot/efi
	vinstall build/src/boot/efi/systemd-boot${efi_arch}.efi 644 usr/lib/systemd/boot/efi

	vinstall ${FILESDIR}/kernel.d/systemd-boot.post-install 750 \
		etc/kernel.d/post-install 50-systemd-boot
	vinstall ${FILESDIR}/kernel.d/systemd-boot.post-remove 750 \
		etc/kernel.d/post-remove 50-systemd-boot
}
