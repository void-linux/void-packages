# Template file for 'bcachefs-tools'
pkgname=bcachefs-tools
reverts="24_1"
version=1.35.0
revision=1
build_style=gnu-makefile
make_install_args="ROOT_SBINDIR=/usr/bin"
make_use_env=yes
hostmakedepends="cargo clang19-devel jq liburcu-devel llvm19 pkg-config"
makedepends="rust attr-devel keyutils-devel libaio-devel libblkid-devel
 liblz4-devel libscrypt-devel libsodium-devel eudev-libudev-devel liburcu-devel
 libuuid-devel libzstd-devel zlib-devel"
short_desc="Userspace tools for bcachefs"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="GPL-2.0-only"
homepage="https://bcachefs.org/"
distfiles="https://github.com/koverstreet/bcachefs-tools/archive/refs/tags/v${version}.tar.gz"
checksum=be773c32169d3a81558b197ccb32054be70821e87e7ac24e855efc1b4ae911e6

export VERSION=v${version}
export RUST_TARGET

case "$XBPS_TARGET_MACHINE" in
	armv7*) broken="https://build.voidlinux.org/#/builders/6/builds/4217";;
esac

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	XBPS_CROSS_RUSTFLAGS+=" -latomic"
fi

pre_build() {
	RUSTFLAGS+=" -C linker=$CC"
}

bcachefs-dkms_package() {
	short_desc+=" - DKMS module"
	depends="${sourcepkg}>=${version}_${revision} dkms"
	dkms_modules="bcachefs ${version}"
	pkg_install() {
		vmove usr/src
	}
}
