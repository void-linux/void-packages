# Template file for 'brother-brscan4'
pkgname=brother-brscan4
version=0.4.11
revision=1
archs="i686 x86_64"
depends="sane"
short_desc="SANE scanner driver for brscan4-compatible printers"
maintainer="Martijn van Buul <martijn.van.buul@gmail.com>"
license="custom:EULA"
homepage="https://support.brother.com/"
repository="nonfree"
nopie=yes
_mylibrary="libsane-brother4.so.1.0.7"
conf_files="/opt/brother/scanner/brscan4/Brsane4.ini
 /opt/brother/scanner/brscan4/brsanenetdevice4.cfg
 /opt/brother/scanner/brscan4/models4/*.ini"

# The license was removed by Brother - we vendor it.
# distfiles="http://www.brother.com/agreement/English_sane/agree.html>LICENSE.html"
# checksum="3434bca1936d6a5fd6afd810cde7e1876dd4d1496722b09af180278480f464f2"

if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
	_rpmpkgid="1.x86_64"
	distfiles="https://download.brother.com/welcome/dlf105203/brscan4-${version}-${_rpmpkgid}.rpm"
	checksum="7d7dcbe8349ae4d4ab816e4551017f2f1fd9fd6bf3f4f3c570fbd9576248dd9f"
	_rpmlibdir="usr/lib64"
else
	_rpmpkgid="1.i386"
	distfiles="https://download.brother.com/welcome/dlf105202/brscan4-${version}-${_rpmpkgid}.rpm"
	checksum="8bd395b8a25a385eb4a5e2770d4b10b17735203006b7a90a6879a0ef69e5fe4d"
	_rpmlibdir="usr/lib"
fi

do_install() {
	# binary package makes a fine mess of things, and installs stuff in very
	# unwieldy locations. Some of this cannot be avoided.
	#
	# The query command, "brsaneconfig4 -q", only works under these conditions:
	#
	# 1. The "brsaneconfig4" binary must be in /opt/brother/scanner/brscan4/.
	#    We can still make a symlink in /usr/bin/, but we cannot copy it there.
	#
	# 2. The configuration files must reside in /opt/brother/scanner/bscan4/.
	#    And their symlink must be in /etc/opt/brother/scanner/brscan4/.


	# deb package installs 64-bit libraries in /usr/lib64; fix this
	vinstall ./${_rpmlibdir}/sane/${_mylibrary} 755 usr/lib/sane
	ln -sf /usr/lib/sane/${_mylibrary} ${DESTDIR}/usr/lib/sane/$(echo ${_mylibrary} | sed -e 's/\.[0-9]\.[0-9]$//')
	ln -sf /usr/lib/sane/${_mylibrary} ${DESTDIR}/usr/lib/sane/$(echo ${_mylibrary} | sed -e 's/\.[0-9]\.[0-9]\.[0-9]$//')

	vinstall ${FILESDIR}/40-brother-brscan4-libsane-type1.rules 644 usr/lib/udev/rules.d

	vmkdir opt/brother/scanner/brscan4 755
	vcopy  opt/brother/scanner/brscan4/models4 opt/brother/scanner/brscan4

	vinstall opt/brother/scanner/brscan4/Brsane4.ini          644 opt/brother/scanner/brscan4
	vinstall opt/brother/scanner/brscan4/brsanenetdevice4.cfg 644 opt/brother/scanner/brscan4
	vinstall opt/brother/scanner/brscan4/brscan_cnetconfig    755 opt/brother/scanner/brscan4
	vinstall opt/brother/scanner/brscan4/brscan_gnetconfig    755 opt/brother/scanner/brscan4
	vinstall opt/brother/scanner/brscan4/brsaneconfig4        755 opt/brother/scanner/brscan4

	# The binary library has hard-coded paths to
	#
	# /etc/opt/brother/scanner/brscan4
	#
	# This is very unfortunate, but cannot be avoided without the source to
	# recompile the binary - which is not available.
	vmkdir etc/opt/brother/scanner/brscan4 755
	for link in Brsane4.ini brsanenetdevice4.cfg models4/; do
		ln -sf /opt/brother/scanner/brscan4/${link} ${DESTDIR}/etc/opt/brother/scanner/brscan4/
	done

	# Install the licenses.
	vlicense ${FILESDIR}/agree.html LICENSE.html
	vlicense opt/brother/scanner/brscan4/doc/brscan4/readme.txt # Independent JPEG blurb.

	# config helper - installed by the deb package as a symlink.
	vmkdir usr/bin 755
	ln -sf /opt/brother/scanner/brscan4/brsaneconfig4 ${DESTDIR}/usr/bin/brsaneconfig4

	# The only file in the deb package that has *not* been installed is a
	# setup script to modify the SANE configuration. This will be performed
	# by INSTALL and REMOVE instead.
	vdoc "${FILESDIR}/README.voidlinux"
}
