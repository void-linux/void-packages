readonly opt_dir=/opt/brother/scanner/brscan4
readonly etc_dir=/etc/opt/brother/scanner/brscan4

# The config files are nominally "Brsane4.ini", "brsanenetdevice4.cfg",
# and "models4/". Among these, only "brsanenetdevice4.cfg" is
# potentially modified by the user.
readonly config="brsanenetdevice4.cfg"

readonly migrate_dir=/tmp
readonly migrate_ext=brscan4.migrate

# Packages with versions <= 0.4.9 used config files in "${etc_dir}/*".
# However, "brsaneconfig4" expects to find them in "${opt_dir}/*" with
# a symlink in "${etc_dir}/". If the non-symlink version of these is found,
# it means it comes from those older packages and must be migrated.
record_older_config()
{
	if [ -e "${etc_dir}/${config}" ] && [ ! -L "${etc_dir}/${config}" ]; then
		cp "${etc_dir}/${config}" "${migrate_dir}/${config}.${migrate_ext}"
	fi
}

# If the "record_older_config()" has created files for migrations
# in ${migrate_dir} during the "pre" action, then they must be moved
# into ${opt_dir} during the "post" action.
# The config file, "brsanenetdevice4.cfg", provided by the package
# is an empty file, so it can simply be overwritten by the user's file.
use_older_config()
{
	# Is there any file to migrate?
	if [ -f "${migrate_dir}/${config}.${migrate_ext}" ]; then
		mv "${migrate_dir}/${config}.${migrate_ext}" "${opt_dir}/${config}"
	fi
}

case "${ACTION}" in
pre)
	record_older_config
	;;
post)
	# Add brother driver to sane configuration
	_SANE_CONF="/etc/sane.d/dll.conf"
	if [ "$(grep brother4 ${_SANE_CONF})" = "" ]; then
		echo brother4 >> "${_SANE_CONF}"
	fi;
	use_older_config
	;;
esac
