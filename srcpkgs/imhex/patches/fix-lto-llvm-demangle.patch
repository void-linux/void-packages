From 135448cacc2ddbdb00580565aba870cf6be76124 Mon Sep 17 00:00:00 2001
From: Roger Freitas Pereira <roger_freitas@live.com>
Date: Mon, 29 Dec 2025 05:16:04 -0300
Subject: [PATCH] fix: link LLVMDemangle when building with LTO and system LLVM

---
 lib/libimhex/CMakeLists.txt | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/lib/libimhex/CMakeLists.txt b/lib/libimhex/CMakeLists.txt
index 1977cf8..1814bcb 100644
--- a/lib/libimhex/CMakeLists.txt
+++ b/lib/libimhex/CMakeLists.txt
@@ -137,6 +137,12 @@ generate_export_header(libimhex)
 
 target_include_directories(libimhex ${LIBIMHEX_LIBRARY_TYPE} include ${XDGPP_INCLUDE_DIRS} ${LLVM_INCLUDE_DIRS} ${FMT_INCLUDE_DIRS})
 
+if (IMHEX_ENABLE_LTO AND USE_SYSTEM_LLVM)
+    target_link_options(libimhex PRIVATE
+        "-Wl,--whole-archive" "-l:libLLVMDemangle.a" "-Wl,--no-whole-archive"
+    )
+endif()
+
 if (NOT IMHEX_EXTERNAL_PLUGIN_BUILD)
     if (WIN32)
         set_target_properties(libimhex PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS TRUE)
-- 
2.51.2

