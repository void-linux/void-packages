# Template file for 'deadbeef'
pkgname=deadbeef
version=1.9.6
revision=1
create_wrksrc=yes
build_style=gnu-configure
configure_args="--disable-oss --disable-lfm --disable-gtk2 --disable-libretro"
hostmakedepends="automake libtool gettext gettext-devel intltool pkg-config
 yasm clang glib-devel"

makedepends="
 alsa-lib-devel libdispatch-devel ffmpeg-devel faad2-devel gtk+3-devel jansson-devel
 libcurl-devel libflac-devel libmad-devel libsndfile-devel libvorbis-devel libzip-devel
 libcddb-devel libcdio-devel opusfile-devel mpg123-devel dbus-devel pulseaudio-devel
 pipewire-devel libsamplerate-devel wavpack-devel"
depends="desktop-file-utils hicolor-icon-theme"
short_desc="Ultimate Music Player for GNU/Linux"
maintainer="Orphaned <orphan@voidlinux.org>"
license="Zlib, GPL-2.0-or-later, LGPL-2.1-or-later"
_libretro_commit=b4d3db19566398603069d02eeacb3b06987a1b74
_output_pw_commit=0b099d13ab0e89d9934aabdeb2872f0f66ea6960
_mp4p_commit=156195ccb635f016dc34b89425bfbecf046c90d4
homepage="https://deadbeef.sourceforge.io"
changelog="https://deadbeef.sourceforge.io/news0.html"
distfiles="https://github.com/DeaDBeeF-Player/deadbeef/archive/${version}.tar.gz>${pkgname}-${version}.tar.gz
 https://github.com/DeaDBeeF-Player/ddb_dsp_libretro/archive/${_libretro_commit}.tar.gz>libretro-${_libretro_commit}.tar.gz
 https://github.com/DeaDBeeF-Player/ddb_output_pw/archive/${_output_pw_commit}.tar.gz>output_pw-${_output_pw_commit}.tar.gz
 https://github.com/DeaDBeeF-Player/mp4p/archive/${_mp4p_commit}.tar.gz>mp4p-${_mp4p_commit}.tar.gz"
checksum="53ed535335e637437adf77eb4bcadb781eddbf5539f74373d5a863389df5e2d0
444d4d89edbd51b9d2305c83a49e18949e0f21a42eec2a95ce03efd752a81049
59115ddcd0378aa2f5914138c5c256198d66339bfbb3d65389b9bf4fa327f9ee
3b5bdbcb2808d12b9f5af630a91e77be1036aeb487d5fa0a323ce8080918439b"

# The soundtouchup plugin was made default in 1.8.4 and fails to build on i686.
# Fixing that might be a good maintainer task.
case "$XBPS_TARGET_MACHINE" in
	i686*) configure_args+=" --disable-soundtouch --disable-ffap" ;;
esac

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-legacy-compat"
fi

post_extract() {
	mv deadbeef-${version}/* .
	rm -rf external/mp4p
	rm -rf external/ddb_dsp_libretro
	rm -rf external/ddb_output_pw
	mv -v ddb_dsp_libretro-${_libretro_commit} external/ddb_dsp_libretro
	mv -v ddb_output_pw-${_output_pw_commit} external/ddb_output_pw
	mv -v mp4p-${_mp4p_commit} external/mp4p
}

# musl complaining about <sys/cdefs.h> deprecation
do_configure() {
	export CC=clang
	export CXX=clang++
	./autogen.sh
	CFLAGS="-Wno-error" ./configure ${configure_args}
}

post_install() {
	vlicense COPYING
}

deadbeef-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
	}
}
