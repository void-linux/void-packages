# Template file for 'shiboken6'
pkgname=shiboken6
version=6.1.1
revision=1
_pkgname="pyside-setup-opensource-src-${version}"
wrksrc="${_pkgname}"
build_wrksrc="sources/shiboken6"
build_style=cmake
configure_args="-DNUMPY_INCLUDE_DIR=${XBPS_CROSS_BASE}/${py3_sitelib}/numpy"
hostmakedepends="python3-devel"
makedepends="qt6-base-devel python3-devel clang-tools-extra llvm libxslt-devel python3-numpy"
depends="clang"
short_desc="Python binding generator of Qt6 C++ API"
maintainer="yopito <pierre.bourgin@free.fr>"
license="GPL-3.0-only WITH Qt-GPL-exception-1.0, LGPL-3.0-only, GPL-2.0-or-later"
homepage="https://doc.qt.io/qtforpython/shiboken6/"
distfiles="https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-${version}-src/${_pkgname}.tar.xz"
checksum=9136c98742443626c142beb77a777a0e2e6fa6653b5451fce54047f64d5f7d43
conflicts="shiboken2"
python_version=3

export CLANG_INSTALL_DIR=${XBPS_CROSS_BASE}/usr

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" qt6-base-devel shiboken6"
	# use host's automoc
	configure_args+=" -DQT_HOST_PATH=/usr"
fi

pre_check() {
	# create a temporary shiboken6 python module for testing.
	# Needed since 6.1 and the reorg of generated stuff
	# (see https://bugreports.qt.io/browse/PYSIDE-1497)
	# related with tests-need-python-modules.patch
	local _tmpmodule="${cmake_builddir:=build}/tmpmodule/shiboken6"
	mkdir -p ${_tmpmodule}
	cp -p ${cmake_builddir}/__init__.py ${_tmpmodule}/.
	cp -p ${cmake_builddir}/Shiboken.so ${_tmpmodule}/.
	cp -p ${cmake_builddir}/shiboken6.so ${_tmpmodule}/.
}

post_install() {
	# shiboken 6.1.1: duplicate file of usr/lib/pkgconfig/shiboken6.pc
	rm ${DESTDIR}/${py3_sitelib}/shiboken6/data/shiboken6.pc
}

libshiboken6-devel_package() {
	depends="${sourcepkg}-${version}_${revision}
	 libshiboken6-${version}_${revision} python3-shiboken6-${version}_${revision}"
	short_desc+=" - common development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
	}
}

libshiboken6_package() {
	short_desc="Python3 shiboken6 bindings - shared library"
	pkg_install() {
		vmove "usr/lib/*.so.*"
	}
}

python3-shiboken6_package() {
	short_desc="Python3 shiboken6 bindings"
	pkg_install() {
		vmove ${py3_sitelib}
	}
}
