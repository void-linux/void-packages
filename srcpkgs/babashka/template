# Template file for 'babashka'
pkgname=babashka
version=1.12.214
revision=1
create_wrksrc=yes
hostmakedepends="mandrel leiningen git"
makedepends="zlib-devel"
checkdepends="clojure curl tar"
short_desc="Native, fast starting Clojure interpreter for scripting"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="EPL-1.0"
homepage="https://babashka.org/"
changelog="https://github.com/babashka/babashka/raw/master/CHANGELOG.md"
_babashka_sha=b1e203976588ba9c39a03d1a32ac082087c1936e
_sci_commit=9edc11ae15f2f099348a1fbfc7c3e0607a20909b
_babashka_curl_commit=e936acd40544eb637b6041c7e89454b21eb7ee34
_babashka_nrepl_commit=c021393eea1b51117ca9d317269a71c4a7c131c8
_depstar_commit=b8b6183d2c574b628d29b1d7100e6293f906c9cb
_process_commit=16a84e0af0da51b8c84e289970f6b7cc35b35d18
_pods_commit=ed5e1f3390b9dfca564f66b6e79c739c3cd82d78
_deps_clj_commit=a0fbf55a42f811ebdf662f3ca30c8ddfc7813f54
_fs_commit=fff58f5a7fecedee07b5b44eadd415a7f18eebd5
_babashka_core_commit=52a6037bd4b632bffffb04394fb4efd0cdab6b1e
distfiles="https://github.com/babashka/babashka/archive/refs/tags/v${version}.tar.gz
 https://github.com/borkdude/sci/archive/${_sci_commit}.tar.gz
 https://github.com/babashka/babashka.curl/archive/${_babashka_curl_commit}.tar.gz
 https://github.com/babashka/babashka.nrepl/archive/${_babashka_nrepl_commit}.tar.gz
 https://github.com/babashka/depstar/archive/${_depstar_commit}.tar.gz
 https://github.com/babashka/process/archive/${_process_commit}.tar.gz
 https://github.com/babashka/pods/archive/${_pods_commit}.tar.gz
 https://github.com/borkdude/deps.clj/archive/${_deps_clj_commit}.tar.gz
 https://github.com/babashka/fs/archive/${_fs_commit}.tar.gz
 https://github.com/babashka/babashka.core/archive/${_babashka_core_commit}.tar.gz"
checksum="5825364f6858adfa9d04974d747e64a864f10685cab8b279706f75bcd1730b24
 10fdbb6e4c8efea5bd86306de8a50d9353c0e114bae37dc9951b267cccb74a64
 6e60865ae2d4522c3de55b3b1daed51b42bb9bb6095b1d2fbd3620facece3257
 f6538fc53acc1be1a5255fa6b8293a90cffd068a8aa9546c63272dc695928e7f
 83b44490ac11cee1f1dca8bf06c6bf63477c230d62a42320011329c3da91b989
 892527beda30b97ba05b64d44615ab087908e8f100b46a48df8e7100f1b315cc
 9ebb707bfb9f6ef5177c838223c3b1860aaee9805e8ecc4789ab9b484927d6ed
 35436a87ae11d007b0b547ce05130c9c3b27ae54d9910f5c4f1e71df6fd7843a
 936495f2ffc91216e74c95cdefff7fb10cd84e2c7c59d504d1a471dce8ba9d89
 bad285812bcc7de7e0dd905c5df99045d7f92d6e2e191fc2768c06adbaaeb709"

nocross="https://build.voidlinux.org/builders/aarch64_builder/builds/33769/steps/shell_3/logs/stdio"

post_extract() {
	mv babashka-$version/* babashka-$version/.??* .
	rmdir babashka-$version
	for dir in sci babashka.core babashka.curl babashka.nrepl \
		depstar process pods deps.clj fs
	do
		rmdir $dir
		mv "$dir"-* $dir
	done

	# Mandrel doesn't have GraalVM-SDK in the default classpath,
	# but some Babashka features require it.
	vsed -i -e '/:resource-paths/s@]@ "/usr/lib/jvm/mandrel21/lib/jvmci/nativeimage.jar"]@' project.clj

	# idk why this is needed
	vsed -i -e /sun.security.ssl.SSLAlgorithmConstraints/d resources/META-INF/native-image/babashka/babashka/native-image.properties
}

do_build() {
	export GRAALVM_HOME=/usr/lib/jvm/mandrel21
	export PATH=${GRAALVM_HOME}/bin:$PATH
	export BABASHKA_SHA=${_babashka_sha}
	if [ "$XBPS_TARGET_LIBC" = musl ]; then
		export BABASHKA_MUSL=true
		export BABASHKA_STATIC=true  # mandrel workaround
	fi

	lein deps
	script/uberjar
	script/compile --initialize-at-build-time=org.jsoup
}

do_check() {
	export GRAALVM_HOME=/usr/lib/jvm/mandrel21
	export BABASHKA_TEST_ENV=native
	script/test
	script/run_lib_tests
}

do_install() {
	vbin bb
	vlicense LICENSE
}
