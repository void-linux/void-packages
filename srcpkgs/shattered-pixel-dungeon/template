# Template file for 'shattered-pixel-dungeon'
pkgname=shattered-pixel-dungeon
version=3.3.1
revision=1
hostmakedepends="openjdk17 gradle"
depends="virtual?java-runtime desktop-file-utils hicolor-icon-theme"
short_desc="Open-source roguelike dungeon crawler with randomized levels and enemies"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="GPL-3.0-only"
homepage="https://github.com/00-Evan/shattered-pixel-dungeon"
distfiles="https://github.com/00-Evan/shattered-pixel-dungeon/archive/v${version}.tar.gz"
checksum=5e22c79654865bb85ff7f44c60553641185d26cc660ffbb730b50965314952f3

do_build() {
	vsed -i settings.gradle -e 's|include.*:android.*|//&|'
	vsed -i settings.gradle -e 's|include.*:ios.*|//&|'

	# The heap size is causing problems for the i686 CI build.
	case "${XBPS_TARGET_MACHINE}" in
	i686*) vsed -i gradle.properties -e 's|-Xmx2048m ||'
	       ;;
	esac

	gradle --no-daemon --warning-mode all desktop:release
}

do_install() {
	vmkdir usr/share/${pkgname}
	vcopy desktop/build/libs/desktop-$version.jar usr/share/${pkgname}

	vmkdir usr/bin
	sed "s|@VERSION@|${version}|" "${FILESDIR}/${pkgname}" > "${DESTDIR}/usr/bin/${pkgname}"
	chmod 0755 "${DESTDIR}/usr/bin/${pkgname}"

	vinstall "${FILESDIR}/${pkgname}.desktop" 0644 usr/share/applications

	for icon in desktop/src/main/assets/icons/icon_*.png; do
		local size=${icon##*_}
		size=${size%.png}
		vinstall $icon 0644 usr/share/icons/hicolor/${size}x${size}/apps ${pkgname}.png
	done
}
