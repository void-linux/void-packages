# Template file for 'aseprite'
pkgname=aseprite
version=1.3.14.4
revision=1
# skia release has only x64 and x86
archs="i686 x86_64"
build_style=cmake
configure_args="
 -Wno-dev
 -DUSE_SHARED_CMARK=$(vopt_if system ON OFF)
 -DUSE_SHARED_CURL=$(vopt_if system ON OFF)
 -DUSE_SHARED_FREETYPE=$(vopt_if system ON OFF)
 -DUSE_SHARED_GIFLIB=$(vopt_if system ON OFF)
 -DUSE_SHARED_HARFBUZZ=$(vopt_if system ON OFF)
 -DUSE_SHARED_LIBPNG=$(vopt_if system ON OFF)
 -DUSE_SHARED_PIXMAN=$(vopt_if system ON OFF)
 -DUSE_SHARED_TINYEXIF=OFF
 -DUSE_SHARED_TINYXML=OFF
 -DUSE_SHARED_ZLIB=$(vopt_if system ON OFF)
 -DENABLE_SCRIPTING=$(vopt_if scripting ON OFF)
 -DENABLE_PSD=$(vopt_if psd ON OFF)
 -DENABLE_UPDATER=OFF
 -DENABLE_DESKTOP_INTEGRATION=$(vopt_if desktop ON OFF)
 -DENABLE_QT_THUMBNAILER=$(vopt_if desktop ON OFF)
 -DENABLE_UNZIP=OFF
 -DENABLE_TESTS=OFF
 -DENABLE_BENCHMARKS=OFF
 "
hostmakedepends="clang cmake gcc gn ninja unzip tar"
makedepends="pkg-config harfbuzz-devel libcurl-devel cmark-devel freetype-devel giflib-devel libpng-devel
 pixman-devel libwebp-devel libjpeg-turbo-devel tinyxml2-devel libX11-devel libXcursor-devel libXi-devel
 MesaLib-devel fontconfig-devel zlib-devel $(vopt_if desktop extra-cmake-modules) $(vopt_if desktop kio-devel)"
depends="cmark libglvnd libICE libSM libX11 libXau libXcursor libXdmcp libXext libXfixes libXrender acl
 brotli bzip2 glibc libcrypto3 expat fontconfig freetype libgcc libldap libpng libsasl libssl3 libstdc++ libuuid libxcb zlib"
short_desc="Animated sprite editor and pixel art tool"
maintainer="Naiko <glclaritas@gmail.com>"
license="custom:Proprietary"
homepage="https://aseprite.org"
restricted=yes

build_options="desktop psd scripting system"
build_options_default="desktop psd scripting system"
desc_option_desktop="Enable desktop integration, and thumbnailers for GNOME and KDE"
desc_option_psd="Enable support for PSD files"
desc_option_scripting="Enable support for lua scripting"
desc_option_system="Use system libs"

# recursive modules commit
_baserepo="https://github.com/aseprite"
_laf=7c01959d7f0f2662a48eaa98e9b94336c4e45fda
_laf_clip=7a60eabaad167d9dc91eae439cb2c1ab9d49c6ba
_laf_thirdparty_googletest=155b337c938a2953e5675f9dc18c99f05f4c85d0
_src_flic=a37fe2d46e5ae7dd68b6048be7765c0bb436efa0
_src_obsv=addca27fbeb2958044da8d70a92ba3a302d43360
_src_psd=87af728fe4b35ed79d94de0932017dcf50737ae7
_src_tga=cd3420c3a5797f1200fd1e1970ca29598f2c2436
_src_undo=2209ac5d36e59d7c85e48df7cb32cb0cd3abf38b
_tp_ixws=89c92099597d47b61ba35f84ae2a351432a422e5
_tp_tinyexif=21d6cf762724260f8e5bcee4abdee5411ae47813
_tp_benchmark=c58e6d0710581e3a08d65c349664128a8d9a2461
_tp_cityhash=e2a9a15316816e61f22107c1cc3d07b5d88def04
_tp_cmark=9e2a6540f1a83720bab8b914dbf446fcea2238e0
_tp_curl=09cf6fd7009a98377db655c15e7ae5088e952f9a
_tp_fmt=67c0c0c09cf74d407d71a29c194761981614df3e
_tp_freetype2=66a04dd6f858e92766d77deda44a6d8d5dfee5bc
_tp_dlg=72dfcc858c040c54a6a0b88fcb7e70ee186d3167
_tp_giflib=94a7edbf52f8a0c0e2ee4ee210784c2d72012ac1
_tp_harfbuzz=8607be393dfd81614611897a6e3026fe94a3966c
_tp_json11=a4e1714f5592dbe9a9f11539e6f8742477f1d6b6
_tp_libarchive=7bde8b8259921f2dcbb31a664ceb298b819d29dc
_tp_libpng=34005e3d3d373c0c36898cc55eae48a79c8238a1
_tp_libwebp=9ce5843dbabcfd3f7c39ec7ceba9cbeb213cbfdf
_tp_lua=2a00e6b0013f54ce80b6e3cefe6514e13229987a
_tp_pixman=285b9a907caffeb979322e629d4e57aa42061b5a
_tp_qoi=c3dcfe780bf28f4a59bca7f0a60e2e18b0acf68f
_tp_simpleini=9fa7622f41e36105a4c767a7765bb24afec4d6be
_tp_tinyexpr=24b9db07acb98fb1051d6b3a0afbc4f87c5f811d
_tp_tinyxml2=312a8092245df393db14a0b2427457ed2ba75e1b
_tp_zlib=51b7f2abdade71cd9bb0e7a373ef2610ec6f9daf

# modules list by group
_src_modules="flic observable psd tga undo"
_tp_modules="IXWebSocket TinyEXIF benchmark cityhash cmark curl fmt freetype2 giflib harfbuzz
 json11 libarchive libpng libwebp lua pixman qoi simpleini tinyexpr tinyxml2 zlib"

distfiles="${_baserepo}/aseprite/archive/refs/tags/v${version}.tar.gz
 ${_baserepo}/laf/archive/${_laf}.tar.gz>laf.tar.gz
 ${_baserepo}/clip/archive/${_laf_clip}.tar.gz>clip.tar.gz
 ${_baserepo}/googletest/archive/${_laf_thirdparty_googletest}.tar.gz>googletest.tar.gz
 ${_baserepo}/flic/archive/${_src_flic}.tar.gz>flic.tar.gz
 ${_baserepo}/observable/archive/${_src_obsv}.tar.gz>observable.tar.gz
 ${_baserepo}/psd/archive/${_src_psd}.tar.gz>psd.tar.gz
 ${_baserepo}/tga/archive/${_src_tga}.tar.gz>tga.tar.gz
 ${_baserepo}/undo/archive/${_src_undo}.tar.gz>undo.tar.gz
 ${_baserepo}/IXWebSocket/archive/${_tp_ixws}.tar.gz>IXWebSocket.tar.gz
 ${_baserepo}/TinyEXIF/archive/${_tp_tinyexif}.tar.gz>TinyEXIF.tar.gz
 ${_baserepo}/benchmark/archive/${_tp_benchmark}.tar.gz>benchmark.tar.gz
 ${_baserepo}/cityhash/archive/${_tp_cityhash}.tar.gz>cityhash.tar.gz
 ${_baserepo}/cmark/archive/${_tp_cmark}.tar.gz>cmark.tar.gz
 ${_baserepo}/curl/archive/${_tp_curl}.tar.gz>curl.tar.gz
 ${_baserepo}/fmt/archive/${_tp_fmt}.tar.gz>fmt.tar.gz
 ${_baserepo}/freetype2/archive/${_tp_freetype2}.tar.gz>freetype2.tar.gz
 https://github.com/nyorain/dlg/archive/${_tp_dlg}.tar.gz>dlg.tar.gz
 ${_baserepo}/giflib/archive/${_tp_giflib}.tar.gz>giflib.tar.gz
 ${_baserepo}/harfbuzz/archive/${_tp_harfbuzz}.tar.gz>harfbuzz.tar.gz
 ${_baserepo}/json11/archive/${_tp_json11}.tar.gz>json11.tar.gz
 ${_baserepo}/libarchive/archive/${_tp_libarchive}.tar.gz>libarchive.tar.gz
 ${_baserepo}/libpng/archive/${_tp_libpng}.tar.gz>libpng.tar.gz
 ${_baserepo}/libwebp/archive/${_tp_libwebp}.tar.gz>libwebp.tar.gz
 ${_baserepo}/lua/archive/${_tp_lua}.tar.gz>lua.tar.gz
 ${_baserepo}/pixman/archive/${_tp_pixman}.tar.gz>pixman.tar.gz
 ${_baserepo}/qoi/archive/${_tp_qoi}.tar.gz>qoi.tar.gz
 ${_baserepo}/simpleini/archive/${_tp_simpleini}.tar.gz>simpleini.tar.gz
 ${_baserepo}/tinyexpr/archive/${_tp_tinyexpr}.tar.gz>tinyexpr.tar.gz
 ${_baserepo}/tinyxml2/archive/${_tp_tinyxml2}.tar.gz>tinyxml2.tar.gz
 ${_baserepo}/zlib/archive/${_tp_zlib}.tar.gz>zlib.tar.gz
 "

checksum="ba5b09fcfa52854efe0ab2e4cfbb71de19bd8ae7a4327a33a78a741e6f4088cd
 4fe85cde5cee7478f5162294345b22a38a5f6f4bad9a044dd9635646c3812f9f
 1384ef916bd96cb7ae40366d8d771977ffda29b586366d586548122f28087564
 f6f4bae321de5286cc0102cfc6e35f7e00e3fe48ec870072df3e509746ccd2b1
 40dbd47268a48e33a3da0e39e865ab9d8a9b35749d47242b1dd7002286a3a29a
 be20e7bbfe2b15c07f882c9148247321d41f3a5c54f1b8b62b15fc16d98c7e95
 b08a70cd2610ba73fb312175537ca60aebe6952d156381281718efd4d4817f3c
 22dc524daa4c33ae21368c87fb4f69090120a67e8cbc115b70821344223feb6f
 9816ae8f4457e1ad88accc4b7ab148f3efec14d71358cca0806c7f69287621e7
 92ec9d6586caa3304a83f9c4d9b9d8eeedace0e4403b2de5ba55ad9ef7f9dd53
 1188b35cd51ef22929117e851e3b9931f35381d838f854f58cf4106b98aaa593
 17fbd9d8ea361688f3059bd381afe828a55479cf3ce77f96b351f30b4a481bc8
 1f7af2ca94fd9dde22fa880738a2e7d337400979ebfccbb97ce1d9ec66308b91
 9558ffda714d1f76560d5dfb75ff4f135a1efa2b045768b620982007253c4038
 a9297b76841697180afb1bfdf61f367f69a90781c3f5a718dc955cf852d7511f
 af750af8635751938b87f6b4f40f58410c6bf87bd8d2ec53e2725b773b883e53
 2e49941062c1c31ca8ab810b2904826ee1be0b6abee0d9663fe743e50610e153
 f46472bea5854cf3c738f0e7aea90d7b0645629ec78fdf7a67bf7696955e7446
 4ca92a331e653385d58c81c7e8bf837320df9e59e85ff476d29e10ac01e3903e
 862b2cd202d6b1443c7cfbfee95dedd1a08af6b0551ba41a76959a4e0869d2eb
 b161634309d47c5beebac92417b3717012832d1e95b71323e9f3342f2e2aa733
 41cf5d560593d24c503c21c79be31bdcd2ffa9f48c9d72bf9451d6229f18aaa0
 f2172d0214bc01db2e3b17d5208d13541b3095b3e36d81d36af3eee838132392
 bbf43c67fc035a11f3e77c870fc33de26103f6a461e846432febe24f7b0230e1
 4a4c30975984f4066f82efd352928221381b1ba05605b93008d7b4801bbe06bf
 5f248330cad6de7fbfc0ebad4b6349c03088881fc5a3d95d6319ed5668a22ee4
 1cab20545b89bab88fa666611422cbc3f40d6d892a9030a1259315153e670e6d
 ac06aaef6fb70412270eb9796af538f8486262b864a8c52f34da36571745831d
 9e03cfd0a0d0887dcf7813fa50f90bfaed897bc03b14601c8a285194dd814871
 a25eede32cba49e74a68f3fe79b054c9bac9482e05c3b008731a099952e5881b
 d9e270d46252734aa49770fbc544125391617956266f220bd63216c834f3a522"

case "$XBPS_TARGET_MACHINE" in
	"x86_64")
		_skia_arch="x64"
		distfiles+=" https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Linux-Release-${_skia_arch}.zip>skia_${_skia_arch}.zip"
		checksum+=" a327e89b244f24cecaa34eb37544bae00d447b96c583d26ed29d6a3ad2e8a8b8"
		;;
	"i686" )
		_skia_arch="x86"
		distfiles+=" https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Linux-Release-${_skia_arch}.zip>skia_${_skia_arch}.zip"
		checksum+=" 826ac1b3d78ae469a6617859ff95a30f92f75036f883946de6ae2e005a0ce3f4"
		;;
esac

do_extract() {
	vsrcextract v${version}.tar.gz
	vsrcextract -C laf laf.tar.gz
	vsrcextract -C laf/clip clip.tar.gz
	vsrcextract -C laf/third_party/googletest googletest.tar.gz

	for i in $_src_modules; do
		vsrcextract -C "src/$i" "$i.tar.gz"
	done

	for i in $_tp_modules; do
		vsrcextract -C third_party/$i $i.tar.gz
	done
	vsrcextract -C third_party/freetype2/subprojects/dlg dlg.tar.gz

	# skia
	mkdir -p deps/skia
	unzip ${XBPS_SRCDISTDIR}/${pkgname}-${version}/skia_${_skia_arch}.zip -d deps/skia
}

do_patch() {
	# set version
	sed -e "s/set(VERSION \".*\")/set(VERSION \"${version}\")/" -i src/ver/CMakeLists.txt
}
pre_configure() {
	export CC=gcc
	export CXX=g++
	_skia_root="${XBPS_BUILDDIR}/${pkgname}-${version}/deps"
	configure_args+=" -DSKIA_DIR=${_skia_root}/skia"
	configure_args+=" -DSKIA_LIBRARY_DIR=${_skia_root}/skia/out/Release-${_skia_arch}"
	configure_args+=" -DSKIA_LIBRARY=${_skia_root}/skia/out/Release-${_skia_arch}/libskia.a"
	configure_args+=" -DCMAKE_BUILD_TYPE=Release"
	configure_args+=" -DLAF_BACKEND=skia"
	configure_args+=" -G Ninja"
}
do_install() {
	cmake --install build --prefix=usr

	vbin usr/bin/aseprite
	vbin usr/bin/aseprite-thumbnailer
	vmkdir usr/share
	_dirs=(\
		aseprite \
		$(vopt_if desktop applications) \
		$(vopt_if desktop kservices5) \
		$(vopt_if desktop mime) \
		$(vopt_if desktop thumbnailers) \
	)
	for f in "${_dirs[@]}"; do
		mv "usr/share/$f" "${DESTDIR}/usr/share/"
	done
	for i in 16 32 48 64 128 256; do
		vinstall data/icons/ase${i}.png 644 usr/share/icons/hicolor/${i}x${i}/apps/ aseprite.png
	done
	vlicense EULA.txt
}
