# Template file for 'cl-clx'
pkgname=cl-clx
version=0.7.6
revision=1
hostmakedepends="texinfo"
checkdepends="xvfb-run sbcl cl-fiasco"
short_desc="X11 client for Common Lisp"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="MIT, Public Domain, custom:COFFEEWARE"
homepage="https://github.com/sharplispers/clx"
distfiles="https://github.com/sharplispers/clx/archive/refs/tags/${version}.tar.gz"
checksum=bcc9cd736e7e28ec2b8085ce1c9686e02ffbee9257e1072f5c4fc393e33467e8

_LIBRARY_DIR=usr/share/common-lisp/source/clx

do_check() {
	xvfb-run sbcl --non-interactive \
	              --eval '(require "asdf")' \
	              --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	              --eval '(asdf:load-system "clx/test")' \
	              --eval '(unless (uiop:symbol-call :fiasco :run-tests :xlib-test)
	                        (uiop:quit 1))'
}

do_build() {
	makeinfo manual/clx.texinfo
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vmkdir $_LIBRARY_DIR/manual
	vcopy extensions $_LIBRARY_DIR
	vcopy manual/clx.texinfo $_LIBRARY_DIR/manual
	vcopy debug $_LIBRARY_DIR
	vcopy demo $_LIBRARY_DIR
	vcopy tests $_LIBRARY_DIR
	vcopy *.asd $_LIBRARY_DIR
	vcopy *.lisp $_LIBRARY_DIR
	vcopy *.c $_LIBRARY_DIR
	vcopy CHANGES $_LIBRARY_DIR
	vcopy README.md $_LIBRARY_DIR
	vcopy README-R5 $_LIBRARY_DIR
	vcopy exclMakefile $_LIBRARY_DIR
	vcopy exclREADME $_LIBRARY_DIR
	vinstall manual/clx.texinfo 644 usr/share/info

	vlicense LICENSE

	# The provided license file doesn't include all license info spread
	# around in the package so we gather it all in an extended license
	# file

	_license_file=LICENSE.ext

	# Portions Copyright (C) 1987 Texas Instruments Incorporated.
	# Portions Copyright (C) 1988, 1989 Franz Inc, Berkeley, Ca.
	sed -n "5,21p" clx.asd | cut -c 5- > "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 1987 Texas Instruments Incorporated.
	sed -n '5,19p' demo/zoid.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 1987, 1989 Massachussetts Institute of Technology
	sed -n "5,14p" sockcl.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) Digital Equipment Corporation, 1996
	sed -n "6,14p" extensions/dpms.lisp | cut -c 7- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (c) 2004, Christophe Rhodes
	sed -n "40,60p" demo/clipboard.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 2014 by Johannes Martinez
	sed -n "7,18p" extensions/randr.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 1999 by Gilbert Baumann
	sed -n "7,18p" extensions/shape.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (c) 1987, 1988, 1989 Franz Inc, Berkeley, Ca.
	sed -n "4,14p" excldep.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 2008, Julian Stecklina
	sed -n "2,9p" extensions/xinerama.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 1990 Symbolics, Inc.
	sed -n "3,11p" generalock.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 2002, 2003 by Gilbert Baumann
	# (c) copyright 2002 by Christian Sunesson
	sed -n "8,20p" extensions/xrender.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 2005 by Istvan Marko
	sed -n "7,18p" extensions/screensaver.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 2006 Richard Kreuter
	# (c) copyright 2007 by Christophe Rhodes
	sed -n "3,13p" extensions/big-requests.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright    Massachusetts Institute of Technology    1988
	head -n 1 socket.c >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# (c) copyright 2003 by Iban Hatchondo
	sed -n "7,18p" extensions/xvidmode.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 1988 Michael O. Newton (newton@csvax.caltech.edu)
	sed -n "827,832p" demo/clx-demos.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright 1990 Massachusetts Institute of Technology, Cambridge,
	sed -n "3,12p" package.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Copyright (C) 1988 Texas Instruments Incorporated.
	sed -n "3,17p" demo/menu.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Public domain: Scott Fahlman
	sed -n "4,7p" cmudep.lisp | cut -c 5- >> "${_license_file}"
	echo "===============================================================" >> "${_license_file}"

	# Public domain: Lionel Flandrin
	sed -n "6,7p" extensions/xtest.lisp | cut -c 5- >> "${_license_file}"

	# Print concatenated copyright notices to for visual inspection
	# in the build jobs.
	cat ${_license_file}

	vlicense ${_license_file}
}
