# Template file for 'snapper'
pkgname=snapper
version=0.12.2
revision=3
build_style=gnu-configure
configure_args="--disable-zypp --disable-systemd --with-conf=/etc/conf.d"
conf_files="/etc/conf.d/snapper"
make_dirs="/etc/snapper/configs 0755 root root"
hostmakedepends="automake docbook-xsl libtool libxml2-devel libxslt
 gettext pkg-config"
makedepends="acl-devel boost-devel-minimal libboost_thread
 dbus-devel e2fsprogs-devel libbtrfs-devel
 libmount-devel libxml2-devel pam-devel ncurses-devel ncurses-libtinfo-devel
 json-c-devel"
depends="dbus"
short_desc="Tool for Linux filesystem snapshot management"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-only"
homepage="http://snapper.io"
distfiles="https://github.com/openSUSE/snapper/archive/v${version}.tar.gz"
checksum=0b902c9e6e4917ae035b60d20166b176e417718b9a853534fff057b14a2cbff8
lib32disabled=yes

if [ "$XBPS_TARGET_LIBC" = musl ]
then
		makedepends+=" gettext-devel"
		LDFLAGS="-lintl"
fi

pre_configure() {
	# rename cron scripts
	sed -i -e 's@suse.de-@@g' scripts/Makefile.am
	# fix config location in cron scripts
	sed -i -e 's@/etc/sysconfig/@/etc/conf.d/@g' scripts/snapper-hourly

	# fix pam plugin install location
	sed -i -e 's@shell echo /@shell echo /usr/@g' pam/Makefile.am

	# boost-1.89
	sed -i -e 's/-lboost_system//' Makefile.am */Makefile.am */**/Makefile.am

	autoreconf -fi
}

post_install() {
	vinstall data/sysconfig.snapper 644 etc/conf.d snapper
	vsv snapperd
}

libsnapper_package() {
	short_desc+=" - runtime library"
	pkg_install() {
		vmove "usr/lib/*.so.*"
	}
}

snapper-devel_package() {
	short_desc+=" - development files"
	depends="libsnapper>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.so"
	}
}
