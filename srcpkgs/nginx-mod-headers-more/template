# Template file for 'nginx-mod-headers-more'
pkgname=nginx-mod-headers-more
version=0.33
revision=1
_nginx_version=1.18.0
create_wrksrc=yes
build_wrksrc="nginx-${_nginx_version}"
build_style=gnu-makefile
make_build_args="modules"
makedepends="pcre-devel"
depends="nginx"
short_desc="Nginx module to set and clear input and output headers"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="BSD-2-Clause"
homepage="https://github.com/openresty/headers-more-nginx-module"
distfiles="https://nginx.org/download/nginx-${_nginx_version}.tar.gz
 https://github.com/openresty/headers-more-nginx-module/archive/v${version}.tar.gz"
checksum="4c373e7ab5bf91d34a4f11a0c9496561061ba5eee6020db272a17a7228d35f99
 a3dcbab117a9c103bc1ea5200fc00a7b7d2af97ff7fd525f16f8ac2632e30fbf"

if [ "$CROSS_BUILD" ]; then
	hostmakedepends="${makedepends}"
fi

do_configure() {
	cd ${wrksrc}/${build_wrksrc}
	if [ "$CROSS_BUILD" ]; then
		# fake configure run on host
		unset CC CPP LD CFLAGS CPPFLAGS LDFLAGS
	fi

	./configure --with-compat \
		--add-dynamic-module=../headers-more-nginx-module-${version}
}

pre_build() {
	if [ "$CROSS_BUILD" ]; then
		case "$XBPS_TARGET_MACHINE" in
			arm*) cp "${FILESDIR}/ngx_auto_config.h.armv6l" objs/ngx_auto_config.h;;
			aarch64*) cp "${FILESDIR}/ngx_auto_config.h.aarch64" objs/ngx_auto_config.h;;
		esac
	fi

	sed -i 's/-lcrypt/$(LDFLAGS) &/' objs/Makefile
}

do_install() {
	vmkdir usr/lib/nginx
	vinstall objs/ngx_http_headers_more_filter_module.so 644 usr/lib/nginx

	vlicense LICENSE
}
