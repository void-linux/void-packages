#!/bin/sh

RunUser=firebird
RunGroup=firebird
databasesconf='/etc/firebird/databases.conf'

# !!! need shielding / !!!
dir_sampledb='\/tmp'
dir_secdb='\/var\/lib\/firebird\/system'

checkfdb(){
[ -e "$@" ] || { echo "$@ - WARNING: No exists!" && return; }
chpst -u $RunUser test -w "$@" && echo "$@ - OK" || { echo "$@ - FIX PERMISSIONS..."; chown $RunUser:$RunGroup "$@" && chmod 660 "$@"; }
}

for i in $(grep '^[^#]*=.*\.fdb.*$' "$databasesconf" | sed "s/#.*//; s/^\(.*= *\)\(.*\)$/\2/; s/\$(dir_sampledb)/$dir_sampledb/i; s/\$(dir_secdb)/$dir_secdb/i") # need more testing
do
	checkfdb "$i"
done

install /dev/null -m 644 -o $RunUser -g $RunGroup /etc/firebird/fb_guard

echo 'DONE.'
