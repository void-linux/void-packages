# Template file for 'azahar'
pkgname=azahar
version=2123.2
revision=1
archs="x86_64* aarch64*"
build_style="cmake"
configure_args="-DCITRA_USE_PRECOMPILED_HEADERS=OFF -DENABLE_QT_TRANSLATION=ON
 -DENABLE_TESTS=OFF -DUSE_DISCORD_PRESENCE=OFF -DUSE_SYSTEM_BOOST=ON
 -DUSE_SYSTEM_CATCH2=ON -DUSE_SYSTEM_CRYPTOPP=ON -DUSE_SYSTEM_FFMPEG_HEADERS=ON
 -DUSE_SYSTEM_FFMPEG_HEADERS=ON -DUSE_SYSTEM_GLSLANG=ON -DUSE_SYSTEM_INIH=ON
 -DUSE_SYSTEM_JSON=ON -DUSE_SYSTEM_LIBUSB=ON -DUSE_SYSTEM_OPENAL=ON
 -DUSE_SYSTEM_OPENSSL=ON -DUSE_SYSTEM_SDL2=ON -DUSE_SYSTEM_SOUNDTOUCH=ON
 -DUSE_SYSTEM_SPIRV_HEADERS=ON -DUSE_SYSTEM_VULKAN_HEADERS=ON
 -DUSE_SYSTEM_ZSTD=OFF -Wno-dev"
hostmakedepends="pkg-config python3 qt6-base qt6-tools"
makedepends="SDL2-devel SPIRV-Headers SPIRV-Tools-devel boost-devel catch2
 crypto++-devel ffmpeg6-devel fmt-devel glslang-devel inih-devel json-c++
 libopenal-devel qt6-base-devel qt6-multimedia-devel soundtouch-devel"
short_desc="Open-source 3DS emulator project based on Citra"
maintainer="Josh Penny <joshpenny@protonmail.com>"
license="GPL-2.0-or-later"
homepage="https://azahar-emu.org"
changelog="https://github.com/azahar-emu/azahar/releases"
distfiles="https://github.com/azahar-emu/azahar/releases/download/${version}/azahar-unified-source-${version}.tar.xz"
checksum="d77ff77392f9f78bfd3543b8cbb8c3a83a6008bf73bf6dd748c4264edb5f82d1"

post_patch() {
	# fix zstd include
	vsed -i src/common/zstd_compression.cpp \
		-e 's%zstd/contrib/seekable_format/%%'

	# force xcb backend
	vsed -i dist/azahar.desktop -e "s|^Exec=|&env QT_QPA_PLATFORM=xcb |"

	# fix aarch64 build
	vsed -i src/video_core/shader/shader_jit_a64_compiler.h \
		-e "/#include <array>/a #include <memory>"
}

post_install() {
	rm -rf ${DESTDIR}/usr/{include,lib}
}
