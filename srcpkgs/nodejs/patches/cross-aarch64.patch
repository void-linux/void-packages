From e6345abf20aaa82460b7fa49ac5c4bc7d3a0d02a Mon Sep 17 00:00:00 2001
From: RFL890 <rfl890mc@gmail.com>
Date: Mon, 13 Nov 2023 09:19:23 -0500
Subject: [PATCH] Fix cross compilation on arm64

---
 configure.py | 2 --
 node.gyp     | 3 +++
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/configure.py b/configure.py
index 62f041ce52..e55c5a6353 100755
--- a/configure.py
+++ b/configure.py
@@ -1268,9 +1268,7 @@ def configure_node(o):
 
   o['variables']['want_separate_host_toolset'] = int(cross_compiling)
 
-  # Enable branch protection for arm64
   if target_arch == 'arm64':
-    o['cflags']+=['-msign-return-address=all']
     o['variables']['arm_fpu'] = options.arm_fpu or 'neon'
 
   if options.node_snapshot_main is not None:
diff --git a/node.gyp b/node.gyp
index 4e614df1a9..ed0ffcc582 100644
--- a/node.gyp
+++ b/node.gyp
@@ -411,6 +411,9 @@
       [ 'node_shared=="true"', {
         'node_target_type%': 'shared_library',
         'conditions': [
+          ['target_arch=="arm64"', {
+            'cflags': ['-msign-return-address=all'],  # Pointer authentication.
+          }],
           ['OS in "aix os400"', {
             # For AIX, always generate static library first,
             # It needs an extra step to generate exp and
-- 
2.42.0

