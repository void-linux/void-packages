# Template file for 'libgdal'
pkgname=libgdal
version=3.2.1
revision=1
# aarch & arm temporary disabled
archs="~aarch* ~armv*"
wrksrc="gdal-${version}"
build_style=gnu-configure
configure_args="
 --with-expat=yes
 --with-liblzma=yes
 --with-opencl=yes
 --with-podofo=yes
 --with-spatialite=yes
 --with-sqlite3=yes
 --with-webp=yes
 --with-zstd=yes
 $(vopt_if kml libkml)
 $(vopt_with postgresql pg)"
hostmakedepends="gettext-devel pkg-config python3-numpy json-c-devel swig"
makedepends="boost-devel expat-devel freexl-devel geos-devel jasper-devel
 json-c-devel libcurl-devel libopenexr-devel libopenjpeg2-devel
 libpodofo-devel libqhull-devel libspatialite-devel libwebp-devel
 libxml2-devel libzstd-devel netcdf-devel ocl-icd-devel opencl-headers
 pcre2-devel proj-devel python3-devel sqlite-devel
 $(vopt_if kml libkml-devel)
 $(vopt_if postgresql postgresql-libs-devel)"
short_desc="Geospatial Data Abstraction Library"
maintainer="Nyx70 <n.y.x@bluewin.ch>"
license="MIT"
homepage="http://www.gdal.org/"
distfiles="https://github.com/OSGeo/gdal/releases/download/v${version}/gdal-${version}.tar.gz"
checksum=43d40ba940e3927e38f9e98062ff62f9fa993ceade82f26f16fab7e73edb572e
subpackages="python3-gdal libgdal-devel libgdal-tools"

build_options="kml postgresql"
build_options_default="kml"

if [ -z "$CROSS_BUILD" ]; then
	makedepends+=" hdf5-devel"
fi

do_build() {
	: ${make_cmd:=make}
	${make_cmd} ${makejobs} ${make_build_args} ${make_build_target}
	# python modules
	rm -f swig/python/*_wrap.cpp
	${make_cmd} -C swig/python generate
	cd swig/python
	${make_cmd} ${makejobs} PYTHON=python3 ${makejobs} ${make_build_args} ${make_build_target}
}

do_install() {
	: ${make_cmd:=make}
	${make_cmd} DESTDIR=${DESTDIR} install
	# python modules
	cd swig/python
	${make_cmd} PYTHON=python3 DESTDIR=${DESTDIR}/ install
}

post_install() {
	vinstall gdal.pc 644 usr/lib/pkgconfig
	vlicense LICENSE.TXT
}

libgdal-tools_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - tools"
	pkg_install() {
		vmove usr/bin
	}
}

libgdal-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/gdal-config
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/*.a
		vmove usr/lib/*.so
	}
}

python3-gdal_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - Python3 bindings"
	pkg_install() {
		vmove usr/bin/*.py
		vmove "usr/lib/python*"
		vlicense $wrksrc/$build_wrksrc/LICENSE.TXT
		vdoc $wrksrc/$build_wrksrc/swig/python/README.rst
		mkdir -p ${PKGDESTDIR}/usr/share/${pkgname}
		cp -r $wrksrc/$build_wrksrc/swig/python/samples ${PKGDESTDIR}/usr/share/${pkgname}/examples
		rm -rf ${PKGDESTDIR}/lib
	}
}
