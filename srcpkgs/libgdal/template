# Template file for 'libgdal'
pkgname=libgdal
version=3.4.3
revision=1
wrksrc="gdal-${version}"
build_style=gnu-configure
configure_args="
 --with-expat=yes
 --with-hdf5=yes
 --with-kml=no
 --with-liblzma=yes
 --with-opencl=yes
 --with-pg=yes
 --with-podofo=yes
 --with-python=yes
 --with-spatialite=yes
 --with-sqlite3=yes
 --with-webp=yes
 --with-zstd=yes"
hostmakedepends="gettext-devel
 json-c-devel
 pkg-config
 python3-numpy
 swig"
makedepends="boost-devel
 expat-devel
 freexl-devel
 geos-devel
 jasper-devel
 json-c-devel
 libcurl-devel
 libopenexr-devel
 libopenjpeg2-devel
 libpodofo-devel
 libqhull-devel
 libwebp-devel
 libxml2-devel
 libzstd-devel
 netcdf-devel
 ocl-icd-devel
 opencl2-headers
 pcre2-devel
 proj-devel
 python3-devel
 sqlite-devel
 postgresql-libs-devel"
short_desc="Geospatial Data Abstraction Library"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT"
homepage="https://gdal.org/"
distfiles="https://github.com/OSGeo/gdal/releases/download/v${version}/gdal-${version}.tar.gz"
checksum=7244962628c82921b4a4903dbb721c7222b7d82ed5928fef55a52f87f68ad1fe
subpackages="python3-gdal libgdal-devel libgdal-tools"

if [ -z "$CROSS_BUILD" ]; then
	makedepends+=" hdf5-devel"
fi

CFLAGS="-pthread -I${XBPS_CROSS_BASE}/${py3_inc}"
LDFLAGS="-L${XBPS_CROSS_BASE}/${py3_lib}"

post_build() {
	if [ "$CROSS_BUILD" ]; then
		export PYPREFIX="$XBPS_CROSS_BASE"
		export PYTHONPATH=${XBPS_CROSS_BASE}/${py3_lib}
		for f in ${XBPS_CROSS_BASE}/${py3_lib}/_sysconfigdata_*; do
			f=${f##*/}
			export _PYTHON_SYSCONFIGDATA_NAME=${f%.py}
		done
	fi
	export LDSHARED="${CC} $CFLAGS -shared $LDFLAGS"

	rm -f swig/python/*_wrap.cpp
	make -C swig/python generate
	cd swig/python
	python3 setup.py build
}

post_install() {
	vinstall gdal.pc 644 usr/lib/pkgconfig
	vlicense LICENSE.TXT
	if [ "$CROSS_BUILD" ]; then
		export PYPREFIX="$XBPS_CROSS_BASE"
		export PYTHONPATH=${XBPS_CROSS_BASE}/${py3_lib}
		for f in ${XBPS_CROSS_BASE}/${py3_lib}/_sysconfigdata_*; do
			f=${f##*/}
			export _PYTHON_SYSCONFIGDATA_NAME=${f%.py}
		done
	fi
	export LDSHARED="${CC} $CFLAGS -shared $LDFLAGS"

	cd swig/python
	python3 setup.py install --prefix=/usr --root=$DESTDIR
}

libgdal-tools_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - tools"
	pkg_install() {
		vmove usr/bin
	}
}

libgdal-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/gdal-config
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/*.a
		vmove usr/lib/*.so
	}
}

python3-gdal_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - Python3 bindings"
	pkg_install() {
		vmove "usr/bin/*.py"
		vmove "usr/lib/python*"
		vdoc swig/python/README.rst
		vmkdir usr/share/python3-gdal
	}
}
