# Template file for 'libgdal'
pkgname=libgdal
version=3.11.4
revision=1
build_style=cmake
build_helper=python3
configure_args="-DGDAL_USE_OPENCL=ON -DUSE_EXTERNAL_GTEST=ON"
hostmakedepends="pkg-config bison swig python3-numpy python3-setuptools"
makedepends="python3-devel freexl-devel c-blosc-devel geos-devel expat-devel
 jasper-devel giflib-devel json-c-devel libcurl-devel libopenexr-devel
 libjpeg-turbo-devel libpng-devel tiff-devel libqhull-devel libwebp-devel
 libxml2-devel liblzma-devel zlib-devel libzstd-devel libdeflate-devel
 netcdf-devel OpenCL-Headers pcre2-devel proj-devel sqlite-devel
 ocl-icd-devel libxerces-c-devel libspatialite-devel armadillo-devel
 postgresql-libs-devel hdf5-devel"
checkdepends="python3-pytest python3-pytest-benchmark python3-filelock
 python3-lxml python3-pytest-sugar python3-pytest-env python3-jsonschema
 gtest-devel"
short_desc="Geospatial Data Abstraction Library"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT"
homepage="https://www.gdal.org"
changelog="https://raw.githubusercontent.com/OSGeo/gdal/master/NEWS.md"
distfiles="https://github.com/OSGeo/gdal/releases/download/v${version}/gdal-${version}.tar.gz
 https://github.com/OSGeo/gdal/releases/download/v${version}/gdalautotest-${version}.tar.gz"
checksum="0fa36ee34d4451db586d2bf78ea0dbfa3b0dfae0516587f8130d21add0ac9dad
 d88502397ae13b65aeb9cee69b010f1808e4db02c769cde49bc9f1bce2932053"

skip_extraction="gdalautotest-${version}.tar.gz"

# "error: static assertion failed: OFF_T should be 64 bits !"
if [ "$XBPS_TARGET_WORDSIZE" = "64" ]; then
	makedepends+=" cfitsio-devel"
fi

if [ -z "$XBPS_CHECK_PKGS" ]; then
	configure_args+=" -DBUILD_TESTING=OFF"
fi

case "$XBPS_TARGET_MACHINE" in
	i686*) CXXFLAGS=-ffloat-store; CFLAGS=-ffloat-store ;;
esac

pre_check() {
	# https://lists.osgeo.org/pipermail/gdal-dev/2025-October/061105.html
	if [ "$XBPS_CHECK_PKGS" != "full" ]; then
		export SKIP_MEM_INTENSIVE_TEST=YES
	else
		export SKIP_MEM_INTENSIVE_TEST=NO
	fi
	export CPL_DEBUG=ON
	# export PYTEST="python3 -m pytest -vv -p no:sugar --color=no"
}

post_extract() {
	vsrcextract -C autotest "gdalautotest-${version}.tar.gz"
}

post_install() {
	vlicense LICENSE.TXT
}

libgdal-tools_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - tools"
	pkg_install() {
		vmove usr/share/man/man1
		vmove usr/share/bash-completion
		vmove usr/bin
	}
}

libgdal-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/gdal-config
		vmove usr/share/man/man1/gdal-config.1
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/cmake
		vmove "usr/lib/*.so"
	}
}

libgdal-python3_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - Python 3 bindings"
	pkg_install() {
		vmove ${py3_sitelib}
	}
}
