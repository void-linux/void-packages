# Template file for 'hare-driver'
pkgname=hare-driver
version=0.24.0
revision=1
archs="x86_64 x86_64-musl aarch64 aarch64-musl riscv64 riscv64-musl"
build_style=gnu-makefile
make_use_env=yes
make_build_target=".bin/hare docs"
make_install_target="install-cmd install-mods"
hostmakedepends="qbe harec scdoc"
depends="qbe-1.2_1 harec-0.24.0_1"
short_desc="Hare build driver"
maintainer="Jonas Fentker <jonas@fentker.eu>"
license="MPL-2.0, GPL-3.0-only"
homepage="https://harelang.org/"
distfiles="https://git.sr.ht/~sircmpwn/hare/archive/${version}.tar.gz"
checksum="7061dad3c79cca51a1662a71b1c6f8ec001f52ef3053dd3c2dbb95ae9beff7bc"

do_configure() {
	ARCH="${XBPS_TARGET_MACHINE%-musl}"

	case "${XBPS_LIBC}" in
		glibc) platform=unknown-linux-gnu ;;
		musl) platform=unknown-linux-musl ;;
	esac

	case "${ARCH}" in
		aarch64) qbetarget=arm64 ;;
		riscv64) qbetarget=rv64 ;;
		x86_64) qbetarget=amd64_sysv ;;
	esac

	cp configs/linux.mk config.mk
	vsed -e "s/^ARCH = x86_64$/ARCH=${ARCH}/" \
	     -e "s/^HARECFLAGS =$/HARECFLAGS = -a${ARCH}/" \
	     -e "s/^QBEFLAGS =$/QBEFLAGS = -t${qbetarget}/" \
	     -e "s/^AARCH64_AS=as$/AARCH64_AS=aarch64-${platform}-as/" \
	     -e "s/^AARCH64_CC=cc$/AARCH64_CC=aarch64-${platform}-cc/" \
	     -e "s/^AARCH64_LD=ld$/AARCH64_LD=aarch64-${platform}-ld/" \
	     -e "s/^RISCV64_AS=as$/RISCV64_AS=riscv64-${platform}-as/" \
	     -e "s/^RISCV64_CC=cc$/RISCV64_CC=riscv64-${platform}-cc/" \
	     -e "s/^RISCV64_LD=ld$/RISCV64_LD=riscv64-${platform}-ld/" \
	     -e "s/^X86_64_AS=as$/X86_64_AS=x86_64-${platform}-as/" \
	     -e "s/^X86_64_CC=cc$/X86_64_CC=x86_64-${platform}-cc/" \
	     -e "s/^X86_64_LD=ld$/X86_64_LD=x86_64-${platform}-ld/" \
	     -e 's|^VERSION=$$(./scripts/version)$|VERSION=0.24.0|' \
	     -e '/^PREFIX/d' \
	     -e '/^AS/d' \
	     -e '/^LD/d' \
	     -i config.mk
}
