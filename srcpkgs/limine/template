# Template file for 'limine'
pkgname=limine
version=2.24
revision=1
archs="x86_64* i686*"
create_wrksrc=yes
hostmakedepends="which nasm mtools git"
short_desc="Advanced x86/x86_64 BIOS and UEFI bootloader"
maintainer="mintsuki <mintsuki@protonmail.com>"
license="BSD-2-Clause"
homepage="https://limine-bootloader.org"
distfiles="
https://github.com/limine-bootloader/limine/archive/refs/tags/v$version.tar.gz
https://github.com/stivale/stivale/archive/f8d1674dfa0241d990339dc52fbaf56319e690a7.tar.gz
https://netcologne.dl.sourceforge.net/project/gnu-efi/gnu-efi-3.0.13.tar.bz2
"
checksum="
8e1dc14b097485c4a36107f701bbd75f27d919a818a01ebe26e82cb2fd0d9172
508035442f453fbda116735d041d18daf3a47fe28d4318ba2e8360a5f3af9f12
2fccf715279c46ee69c4859186af8150d07a13f4d19876e5459cd65be82d3b7d
"

case "$XBPS_TARGET_MACHINE" in
	x86_64);;
	*) hostmakedepends+=" cross-x86_64-linux-gnu";;
esac

pre_build() {
	cd limine-$version
	vsed -i stage23/Makefile -e "s/\$(LIMINE_VERSION)/v$version/g"
	mv ../stivale-f8d1674dfa0241d990339dc52fbaf56319e690a7 ./stivale
	mv ../gnu-efi-3.0.13 ./gnu-efi
}

do_build() {
	cd limine-$version
	if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
		CC="gcc"
		AR="ar"
		unset TOOLCHAIN
	else
		CC="x86_64-linux-gnu-gcc"
		AR="x86_64-linux-gnu-ar"
		TOOLCHAIN="TOOLCHAIN=x86_64-linux-gnu"
	fi
	CFLAGS="" make -C gnu-efi/gnuefi ARCH=x86_64 CC="$CC" AR="$AR"
	CFLAGS="" make -C gnu-efi/lib ARCH=x86_64 CC="$CC" x86_64/efi_stub.o
	CFLAGS="" make $TOOLCHAIN
}

do_install() {
	vbin limine-$version/bin/limine-install
	vinstall limine-$version/bin/limine.sys 644 /usr/share/limine
	vinstall limine-$version/bin/limine-cd.bin 644 /usr/share/limine
	vinstall limine-$version/bin/limine-pxe.bin 644 /usr/share/limine
	vinstall limine-$version/bin/BOOTX64.EFI 644 /usr/share/limine
	vinstall limine-$version/bin/limine-eltorito-efi.bin 644 /usr/share/limine
	vlicense limine-$version/LICENSE.md
}
