# Template file for 'sysdig'
pkgname=sysdig
version=0.41.2
revision=2
_falcover=0.21.0
build_style=cmake
configure_args="-DSYSDIG_VERSION=${version} -DUSE_BUNDLED_DEPS=OFF
 -DUSE_BUNDLED_B64=OFF -DBUILD_DRIVER=OFF
 -DLUA_INCLUDE_DIR=${XBPS_CROSS_BASE}/usr/include/luajit-2.1
 -DLUA_LIBRARY=/usr/lib/libluajit-5.1.so -DCREATE_TEST_TARGETS=OFF
 -DUSE_BUNDLED_JSONCPP=OFF -DUSE_BUNDLED_RE2=OFF -DUSE_BUNDLED_VALIJSON=OFF
 -DUSE_BUNDLED_TBB=OFF -DBUILD_LIBSCAP_EXAMPLES=OFF
 -DUSE_BUNDLED_FALCOSECURITY_LIBS=ON -DBUILD_SYSDIG_MODERN_BPF=OFF
 -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_EXTENSIONS=OFF
 -DDRIVER_VERSION=${_falcover}"
# bpftool needs updated
hostmakedepends="wget pkg-config protobuf clang uthash"
makedepends="LuaJIT-devel c-ares-devel elfutils-devel grpc-devel jsoncpp-devel
 libcurl-devel libprotoc-devel openssl-devel ncurses-devel protobuf-devel
 libb64-devel tbb-devel zlib-devel yaml-cpp-devel json-c++ jq-devel
 re2-devel valijson"
depends="dkms"
short_desc="Open source system-level exploration and troubleshooting tool"
maintainer="Orphaned <orphan@voidlinux.org>"
license="Apache-2.0, MIT, GPL-2.0-only"
homepage="http://www.sysdig.org/"
changelog="https://github.com/draios/sysdig/releases"
distfiles="https://github.com/draios/sysdig/archive/${version}.tar.gz
 https://github.com/falcosecurity/libs/archive/refs/tags/${_falcover}.tar.gz"
checksum="7ca055ce63a43de7dc390b237caeb13455616f84d4f4052c1744f65d9bb6ae2f
 9e977001dd42586df42a5dc7e7a948c297124865a233402e44bdec68839d322a"
dkms_modules="scap ${_falcover}"
nocross=yes

skip_extraction="${_falcover}.tar.gz v${_containerver}.tar.gz"

case "$XBPS_TARGET_MACHINE" in
	i686*) broken="/syscall_table.c:567:10: error: '__NR_rt_tgsigqueueinfo'";;
	*-musl) configure_args+=" -DMUSL_OPTIMIZED_BUILD=On";;
esac

# Avoid excessive warnings spam to the log
CXXFLAGS="-Wno-deprecated-declarations"

post_extract() {
	vsrcextract -C .xbps-falco "${_falcover}.tar.gz"
	vsed -e 's,"${DIR_ETC}/bash_completion.d",share/bash-completion/completions,g' -i scripts/CMakeLists.txt
}

post_install() {
	rm -rf ${DESTDIR}/usr/share/zsh/vendor-completions
	vlicense COPYING
	vlicense NOTICES
}
