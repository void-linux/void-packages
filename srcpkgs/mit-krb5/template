# Template file for 'mit-krb5'
# if there is a bump in .so version,
# also update srcpkgs/libgssglue/files/gssapi_mech.conf
pkgname=mit-krb5
version=1.22.1
revision=1
_distver=$(echo $version | cut -d. -f-2)
build_style=gnu-configure
configure_args="--sbindir=/usr/bin --disable-rpath --with-system-et
 --without-system-verto --with-system-ss --enable-shared --with-system-db
 --with-ldap --with-lmdb"
hostmakedepends="e2fsprogs-devel flex perl pkg-config"
makedepends="e2fsprogs-devel db-devel libldap-devel lmdb-devel"
checkdepends="python3"
short_desc="MIT Kerberos 5 implementation"
maintainer="Klara Modin <klarasmodin@gmail.com>"
license="MIT"
homepage="http://web.mit.edu/kerberos"
distfiles="http://kerberos.org/dist/krb5/${_distver}/krb5-${version}.tar.gz"
checksum=1a8832b8cad923ebbf1394f67e2efcf41e3a49f460285a66e35adec8fa0053af
build_wrksrc="./src"

post_patch() {
	# Fix db plugin.
	vsed -i -e "s|<db.h>|<db_185.h>|" \
		plugins/kdb/db2/{adb_openclose.c,db2_exp.c,kdb_db2.c,policy_db.h}
}

do_check() {
	# Tests sometimes fail randomly when run in parallel
	make -j1 check
}

do_configure() {
	./configure ${configure_args} \
		ac_cv_func_pthread_once=yes ac_cv_func_pthread_rwlock_init=yes \
		acx_pthread_ok=yes ac_cv_func_regcomp=yes ac_cv_printf_positional=yes \
		krb5_cv_attr_constructor_destructor=yes,yes
}

post_install() {
	vsv krb5kdc
	vsv kadmind
	vlicense ../NOTICE
}

mit-krb5-client_package() {
	short_desc+=" - client programs"
	pkg_install() {
		for f in uuclient ktutil kswitch gss-client kvno kinit kpasswd \
			kdestroy sclient kadmin k5srvutil sim_client klist ksu; do
			vmove usr/bin/${f}
			if [ -f ${DESTDIR}/usr/share/man/man1/${f}.1 ]; then
				vmove usr/share/man/man1/${f}.1
			fi
		done
	}
}

mit-krb5-devel_package() {
	depends="${makedepends} mit-krb5-libs>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/bin/krb5-config
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
	}
}

mit-krb5-kdb-ldap_package() {
	short_desc+=" - LDAP database backend"
	pkg_install() {
		vmove usr/bin/kdb5_ldap_util
		vmove usr/lib/krb5/plugins/kdb/kldap.so
		vmove usr/share/man/man8/kdb5_ldap_util.8
		vmove usr/lib/libkdb_ldap.so.*

		for schema in kerberos.{schema,ldif,openldap.ldif}; do
			vdoc plugins/kdb/ldap/libkdb_ldap/$schema
		done
	}
}

mit-krb5-kdb-lmdb_package() {
	short_desc+=" - LMDB database backend"
	pkg_install() {
		vmove usr/lib/krb5/plugins/kdb/klmdb.so
	}
}

mit-krb5-libs_package() {
	short_desc+=" - runtime libraries"
	pkg_install() {
		vmove "usr/lib/*.so.*"
	}
}
