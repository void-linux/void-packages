#!/bin/sh

kver=${2}

cat > /boot/boot.txt <<EOF
# MAC address (use spaces instead of colons)
setenv macaddr da 19 c8 7a 6d f4

part uuid \${devtype} \${devnum}:\${bootpart} uuid
setenv bootargs console=ttyS2,1500000n8 root=PARTUUID=\${uuid} rw rootwait append video=eDP-1:1920x1080@60
setenv fdtfile rockchip/rk3399-pinebook-pro.dtb

if load \${devtype} \${devnum}:\${bootpart} \${kernel_addr_r} /boot/vmlinux-${kver}; then
  if load \${devtype} \${devnum}:\${bootpart} \${fdt_addr_r} /boot/dtbs/dtbs-${kver}/\${fdtfile}; then
    fdt addr \${fdt_addr_r}
    fdt resize
    fdt set /ethernet@fe300000 local-mac-address "[\${macaddr}]"
    if load \${devtype} \${devnum}:\${bootpart} \${ramdisk_addr_r} /boot/initramfs-${kver}.img; then
      # This upstream Uboot doesn't support compresses cpio initrd, use kernel option to
      # load initramfs
      setenv bootargs \${bootargs} initrd=\${ramdisk_addr_r},20M ramdisk_size=10M
    fi;
    booti \${kernel_addr_r} - \${fdt_addr_r};
  fi;
fi
EOF

exec mkimage -A arm -O linux -T script -C none -n "U-Boot boot script" -d /boot/boot.txt /boot/boot.scr
