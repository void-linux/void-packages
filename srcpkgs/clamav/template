# Template file for 'clamav'
pkgname=clamav
version=1.2.0
revision=1
build_style=cmake
build_helper="qemu"
configure_args="-DAPP_CONFIG_DIRECTORY=/etc
 -DDATABASE_DIRECTORY=/var/lib/_clamav
 -DENABLE_JSON_SHARED=ON
 -DCLAMAV_USER=_clamav
 -DCLAMAV_GROUP=_clamav
 -DENABLE_APP=ON
 -DENABLE_MILTER=ON
 -DENABLE_CLAMONACC=ON
 -DENABLE_MAN_PAGES=ON
 -DENABLE_DOXYGEN=OFF
 -DENABLE_EXAMPLES=ON
 -DENABLE_TESTS=ON
 -DENABLE_SHARED_LIB=ON
 -DENABLE_SYSTEMD=OFF
 -DENABLE_UNRAR=OFF"
conf_files="/etc/clamd.conf /etc/freshclam.conf"
hostmakedepends="flex pkg-config zip cargo python3"
makedepends="json-c-devel libcurl-devel libmspack-devel libxml2-devel
 ncurses-devel pcre2-devel tcl-devel check-devel libmilter-devel rust-std"
short_desc="Clam Anti-Virus scanner"
maintainer="Jan Christian Gr√ºnhage <jan.christian@gruenhage.xyz>"
license="GPL-2.0-only"
homepage="https://www.clamav.net/"
changelog="https://raw.githubusercontent.com/Cisco-Talos/clamav/main/NEWS.md"
distfiles="https://www.clamav.net/downloads/production/clamav-${version}.tar.gz"
checksum=97a192dffe141480b56cabf1063d79a9fc55cd59203241fa41bfc7a98a548020
_clamav_homedir="/var/lib/_${pkgname}"
_clamav_descr="ClamAV user"
system_accounts="_clamav"

if [ "$CROSS_BUILD" ]; then
	configure_args+=" -DRUSTFLAGS=${XBPS_CROSS_RUSTFLAGS}"
	configure_args+=" -DRUST_COMPILER_TARGET=${XBPS_CROSS_RUST_TARGET}"
fi

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-fts-devel"
	configure_args+=" -DHAVE_SYSTEM_LFS_FTS=ON"
fi

post_patch() {
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		# CFLAGS="-lfts" doesn't work and we can't use
		# a regular patch because it won't build on glibc
		patch -Np1 < "${FILESDIR}/link-fts.patch"
	fi
}

post_install() {
	vsv clamd
	vsv freshclam
	for service in clamd clamav-milter freshclam; do
		# Enable and patch service configuration
		mv -v ${PKGDESTDIR}/etc/${service}.conf.sample ${PKGDESTDIR}/etc/${service}.conf
		vsconf etc/${service}.conf.sample
		sed -i ${PKGDESTDIR}/etc/${service}.conf \
			-e "s:^\(Example\)$:# \1:" \
			-e "s:#DatabaseDirectory.*:DatabaseDirectory /var/lib/_${pkgname}:"
	done
	sed -i ${PKGDESTDIR}/etc/freshclam.conf \
		-e "s:.*\(PidFile\) .*:\1 /run/clamav/freshclam.pid:" \
		-e "s:^\#\(NotifyClamd\).*:\1 /etc/clamd.conf:"
	sed -i ${PKGDESTDIR}/etc/clamd.conf \
		-e "s:.*\(PidFile\) .*:\1 /run/clamav/clamd.pid:" \
		-e "s:.*\(LocalSocket\) .*:\1 /run/clamav/clamd.sock:"
}

clamav-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/clamav-config
		vmove usr/lib/pkgconfig
		vmove usr/include
		vmove "usr/lib/*.so"
	}
}
