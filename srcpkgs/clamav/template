# Template file for 'clamav'
pkgname=clamav
version=1.2.0
revision=1

_configdir=/etc/clamav
_databasedir=/var/lib/clamav

build_style=cmake
cmake_builddir=build
# Setting ENABLE_JSON_SHARED=OFF is preferred, as libclamav.so may crash if you
# use a different JSON library.
configure_args="
 -D CMAKE_BUILD_TYPE=Release
 -D CMAKE_INSTALL_PREFIX=/usr
 -D APP_CONFIG_DIRECTORY=${_configdir}
 -D DATABASE_DIRECTORY=${_databasedir}
 -D CLAMAV_USER=_clamav
 -D CLAMAV_GROUP=_clamav
 -D ENABLE_JSON_SHARED=OFF"
hostmakedepends="rust cargo python3"
makedepends="bzip2-devel check-devel libcurl-devel json-c-devel libmilter-devel
 libxml2-devel ncurses-devel openssl-devel pcre2-devel zlib-devel"
short_desc="Clam Anti-Virus scanner"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-only"
homepage="https://www.clamav.net/"
changelog="https://raw.githubusercontent.com/Cisco-Talos/clamav/main/NEWS.md"
distfiles="https://www.clamav.net/downloads/production/clamav-${version}.tar.gz"
checksum=97a192dffe141480b56cabf1063d79a9fc55cd59203241fa41bfc7a98a548020
system_accounts="_clamav"
_clamav_homedir=${_databasedir}
conf_files="
 ${_configdir}/clamav-milter.conf
 ${_configdir}/clamd.conf
 ${_configdir}/freshclam.conf"
_sv_files="clamd clamonacc freshclam"

if [ "$CROSS_BUILD" ]; then
	build_helper="qemu"
	makedepends+=" rust-std"
	configure_args+="
	 -D RUST_COMPILER_TARGET:STRING=${XBPS_CROSS_RUST_TARGET}
	 -D RUSTFLAGS=${XBPS_CROSS_RUSTFLAGS}"
fi

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-fts-devel"
	configure_args+=" -D CMAKE_EXE_LINKER_FLAGS=-lfts"
fi

post_install() {
	vmkdir ${_configdir}
	for sv in ${_sv_files}; do vsv "${sv}"; done
	for path in ${conf_files}; do
		name=${path#"${_configdir}"/}

		mv -v "${PKGDESTDIR}"/"${path}".sample "${PKGDESTDIR}"/"${path}"
		vsconf "${PKGDESTDIR}"/"${path}" "${name}".sample
		sed -i "${PKGDESTDIR}"/"${path}" -e "s;^Example$;# Example;"
	done
	vdoc "${FILESDIR}"/README.voidlinux

}

clamav-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/clamav-config
		vmove usr/lib/pkgconfig
		vmove usr/include
		vmove "usr/lib/*.so"
	}
}
