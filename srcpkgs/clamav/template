# Template file for 'clamav'
pkgname=clamav
version=1.5.0
revision=1
build_style=cmake
build_helper="qemu rust"
configure_args="-DCLAMAV_USER=_clamav -DCLAMAV_GROUP=_clamav
 -DAPP_CONFIG_DIRECTORY=/etc -DDATABASE_DIRECTORY=/var/lib/_clamav
 -DENABlE_WERROR=NO -DENABLE_SYSTEMD=NO -DENABLE_FUZZ=NO -DENABLE_APP=ON"
conf_files="/etc/clamd.conf /etc/freshclam.conf"
hostmakedepends="flex pkg-config zip cargo cargo-auditable python3"
makedepends="json-c-devel libcurl-devel libmspack-devel libxml2-devel
 ncurses-devel pcre2-devel tcl-devel check-devel libmilter-devel
 openssl-devel bzip2-devel zlib-devel rust-std"
short_desc="Clam Anti-Virus scanner"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-2.0-only"
homepage="https://www.clamav.net/"
distfiles="https://www.clamav.net/downloads/production/clamav-${version}.tar.gz"
checksum=09026c8b912b6c2a593d325318e99df7d763c9df013fff0d48ef3b2215fb53ee
_clamav_homedir="/var/lib/_clamav"
_clamav_descr="ClamAV user"
system_accounts="_clamav"
make_check=ci-skip

CFLAGS="-UNDEBUG -Wno-unused-local-typedefs"
CXXFLAGS="-UNDEBUG -Wno-unused-local-typedefs"
if [ "$CROSS_BUILD" ]; then
	configure_args+=" -DRUST_COMPILER_TARGET=$XBPS_CROSS_RUST_TARGET"
fi

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" musl-fts-devel"
	configure_args+=" -DCMAKE_C_STANDARD_LIBRARIES=-lfts"
	configure_args+=" -DCMAKE_CXX_STANDARD_LIBRARIES=-lfts"
	configure_args+=" -DCMAKE_REQUIRED_LIBRARIES=fts"
fi

post_install() {
	# Enable and patch clamd configuration
	mv -v ${PKGDESTDIR}/etc/clamd.conf.sample ${PKGDESTDIR}/etc/clamd.conf
	vsconf etc/clamd.conf.sample
	sed -i "
		/^Example$/s/^/# /
		s/^#User .*/User _clamav/
	" ${PKGDESTDIR}/etc/clamd.conf

	# Enable and patch freshclam configuration
	mv -v ${PKGDESTDIR}/etc/freshclam.conf.sample ${PKGDESTDIR}/etc/freshclam.conf
	vsconf etc/freshclam.conf.sample
	sed -i "
		/^Example$/s/^/# /
	" ${PKGDESTDIR}/etc/freshclam.conf
	vdoc "${FILESDIR}/README.voidlinux"
	vsv clamd
}

clamav-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/clamav-config
		vmove usr/lib/pkgconfig
		vmove usr/include
		vmove "usr/lib/*.so"
	}
}
