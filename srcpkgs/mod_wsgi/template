# Template file for 'mod_wsgi'
pkgname=mod_wsgi
version=5.0.2
revision=1
build_style=gnu-configure
configure_args="--with-python=python3"
hostmakedepends="python3 perl automake libtool"
makedepends="apache-devel python3-devel apr-devel"
short_desc="Python WSGI adapter module for Apache"
maintainer="Orphaned <orphan@voidlinux.org>"
license="Apache-2.0"
homepage="https://modwsgi.readthedocs.io/en/develop/"
changelog="https://modwsgi.readthedocs.io/en/latest/release-notes/version-${version}.html"
distfiles="https://github.com/GrahamDumpleton/mod_wsgi/archive/${version}.tar.gz"
checksum=9a0fdb61405abc300ec6b100c440dd98cf31cb5f97aeef4207390937298cad20
lib32disabled=yes

pre_configure() {
	if [ "$CROSS_BUILD" ]; then
		cp -a ${XBPS_CROSS_BASE}/usr/bin/apxs ${wrksrc}
		cp -a "$("${XBPS_CROSS_BASE}/usr/bin/apr-1-config" --apr-libtool)" \
			./libtool

		# Use the modified apxs
		configure_args+=" --with-apxs=${wrksrc}/apxs"
		configure_args+=" PYTHON_VERSION=$py3_ver PYTHON_LDVERSION=$py3_ver"

		# Modify libtool to use the right compiler and linker
		vsed -i libtool \
			-e "s/^CC=.*/CC='${CC}'/" \
			-e "s/^LD=.*/LD='${LD}'/" \
			-e "s/^LTCC=.*/LTCC='${CC}'/"

		vsed -i apxs \
			-e 's|my \$libtool =.*|my $libtool = "./libtool";|' \
			-e '/my [$]ltflags /s/=.*/= "--tag=CC";/' \
			-e "/my [$]destdir/s%=.*%= \"$XBPS_CROSS_BASE\";%"
	fi
	autoreconf -fi
}
