# Template file for 'jellyfin'
pkgname=jellyfin
version=10.5.0
revision=1
wrksrc="${pkgname}-${version}"
create_wrksrc=yes
archs="i686 x86_64 aarmv7l aarch64"
build_style=meta
hostmakedepends="dotnet-sdk-bin yarn"
makedepends="icu-devel libssl47 git"
depends="ffmpeg sqlite"
short_desc="Free Software Media System "
maintainer="Abel Tesfaye <abel-tesfaye@hotmail.com>"
license="GPL-2.0-or-later"
homepage="https://jellyfin.readthedocs.io"
distfiles="
 https://github.com/${pkgname}/${pkgname}/archive/v${version}.tar.gz>${pkgname}-${version}.tar.gz
 https://github.com/${pkgname}/${pkgname}-web/archive/v${version}.tar.gz>${pkgname}-web-${version}.tar.gz"
checksum="
 f5631758c2a175ae04bedd6d8f8566b2222b14254261bdf29019ecdffde0dddd
 e50b280e805469367bedfef41c32070907e191d4a856b92049e6f6fd558e1dea"
nopie=yes

system_accounts="jellyfin"
jellyfin_homedir="/var/lib/jellyfin"

do_build() {
  cd jellyfin-web-${version}
  yarn install

  # https://docs.microsoft.com/de-de/dotnet/core/rid-catalog#linux-rids
  case "${XBPS_TARGET_MACHINE}" in
    i686) _build_arch="x86";;
    x86_64) _build_arch="x64";;
    armv7l) _build_arch="arm";;
    aarch64) _build_arch="arm64";;
  esac

  cd ../jellyfin-${version}

  export DOTNET_CLI_TELEMETRY_OPTOUT=1
  export CLR_OPENSSL_VERSION_OVERRIDE=47
  dotnet build -r "linux-${_build_arch}" --configuration Release Jellyfin.Server
  dotnet publish -r "linux-${_build_arch}" --configuration Release Jellyfin.Server --output "$PWD"/publish
  rm -rfv publish/runtimes/{alpine-*,osx*,tizen-*,win*,linux-musl-x64,linux-armel}

  test "${XBPS_TARGET_MACHINE}" = 'i686' || rm -rfv publish/runtimes/linux-x86
  test "${XBPS_TARGET_MACHINE}" = 'x86_64' || rm -rfv publish/runtimes/linux-x64
  test "${XBPS_TARGET_MACHINE}" = 'armv7l' || rm -rfv publish/runtimes/linux-arm
  test "${XBPS_TARGET_MACHINE}" = 'aarch64' || rm -rfv publish/runtimes/linux-arm64
  
  mkdir publish/jellyfin-web
  cp -rv ../jellyfin-web-${version}/dist/. publish/jellyfin-web
}

do_install() {
  vmkdir usr/lib/jellyfin
  #vmkdir etc/default
  #vcopy "${FILESDIR}/jellyfin.default" etc/default/jellyfin 
  vcopy "${pkgname}-${version}/publish/." usr/lib/jellyfin
  #vsv jellyfin
}