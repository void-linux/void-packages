From f29763eb241cb9891f67d5764eac47a3f8b73073 Mon Sep 17 00:00:00 2001
From: Daniel Kolesa <daniel@octaforge.org>
Date: Tue, 21 Dec 2021 02:46:30 +0100
Subject: [PATCH 11/15] allow specifying native sysroot to use for linkage

This allows us to get around the linker attempting to use
incompatible libs.
---
 src/bootstrap/src/core/builder/cargo.rs      | 4 ++++
 src/bootstrap/src/core/config/config.rs      | 2 ++
 src/bootstrap/src/core/config/toml/target.rs | 2 ++
 src/bootstrap/src/lib.rs                     | 4 ++++
 4 files changed, 12 insertions(+)

diff --git a/src/bootstrap/src/core/builder/cargo.rs b/src/bootstrap/src/core/builder/cargo.rs
index 03f66ac91..9de6dd773 100644
--- a/src/bootstrap/src/core/builder/cargo.rs
+++ b/src/bootstrap/src/core/builder/cargo.rs
@@ -293,6 +293,10 @@ impl Cargo {
             self.hostflags.arg(&arg);
         }
 
+        if let Some(sysroot) = builder.native_sysroot(target) {
+            self.rustflags.arg(&format!("-Clink-args=--sysroot={}", sysroot.display()));
+        }
+
         if let Some(target_linker) = builder.linker(target) {
             let target = crate::envify(&target.triple);
             self.command.env(format!("CARGO_TARGET_{target}_LINKER"), target_linker);
diff --git a/src/bootstrap/src/core/config/config.rs b/src/bootstrap/src/core/config/config.rs
index 09ccda806..f0b9ba34a 100644
--- a/src/bootstrap/src/core/config/config.rs
+++ b/src/bootstrap/src/core/config/config.rs
@@ -844,6 +844,7 @@ impl Config {
                     default_linker_linux_override: target_default_linker_linux_override,
                     linker: target_linker,
                     split_debuginfo: target_split_debuginfo,
+                    sysroot: target_sysroot,
                     llvm_config: target_llvm_config,
                     llvm_has_rust_patches: target_llvm_has_rust_patches,
                     llvm_filecheck: target_llvm_filecheck,
@@ -921,6 +922,7 @@ impl Config {
                 target.ar = target_ar.map(PathBuf::from);
                 target.ranlib = target_ranlib.map(PathBuf::from);
                 target.linker = target_linker.map(PathBuf::from);
+                target.sysroot = target_sysroot.map(PathBuf::from);
                 target.crt_static = target_crt_static;
                 target.default_linker = target_default_linker;
                 target.default_linker_linux_override = default_linker_linux_override;
diff --git a/src/bootstrap/src/core/config/toml/target.rs b/src/bootstrap/src/core/config/toml/target.rs
index 119f8d512..01de2a422 100644
--- a/src/bootstrap/src/core/config/toml/target.rs
+++ b/src/bootstrap/src/core/config/toml/target.rs
@@ -30,6 +30,7 @@ define_config! {
         default_linker_linux_override: Option<DefaultLinuxLinkerOverride> = "default-linker-linux-override",
         linker: Option<String> = "linker",
         split_debuginfo: Option<String> = "split-debuginfo",
+        sysroot: Option<String> = "sysroot",
         llvm_config: Option<String> = "llvm-config",
         llvm_has_rust_patches: Option<bool> = "llvm-has-rust-patches",
         llvm_filecheck: Option<String> = "llvm-filecheck",
@@ -65,6 +66,7 @@ pub struct Target {
     pub default_linker_linux_override: DefaultLinuxLinkerOverride,
     pub linker: Option<PathBuf>,
     pub split_debuginfo: Option<SplitDebuginfo>,
+    pub sysroot: Option<PathBuf>,
     pub sanitizers: Option<bool>,
     pub profiler: Option<StringOrBool>,
     pub rpath: Option<bool>,
diff --git a/src/bootstrap/src/lib.rs b/src/bootstrap/src/lib.rs
index 3f609f3ce..c2909b7b0 100644
--- a/src/bootstrap/src/lib.rs
+++ b/src/bootstrap/src/lib.rs
@@ -1388,6 +1388,10 @@ impl Build {
         }
     }
 
+    fn native_sysroot(&self, target: TargetSelection) -> Option<&Path> {
+        self.config.target_config.get(&target).and_then(|c| c.sysroot.as_ref()).map(|p| &**p)
+    }
+
     /// Returns the `lib` directory for the WASI target specified, if
     /// configured.
     ///
-- 
2.51.2

