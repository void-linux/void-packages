# Template file for 'pypy3.6'
pkgname=pypy3.6
version=7.1.0
revision=1
wrksrc="pypy3.6-v${version}-src"
hostmakedepends="pkg-config python python-cffi"
makedepends="bzip2-devel gdbm-devel libffi-devel liblzma-devel
 libressl-devel ncurses-devel sqlite-devel tk-devel zlib-devel"
short_desc="JIT-enabled implementation of Python 3.6 written in RPython"
license="MIT"
homepage="http://pypy.org/"
distfiles="https://bitbucket.org/pypy/pypy/downloads/pypy3.6-v${version}-src.tar.bz2"
checksum=faa81f469bb2a7cbd22c64f22d4b4ddc5a1f7c798d43b7919b629b932f9b1c6f
nocross="Tries to execute cross-compiled code"

do_build() {
	case "$XBPS_TARGET_MACHINE" in
	*-musl)
		patch -Np0 -i ${FILESDIR}/musl.patch
		;;
	esac

	cd pypy/goal
	python ../../rpython/bin/rpython --opt=jit --cc=${CC} \
		--make-jobs=$XBPS_MAKEJOBS
	PYTHONPATH=../.. ./pypy3-c ../tool/build_cffi_imports.py
}

do_install() {
	vdoc README.rst
	vlicense LICENSE
	vmkdir /opt
	vmkdir /usr/bin
	# Upstream recommends installing under /opt and symlinking
	python pypy/tool/release/package.py --archive-name=$pkgname \
		--targetdir=. --no-keep-debug
	tar -xpf $pkgname.tar.bz2 -C ${PKGDESTDIR}/opt
	ln -s /opt/$pkgname/bin/pypy3 ${PKGDESTDIR}/usr/bin/$pkgname
}
