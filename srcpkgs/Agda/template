# Template file for 'Agda'
pkgname=Agda
version=2.6.1.2
revision=1
build_style=haskell-stack
make_build_args="--flag Agda:enable-cluster-counting"
makedepends="icu-devel zlib-devel ncurses-devel"
short_desc="Dependently typed functional programming language and proof assistant"
maintainer="Tsung-Ju Chiang <tsungju+void@pm.me>"
license="custom:Agda"
homepage="https://wiki.portal.chalmers.se/agda"
distfiles="http://hackage.haskell.org/package/${pkgname}-${version}/${pkgname}-${version}.tar.gz"
checksum=08703073c4a5bce89ea64931ac891245dc42dea44b59bed837614811a213072d
nopie_files="/usr/libexec/agda /usr/libexec/agda-mode"
nocross=yes

do_patch() {
	cp stack-8.8.4.yaml stack.yaml

	# Make the output directory more predictable
	cat >>stack.yaml <<-EOF
	configure-options:
	  Agda:
	  - --datasubdir=Agda
	EOF
}

do_install() {
	local _stack_args="--system-ghc --skip-ghc-check"
	local _local_install_root=$(STACK_ROOT="$wrksrc/.stack" stack ${_stack_args} path --local-install-root)

	vbin ${FILESDIR}/agda
	vbin ${FILESDIR}/agda-mode

	vmkdir usr/libexec
	STACK_ROOT="$wrksrc/.stack" stack ${_stack_args} install \
	       	${make_build_args} --local-bin-path=${DESTDIR}/usr/libexec

	vmkdir usr/share/Agda
	vcopy "$_local_install_root/share/Agda/*" usr/share/Agda

	vlicense LICENSE
}
