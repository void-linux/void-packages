# Template file for 'decklink'
pkgname=decklink
version=15.2
revision=1
archs="x86_64 aarch64"
hostmakedepends="curl"
depends="dkms"
short_desc="Drivers for Blackmagic Design DeckLink"
maintainer="Michael Aldridge <maldridge@voidlinux.org>"
license="custom:Proprietary"
homepage="https://www.blackmagicdesign.com/support/family/capture-and-playback"
distfiles="" # gets filled in by pre_fetch
checksum=257d2420ce295307163875463e5f60007ab7d3831c506f188dc3bad672a3eb29
restricted="Requires agreement to an external EULA"
nopie_files="/usr/lib/blackmagic/DesktopVideo/DesktopVideoUpdateTool
 /usr/lib/blackmagic/DesktopVideo/BlackmagicDesktopVideoSetup
 /usr/lib/blackmagic/DesktopVideo/DesktopVideoUpdater
 /usr/lib/blackmagic/DesktopVideo/DesktopVideoNotifier
 /usr/lib/blackmagic/DesktopVideo/DesktopVideoHelper"

# This is magic pulled from the pkgbuild provided for arch.
_pkgsrc_url="https://www.blackmagicdesign.com/api/register/us/download/aa20aa867f12463ba7cac0879784c465"
_pkgsrc_file=${pkgname}-${version}.tar.gz

pre_fetch() {
	distfiles="$(curl \
		  -s \
		  -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:53.0) Gecko/20100101 Firefox/53.0" \
		  -H 'Content-Type: application/json;charset=utf-8' \
		  --data "{\"country\":\"us\",\"platform\":\"Linux\"}" \
		  "${_pkgsrc_url}" \
	      )>$_pkgsrc_file"
}

do_extract() {
	vextract -C $wrksrc $XBPS_SRCDISTDIR/$pkgname-$version/$_pkgsrc_file
}

do_install() {
	case $XBPS_TARGET_MACHINE in
		x86_64)
			vextract -C $DESTDIR other/x86_64/desktopvideo-${version}a1-x86_64.tar.gz
			;;
		aarch64)
			vextract -C $DESTDIR other/aarch64/desktopvideo-${version}a1-aarch64.tar.gz
			;;
	esac

	vsv DesktopVideoHelper
}

post_install() {
	vmkdir usr/lib/udev/rules.d
	vmkdir usr/lib/dracut/dracut.conf.d
	mv $DESTDIR/etc/udev/rules.d/* $DESTDIR/usr/lib/udev/rules.d/
	mv $DESTDIR/etc/dracut.conf.d/* $DESTDIR/usr/lib/dracut/dracut.conf.d/

	rm -rf $DESTDIR/etc/init $DESTDIR/etc/init.d
	vlicense License.txt
}
