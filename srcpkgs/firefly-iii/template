# Template file for 'firefly-iii'
pkgname=firefly-iii
version=5.7.15
revision=1
conf_files="/etc/webapps/firefly-iii/firefly-iii.conf"
hostmakedepends="composer8.0 unzip"
depends="php8.0 php8.0-intl php8.0-sodium php8.0-gd"
short_desc="Web-based personal finances manager"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="AGPL-3.0-or-later"
homepage="https://github.com/firefly-iii/firefly-iii"
changelog="https://raw.githubusercontent.com/firefly-iii/firefly-iii/main/changelog.md"
distfiles="https://github.com/firefly-iii/firefly-iii/archive/refs/tags/${version}.tar.gz"
checksum=546de04f751e6e1e06546ad9256ffe25e3d17a6146ce6715b8e2b98918b1d058
make_dirs="/var/lib/firefly-iii/storage 0750 http http
 /var/lib/firefly-iii/storage/app/public 0750 http http
 /var/lib/firefly-iii/storage/build 0750 http http
 /var/lib/firefly-iii/storage/database 0750 http http
 /var/lib/firefly-iii/storage/debugbar 0750 http http
 /var/lib/firefly-iii/storage/export 0750 http http
 /var/lib/firefly-iii/storage/framework/cache/data 0750 http http
 /var/lib/firefly-iii/storage/framework/sessions 0750 http http
 /var/lib/firefly-iii/storage/framework/testing 0750 http http
 /var/lib/firefly-iii/storage/framework/views 0750 http http
 /var/lib/firefly-iii/storage/framework/views/v1 0750 http http
 /var/lib/firefly-iii/storage/logs 0750 http http
 /var/lib/firefly-iii/storage/upload 0750 http http
 /var/cache/firefly-iii 0750 http http"

do_build() {
	composer8.0 install --no-scripts --no-dev --ignore-platform-reqs
}

do_install() {
	vmkdir usr/share/webapps/firefly-iii
	for i in .htaccess app app.json artisan bootstrap composer.json config \
	 database frontend index.php public resources routes server.php vendor \
	 webpack.mix.js; do
		vcopy "$i" usr/share/webapps/firefly-iii
	done

	vsconf .env.example firefly-iii.conf
	vsconf nginx_app.conf

	vinstall .env.example 644 /etc/webapps/firefly-iii firefly-iii.conf
	ln -s /etc/webapps/firefly-iii/firefly-iii.conf "${DESTDIR}"/usr/share/webapps/firefly-iii/.env

	ln -s /var/lib/firefly-iii/storage "${DESTDIR}"/usr/share/webapps/firefly-iii

	rm -rf "${DESTDIR}"/usr/share/webapps/firefly-iii/bootstrap/cache
	ln -s /var/cache/firefly-iii "${DESTDIR}"/usr/share/webapps/firefly-iii/bootstrap/cache

	vlicense LICENSE
}
