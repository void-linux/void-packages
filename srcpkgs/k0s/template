# Template file for 'k0s'
pkgname=k0s
version=1.22.2.0
revision=1
_version=${version%.*}+k0s.${version##*.}
wrksrc="${pkgname}-${_version//+/-}"
build_style=go
go_import_path=github.com/k0sproject/k0s
hostmakedepends="which golangci-lint"
depends="kubernetes containerd konnectivity-server etcd"
short_desc="Zero Friction Kubernetes"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="Apache-2.0"
homepage="https://k0sproject.io/"
distfiles="https://github.com/k0sproject/$pkgname/archive/v${_version}.tar.gz"
checksum=42d4f52a5eddd19128648c2c5510217882e0ef0a880181a2a140bc46ed61728d
system_accounts="_k0s"
make_dirs="/var/lib/k0s 0755 _k0s _k0s"
_k0s_homedir="/var/lib/k0s"
_k0s_descr="k0s server user"
conf_files="
	/etc/default/*"
if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" k0s"
fi

pre_build() {
	# Make sure files are generated correctly before actually building
	make EMBEDDED_BINS_BUILDMODE=none \
		static/gen_manifests.go \
		pkg/assets/zz_generated_offsets_linux.go
}

post_install() {
	vsv k0s
	vinstall ${FILESDIR}/k0s.default 644 /etc/default/ k0s

	vsv k0s-worker
	vinstall ${FILESDIR}/k0s-worker.default 644 /etc/default/ k0s-worker
}
