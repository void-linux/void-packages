# Template file for 'dotnet9'
pkgname=dotnet9
version=9.0.8
revision=1
archs="x86_64"
metapackage=yes
hostmakedepends="clang cmake curl git llvm tar"
makedepends="brotli-devel icu-devel mit-krb5-devel lttng-ust-devel libunwind-devel nodejs-devel openssl-devel python3 zlib-devel"
depends="aspnet9-runtime aspnet9-targeting-pack dotnet9-apphost-pack dotnet-host dotnet9-hostfxr dotnet9-netstandard-pack dotnet9-runtime dotnet9-sdk dotnet9-sdk-aot dotnet9-targeting-pack"
short_desc="Microsoft .NET version 9 meta package"
maintainer="Naiko <glclaritas@gmail.com>"
license="MIT"
homepage="https://dotnet.microsoft.com"

# sdk_ver same as dotnet tag
_sdk_ver="9.0.109"
_source_commit="a1e39f97e51f1d381385d2dc6c94b368ea333784"
_source_repository="https://github.com/dotnet/dotnet"
_release_dir="${XBPS_BUILDDIR}/${pkgname}-${version}/artifacts/assets/Release"

distfiles="https://github.com/dotnet/dotnet/archive/refs/tags/v${_sdk_ver}.tar.gz"
checksum="42fdfe3733884a3f6ceb3b428ff346ccb92f95010c447e27f3b164f70145730c"

if [ "$XBPS_TARGET_LIBC" = "glibc" ]; then
	depends+=" glibc libgcc"
fi

do_configure() {
	export DOTNET_CLI_TELEMETRY_OPTOUT=1
	./prep-source-build.sh
}

do_build() {
	./build.sh \
		--source-build \
		--online \
		--source-repository https://github.com/dotnet/dotnet \
		--source-version ${_source_commit} \
		--clean-while-building
}

aspnet9-runtime_package() {
	short_desc="ASP.NET core runtime 9"
	depends="dotnet9-runtime"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./shared/Microsoft.AspNetCore.App
		vlicense "LICENSE.TXT"
	}
}
aspnet9-targeting-pack_package() {
	short_desc="ASP.NET core targeting pack 9"
	depends="dotnet9-targeting-pack"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./packs/Microsoft.AspNetCore.App.Ref
		vlicense "LICENSE.TXT"
	}
}
dotnet9-apphost-pack_package() {
	short_desc=".NET core targeting pack 9"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./packs/Microsoft.NETCore.App.Host.void-x64
		vlicense "LICENSE.TXT"
	}
}
dotnet9-artifacts_package() {
	short_desc="Source built artifacts for building SDK"
	pkg_install() {
		vmkdir "usr/lib/dotnet/source-built-artifacts"
		vcopy "${_release_dir}/Private.SourceBuilt.Artifacts.*.tar.gz" "usr/lib/dotnet/source-built-artifacts"
	}
}
dotnet-host_package() {
	short_desc=".NET core command line interface"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./dotnet
		vmkdir "usr/bin"
		ln -s "/usr/lib/dotnet/dotnet" "${PKGDESTDIR}/usr/bin/dotnet"
		vmkdir "etc/profile.d"
		vcopy "${FILESDIR}/dotnet.sh" "etc/profile.d"
		vcopy "LICENSE.TXT" "usr/lib/dotnet"
		vcopy "THIRD-PARTY-NOTICES.txt" "usr/lib/dotnet"
		vlicense "LICENSE.TXT"
		for f in src/sdk/documentation/manpages/sdk/*.1; do
			vman $f
		done
		vcompletion src/sdk/scripts/register-completions.bash bash dotnet
		vcompletion src/sdk/scripts/register-completions.zsh zsh dotnet
	}
}
dotnet9-hostfxr_package() {
	short_desc=".NET command line host resolver 9"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./host
		vlicense "LICENSE.TXT"
	}
}
dotnet9-netstandard-pack_package() {
	short_desc=".NET core standard targeting pack 9"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./packs/NETStandard.Library.Ref
		vlicense "LICENSE.TXT"
	}
}
dotnet9-runtime_package() {
	short_desc=".NET core runtime 9"
	depends="icu-libs glibc libssl3 libstdc++ lttng-ust libunwind mit-krb5-libs zlib"
	if [ "$XBPS_TARGET_LIBC" = "glibc" ]; then
		depends+=" libgcc"
	fi
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./shared/Microsoft.NETCore.App
		vlicense "LICENSE.TXT"
	}
}
dotnet9-sdk_package() {
	short_desc=".NET SDK 9"
	depends="dotnet9-runtime"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./{sdk,sdk-manifests,templates}
		vlicense "LICENSE.TXT"
	}
}
dotnet9-sdk-aot_package() {
	short_desc="Ahead-of-time (AOT) support for the .NET SDK 9"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./packs/runtime.void-x64.Microsoft.DotNet.ILCompiler
		vlicense "LICENSE.TXT"
	}
}
dotnet9-targeting-pack_package() {
	short_desc=".NET core targeting pack 9"
	depends="dotnet9-netstandard-pack"
	pkg_install() {
		vmkdir "usr/lib/dotnet"
		tar xf "${_release_dir}/dotnet-sdk-${_sdk_ver}-void-x64.tar.gz" -C "${PKGDESTDIR}/usr/lib/dotnet" ./packs/Microsoft.NETCore.App.Ref
		vlicense "LICENSE.TXT"
	}
}
