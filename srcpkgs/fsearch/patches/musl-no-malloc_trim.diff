diff --git a/meson.build b/meson.build
index 0e26bf5..9114af6 100644
--- a/meson.build
+++ b/meson.build
@@ -12,7 +12,10 @@ cc = meson.get_compiler('c')
 gnome = import('gnome')
 i18n = import('i18n')
 
+have_malloc_trim = cc.has_function('malloc_trim')
+
 config_h = configuration_data()
+config_h.set('HAVE_MALLOC_TRIM', have_malloc_trim)
 config_h.set_quoted('APP_ID', app_id)
 config_h.set_quoted('PACKAGE_VERSION', meson.project_version())
 config_h.set_quoted('VERSION', meson.project_version())
diff --git a/src/fsearch_database.c b/src/fsearch_database.c
index 8dcc9d0..80518b7 100644
--- a/src/fsearch_database.c
+++ b/src/fsearch_database.c
@@ -25,7 +25,11 @@
 #include <fcntl.h>
 #include <fnmatch.h>
 #include <glib/gi18n.h>
+
+#ifdef HAVE_MALLOC_TRIM
 #include <malloc.h>
+#endif
+
 #include <stdbool.h>
 #include <stdio.h>
 #include <string.h>
@@ -1459,7 +1463,9 @@ db_free(FsearchDatabase *db) {
 
     g_clear_pointer(&db, free);
 
+#ifdef HAVE_MALLOC_TRIM
     malloc_trim(0);
+#endif
 
     g_debug("[db_free] freed");
 }
