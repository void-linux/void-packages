# Template file for 'libvirt'
pkgname=libvirt
version=11.4.0
revision=1
build_style=meson
configure_args="-Dqemu_user=libvirt -Dqemu_group=libvirt -Drunstatedir=/run
 -Dpolkit=enabled"
hostmakedepends="automake dnsmasq docbook-xsl gettext gettext-devel iptables
 libapparmor-devel libtool libxslt lvm2 parted perl pkg-config python3-docutils
 rpcsvc-proto"
makedepends="readline-devel libcap-ng-devel attr-devel gnutls-devel
 libsasl-devel libcurl-devel libpcap-devel libxml2-devel libparted-devel
 device-mapper-devel eudev-libudev-devel libblkid-devel libpciaccess-devel
 avahi-libs-devel polkit-devel jansson-devel python3-devel libssh2-devel
 fuse-devel libtirpc-devel libapparmor-devel json-c-devel bash-completion
 libssh-devel acl-devel libaudit-devel libnuma-devel"
depends="iptables dnsmasq"
short_desc="Virtualization API for controlling virtualization engines"
maintainer="Orphaned <orphan@voidlinux.org>"
license="LGPL-2.1-or-later"
homepage="https://libvirt.org"
changelog="https://libvirt.org/news.html"
distfiles="https://libvirt.org/sources/libvirt-${version}.tar.xz"
checksum=e10059efc655532b0cfe44d961c87c5a56e45393cc7bd343bd3348b40d73b267

case "$XBPS_TARGET_MACHINE" in
	x86_64*) makedepends+=" xen-devel" ;;
	*) ;;
esac

case "$XBPS_TARGET_MACHINE" in
	*-musl) ;;
	*)
                # glusterfs is currently broken with musl-libc
		makedepends+=" glusterfs-devel "
		;;
esac

conf_files="
 /etc/libvirt/nwfilter/*.xml
 /etc/libvirt/qemu/networks/*.xml
 /etc/libvirt/*.conf"

make_dirs="
 /var/lib/libvirt/uml 0755 root root
 /var/lib/libvirt/qemu/nvram 0755 root root
 /var/lib/libvirt/qemu/channel/target 0755 root root
 /var/lib/libvirt/network 0755 root root
 /var/lib/libvirt/lxc 0755 root root
 /var/lib/libvirt/lockd/files 0755 root root
 /var/lib/libvirt/libxl 0755 root root
 /var/lib/libvirt/images 0755 root root
 /var/lib/libvirt/filesystems 0755 root root
 /var/lib/libvirt/dnsmasq 0755 root root
 /var/lib/libvirt/boot 0755 root root
 /var/cache/libvirt/qemu 0755 root root"

post_patch() {
	# Upstream doesn't want to accept this patch from Alpine, but libvirt
	# is broken on musl without it, so apply it only for musl
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		patch -Np0 < ${FILESDIR}/musl-fork-nofree.patch
	fi
}

pre_build() {
        # Remove specific tests because they timeout on CI build
	if [ "$XBPS_BUILD_ENVIRONMENT" = "void-packages-ci" ]; then
		vsed -i "tests/meson.build" -e "/{ 'name': 'virshtest',/d"
		vsed -i "tests/meson.build" -e "/{ 'name': 'commandtest' },/d"
	fi
	# racey custom targets; prevent parallelism issues
	ninja -C build \
		src/remote/lxc_protocol.h \
		src/remote/qemu_protocol.h \
		src/remote/remote_protocol.h \
		src/util/virkeycodetable_linux.h \
		src/util/virkeycodetable_osx.h \
		src/util/virkeycodetable_win32.h \
		src/util/virkeynametable_linux.h \
		src/util/virkeynametable_osx.h \
		src/util/virkeynametable_win32.h
}

post_install() {
	local _services _srv

	# runit services; libvirtd is for legacy use
	_services="libvirt-generic libvirtd virtqemud virtvboxd virtxend
	 virtlxcd virtlockd virtlogd virtproxyd virtinterfaced virtnetworkd
	 virtnodedevd virtnwfilterd virtsecretd virtstoraged"
	for _srv in $_services; do
		vsv $_srv
	done

	# Remove unused stuff.
	rm -rf ${DESTDIR}/etc/sysconfig
	rm -rf ${DESTDIR}/var/log

	# workaround for musl not providing an utmpx implementation
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		echo "remember_owner = 0" >> ${DESTDIR}/etc/libvirt/qemu.conf
	fi
}

libvirt-devel_package() {
	depends="libvirt>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
		vmove usr/share/doc
	}
}
