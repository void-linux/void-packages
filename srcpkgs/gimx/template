# Template file for 'gimx'
pkgname=gimx
version=8.0
revision=1
build_style=gnu-makefile
make_use_env=yes
hostmakedepends="gettext pkg-config"
makedepends="libbluetooth-devel libcurl-devel libusb-devel libX11-devel libXi-devel
 libxml2-devel mhash-devel ncurses-devel wxWidgets-gtk3-devel"
short_desc="Use a computer as a hub for your gaming devices"
maintainer="amak <amak.git@outlook.com>"
license="GPL-3.0-only"
homepage="https://blog.gimx.fr/"
distfiles="https://github.com/matlo/GIMX/releases/download/v${version}/gimx_${version}-1.tar.gz"
checksum=783673435bd424ba49e6ad5911559a517f746e50dad0f10689f0dc53336a8e1e
shlib_provides="libgimxconfigeditor.so libgimxconfigupdater.so libgimxcontroller.so
 libgimxdownloader.so libgimxfile.so libgimxgpp.so libgimxhid.so libgimxinput.so
 libgimxlog.so libgimxpoll.so libgimxprio.so libgimxserial.so libgimxtimer.so
 libgimxtime.so libgimxudp.so libgimxuhid.so libgimxupdater.so libgimxusb.so"

# silence unused function errors in loader/gimx-loader.cpp
# that are triggered by archs not defined in info.h
CXXFLAGS="-Wno-unused-function"

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" ncurses-devel"
fi

post_patch() {
	# fix build with ncurses 6
	vsed -i -e "s:ncursesw5-config:ncursesw6-config:" core/Makefile

	# fix ncursesw/ncurses.h include
	vsed -i -e "s:<ncursesw/ncurses.h>:<curses.h>:" core/display.c

	# fix build with wxWidgets-gtk3
	find . -iname Makefile -exec sed -i -e "s:wx-config:&-gtk3:" "{}" \;
}

post_install() {
	vdoc README.md
}

gimx-firmware_package() {
	short_desc+=" - firmware files"

	pkg_install() {
		vmove usr/share/gimx/firmware
	}
}

gimx-gui_package() {
	depends="gimx>=${version}_${revision} gimx-firmware>=${version}_${revision}
	 avrdude xdg-utils xterm"
	short_desc+=" - GUI tools"

	pkg_install() {
		for bin in config fpsconfig launcher loader ; do
			vmove "usr/bin/gimx-${bin}"
		done
		vmove usr/share/applications
		vmove usr/share/pixmaps
	}
}
