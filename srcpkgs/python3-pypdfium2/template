# Template file for 'python3-pypdfium2'
pkgname=python3-pypdfium2
version=5.3.0
revision=1
build_style=python3-pep517
build_wrksrc="pypdfium2-${version}"
hostmakedepends="python3-setuptools_scm python3-wheel python3-packaging tar pkg-config gcc"
makedepends="python3-devel libpdfium-devel"
depends="python3 libpdfium"
short_desc="Python bindings to PDFium"
maintainer="Mateusz Sylwestrzak <slymattz@gmail.com>"
license="Apache-2.0 OR BSD-3-Clause"
homepage="https://github.com/pypdfium2-team/pypdfium2"
_ctypesgen_commit="b561360fad763b4a64e2d8ef8f7ddf354670dbb7" # use pypdfium2's own fork of ctypesgen
distfiles="${PYPI_SITE}/p/pypdfium2/pypdfium2-${version}.tar.gz
 https://github.com/pypdfium2-team/ctypesgen/archive/${_ctypesgen_commit}.tar.gz>ctypesgen-${_ctypesgen_commit}.tar.gz"
checksum="2873ffc95fcb01f329257ebc64a5fdce44b36447b6b171fe62f7db5dc3269885
 5ae14b36da396d3bea23e41f615c12349697be63144fc840f29336e50ab94406"
create_wrksrc=yes

post_extract() {
	mv "ctypesgen-${_ctypesgen_commit}" "ctypesgen_fork"
}

pre_build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION="${version}"
	export PDFIUM_PLATFORM="sourcebuild"

	_data_dir="data/sourcebuild"
	mkdir -p "${_data_dir}"

	_pdfium_ver=$(pkg-config --modversion pdfium)
	_incdir="${XBPS_CROSS_BASE:-}/usr/include"
	_header_dir="${_incdir}/pdfium"

	[ ! -d "${_header_dir}" ] && _header_dir="/usr/include/pdfium"
	[ ! -d "${_incdir}" ] && _incdir="/usr/include"

	_headers=$(find "${_header_dir}" -maxdepth 1 -name "*.h" | sort)

	cat > "${_data_dir}/version.json" <<-EOF
		{"major":0,"minor":0,"build":${_pdfium_ver},"patch":0,"origin":"sourcebuild","flags":[],"n_commits":0,"hash":"","is_reproducible":true}
	EOF

	PYTHONPATH="../ctypesgen_fork/src" python3 -m ctypesgen \
		--library pdfium --no-srcinfo \
		--headers ${_headers} \
		--cpp "${CC} -E ${CFLAGS} ${CPPFLAGS}" \
		-I "${_header_dir}" -I "${_incdir}" -I "$(${CC} -print-file-name=include)" \
		-D "FPDF_EXPORT=" -D "FPDF_CALLCONV=" -D "__linux__" \
		-o "${_data_dir}/bindings.py"

	sed -i "s|name = 'pdfium'|name = 'libpdfium.so.1'|g" "${_data_dir}/bindings.py"

	ln -sf "${XBPS_CROSS_BASE}/usr/lib/libpdfium.so.1" "${_data_dir}/libpdfium.so.1"

	sed -i '/ctypesgen/d' pyproject.toml
}

post_install() {
	vlicense MANIFEST.in

	# The package should rely on the system library, not a bundled link.
	find "${DESTDIR}" -name "libpdfium.so.1" -delete
}
