# Template file for 'JamesDSP'
# Keep in sync with JamesDSP-headless
pkgname=JamesDSP
version=2.7.0
revision=1
build_style=qmake
hostmakedepends="gcc make pkg-config qt6-base"
makedepends="libarchive-devel qt6-base qt6-svg-devel glib-devel glibmm-devel pipewire-devel"
short_desc="Audio effect processor for PipeWire and PulseAudio clients"
maintainer="Anachron <gith@cron.world>"
license="GPL-3.0-or-later"
homepage="https://github.com/Audio4Linux/JDSP4Linux"
_flattabwidget_commit=06509713d85dc336c4a3b089ef9d265003aaf48e
_graphiceqwidget_commit=ba63ad32682b20e2d4fde4c8a4aafe4da3423cc5
_liquidequalizerwidget_commit=82a0c5240093e58b97ccbeb3716ee64e71a68d7c
_liveprogide_commit=b2f392480e00ca232c397610f42688b165b87640
distfiles="https://github.com/Audio4Linux/JDSP4Linux/archive/refs/tags/${version}.tar.gz
 https://github.com/timschneeb/FlatTabWidget/archive/${_flattabwidget_commit}.tar.gz
 https://github.com/timschneeb/GraphicEQWidget/archive/${_graphiceqwidget_commit}.tar.gz
 https://github.com/timschneeb/LiquidEqualizerWidget/archive/${_liquidequalizerwidget_commit}.tar.gz
 https://github.com/timschneeb/LiveprogIDE/archive/${_liveprogide_commit}.tar.gz"
checksum="9acbc0e67fe94ecfa770b007c1d70a3efcf267be355fb15cd0ca6a307a479bc5
 090009eb6f14ea02e2e2c70d1d410822b528c65766bb5ce33db808e88f9b4d9c
 ef3259cb2191cfd7903379f99f026e011f673702673faa6e31be667a1903b1d3
 57616781f88e2d94f57b1f62878a9430240828f90b5a6324bcbb754a86f33872
 83362bd38f6c8c189d71e7e48004a35ecc90075ace683c388ffb0b6bab5b87b7"
skip_extraction="
 ${_flattabwidget_commit}.tar.gz
 ${_graphiceqwidget_commit}.tar.gz
 ${_liquidequalizerwidget_commit}.tar.gz
 ${_liveprogide_commit}.tar.gz"
conflicts="JamesDSP-headless"

case "${XBPS_TARGET_MACHINE}" in
 *-musl) broken="subtree/Main/libjamesdsp/jni/jamesdsp/jdsp/jdspController.c:66:24: error: storage size of 'tv' isn't known";;
 aarch64) broken="https://github.com/Audio4Linux/JDSP4Linux/issues/187";;
esac

post_extract() {
	vsrcextract -C src/subprojects/FlatTabWidget "${_flattabwidget_commit}.tar.gz"
	vsrcextract -C src/subprojects/GraphicEQWidget "${_graphiceqwidget_commit}.tar.gz"
	vsrcextract -C src/subprojects/LiquidEqualizerWidget "${_liquidequalizerwidget_commit}.tar.gz"
	vsrcextract -C src/subprojects/EELEditor "${_liveprogide_commit}.tar.gz"
	vsed -i -e "s|^DEFINES += APP_VERSION=.*$|DEFINES += APP_VERSION=${version}|g" "src/src.pro"
}
