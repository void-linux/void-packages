# Template file for 'libkrunfw'
pkgname=libkrunfw
version=4.9.0
revision=1
_kernel_version=6.12.20
archs="x86_64* aarch64*"
build_style=gnu-makefile
hostmakedepends="python3-pyelftools tar xz bc cpio flex perl elfutils-devel"
short_desc="Dynamic library bundling the guest payload consumed by libkrun"
maintainer="Daniel Martinez <danielmartinez@cock.li>"
license="GPL-2.0-only AND LGPL-2.1-only"
homepage="https://github.com/containers/libkrunfw"
distfiles="https://github.com/containers/libkrunfw/archive/refs/tags/v${version}.tar.gz
${KERNEL_SITE}/kernel/v${_kernel_version%%.*}.x/linux-${_kernel_version}.tar.xz"
checksum="c1781a0da17174751705ef857c9ecd3aa18c61ca8d3f1e4aacddf55761fd2400
 230e89b07b0ab82e74f07ecc1bee3105dca81d0ef4a97f900929c407249b6ac7"

skip_extraction="linux-${_kernel_version}.tar.xz"


do_build() {
	local _arch _cross

	case "$XBPS_TARGET_MACHINE" in
		x86_64*) _arch=x86_64;;
		aarch64*) _arch=arm64 ;;
	esac

	if [ "$CROSS_BUILD" ]; then
		_cross="CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-"
	fi

	export LDFLAGS=

	make ARCH=$_arch ${_cross} ${makejobs}
}

post_extract() {
	mkdir tarballs
	vsrccopy linux-${_kernel_version}.tar.xz tarballs
}
