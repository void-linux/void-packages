# Template file for 'lemmy-ui'
pkgname=lemmy-ui
version=0.18.5
revision=1
_translation_commit=1c42c579460871de7b4ea18e58dc25543b80d289
hostmakedepends="yarn pkg-config python3"
makedepends="libvips-devel"
depends="nodejs"
short_desc="Official web app for lemmy"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="AGPL-3.0-only"
homepage="https://join-lemmy.org/"
distfiles="https://github.com/LemmyNet/lemmy-ui/archive/refs/tags/${version}.tar.gz
 https://github.com/LemmyNet/lemmy-translations/archive/${_translation_commit}.tar.gz"
checksum="8733497b6269d3d2e02ef3ad3ec87d76ed981cbebd924aef5313b8fe85211737
 7775b2a3070205f9b4b099215b30ee6bef3d5fb0c4e95aab52697e2bcb7cf9f7"
python_version=3
system_accounts="_lemmyui"

export NODE_ENV=production
case "$XBPS_TARGET_MACHINE" in
	aarch64*) export npm_config_arch=arm64;;
	armv5*) export npm_config_arch=arm; export npm_config_arm_version=5;;
	armv6*) export npm_config_arch=arm; export npm_config_arm_version=6;;
	armv7*) export npm_config_arch=arm; export npm_config_arm_version=7;;
	i686*) export npm_config_arch=ia32;;
	x86_64*) export npm_config_arch=x64;;
esac
export npm_config_build_from_source=true
if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	export npm_config_libc=musl
fi
export npm_config_platform=linux

post_extract() {
	cp -r lemmy-ui-${version}/. .
	cp -r lemmy-translations-${_translation_commit}/. lemmy-translations
	rm -rf lemmy-${version} lemmy-translations-${_translation_commit}

	yarn install --pure-lockfile
}

post_patch() {
	vsed -i "s/unknown version/$version/" src/shared/version.ts
}

do_build() {
	yarn build:prod
}

do_install() {
	npm prune
	vmkdir usr/lib/lemmy-ui
	vcopy dist usr/lib/lemmy-ui
	vcopy node_modules usr/lib/lemmy-ui
	vlicense LICENSE
	vsv lemmy-ui
}
