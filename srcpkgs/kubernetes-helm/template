# Template file for 'kubernetes-helm'
pkgname=kubernetes-helm
version=3.19.0
revision=1
build_style=go
build_helper=qemu
go_import_path="helm.sh/helm/v3"
go_package="./cmd/helm"
go_mod_mode=off
go_ldflags="-X helm.sh/helm/v3/internal/version.version=v${version%.*}"
make_check_args="-skip=^TestInstallRelease_Wait$"
checkdepends="git"
short_desc="Kubernetes Package Manager"
maintainer="Orphaned <orphan@voidlinux.org>"
license="Apache-2.0"
homepage="https://helm.sh/"
changelog="https://github.com/helm/helm/releases"
distfiles="https://github.com/helm/helm/archive/refs/tags/v${version}.tar.gz"
checksum=b008a47e4660109867f4ed3da12a53ad16cd650fdf0a60ad4f5c80d01a1b7493
conflicts="helm"
nopie=yes

LDFLAGS="-fuse-ld=bfd"

post_install() {
	if [ "$XBPS_TARGET_MACHINE" != aarch64-musl ]; then
		# qemu-aarch64-static segfaults
		# https://build.voidlinux.org/builders/aarch64-musl_builder/builds/49864/steps/shell_3/logs/stdio
		for shell in bash zsh; do
			vtargetrun "${DESTDIR}/usr/bin/helm" completion "${shell}" > "helm.${shell}"
			vcompletion "helm.${shell}" "${shell}"
		done
	fi
}
