# Template file for 'akonadi5'
pkgname=akonadi5
version=20.04.2
revision=1
wrksrc="akonadi-${version}"
build_style=cmake
hostmakedepends="extra-cmake-modules qt5-qmake qt5-host-tools python3
 shared-mime-info libxslt pkg-config gettext"
makedepends="qt5-devel qt5-plugin-mysql qt5-plugin-odbc qt5-plugin-pgsql
 qt5-plugin-sqlite qt5-plugin-tds kcompletion-devel kconfigwidgets-devel
 kdbusaddons-devel kiconthemes-devel kitemmodels-devel kio-devel sqlite-devel
 kaccounts-integration-devel libaccounts-qt5-devel qt5-tools-devel"
depends="shared-mime-info"
short_desc="PIM layer providing an asynchronous API to access PIM data"
maintainer="John <johnz@posteo.net>"
license="LGPL-2.1-or-later"
homepage="https://community.kde.org/KDE_PIM/Akonadi"
distfiles="${KDE_SITE}/release-service/${version}/src/akonadi-${version}.tar.xz"
checksum=b2e4bb3a8038ecb47bcdecc25edad21a6c5eb0366c1e739064ccaa3f13b20f16

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" qt5-tools-devel qt5-devel kconfig kcoreaddons"
fi

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	makedepends+=" libatomic-devel"
fi

pre_configure() {
	if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
		vsed -e "s;^\(target_link_libraries(.*\);\1 atomic;" -i src/server/CMakeLists.txt
	fi
}

pre_build() {
	if [ "$CROSS_BUILD" ]; then
		sed -e "s?/usr/${XBPS_CROSS_TRIPLET}??g" \
			-i build/src/private/protocolgen/CMakeFiles/protocolgen.dir/flags.make
		sed -e "s?/usr/${XBPS_CROSS_TRIPLET}??g" \
			-i build/src/private/protocolgen/CMakeFiles/protocolgen.dir/link.txt
		sed -e 's!\&\& protocolgen!\&\& ../../bin/protocolgen!' \
			-i build/src/private/CMakeFiles/generate_protocol.dir/build.make
	fi
}

akonadi5-devel_package() {
	short_desc+=" - development"
	depends="${makedepends} ${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/qt5/mkspecs
		vmove usr/lib/cmake
		vmove usr/lib/*.so
	}
}
