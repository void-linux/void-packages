# Template file for 'librespot'
pkgname=librespot
version=0.7.1
revision=1
build_style=cargo
hostmakedepends="pkg-config"
makedepends="alsa-lib-devel openssl-devel"
short_desc="Open Source Spotify Connect Client"
maintainer="Pelle Windestam <pelle@windestam.se>"
license="MIT"
homepage="https://github.com/librespot-org/librespot"
distfiles="https://github.com/librespot-org/librespot/archive/refs/tags/v${version}.tar.gz"
checksum=1d09cf7a9b05663bc74806dc729dba818f2f1108728b60ccaac42bb54bf46864

# ---- Build options ----
# Defaults: ALSA + rustls + libmdns (pure-Rust) ; add backends as needed.
build_options="pulseaudio gstreamer jack native_tls"
build_options_default="pulseaudio"

# Conditionally add -devel deps for enabled backends / TLS
if [ "$build_option_pulseaudio" ]; then
	makedepends+=" libpulseaudio"
fi
if [ "$build_option_gstreamer" ]; then
	makedepends+=" gstreamer1-devel"
fi
if [ "$build_option_jack" ]; then
	makedepends+=" jack-devel"
fi
if [ "$build_option_native_tls" ]; then
	makedepends+=" openssl-devel"
fi

# Compose features based on selected options
pre_build() {
	_features="with-libmdns,alsa-backend"
	if [ "$build_option_pulseaudio" ]; then
		_features="$_features,pulseaudio-backend"
	fi
	if [ "$build_option_gstreamer" ]; then
		_features="$_features,gstreamer-backend"
	fi
	if [ "$build_option_jack" ]; then
		_features="$_features,jackaudio-backend"
	fi
	if [ "$build_option_native_tls" ]; then
		_features="$_features,native-tls"
	else
		_features="$_features,rustls-tls"
	fi
}

post_install() {
	vbin target/${RUST_TARGET}/release/librespot
	vlicense LICENSE
	vdoc README.md
}
