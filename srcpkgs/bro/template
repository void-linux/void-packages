# Template file for 'bro'
pkgname=bro
version=2.6.4
revision=2
archs="x86_64* i686* aarch64* armv7* ppc64*"
build_style=cmake
hostmakedepends="flex pkg-config python3 libpcap-devel zlib-devel
 libressl-devel"
makedepends="bind-devel geoip-devel libpcap-devel libressl-devel jemalloc-devel"
short_desc="Advanced framework for network traffic analysis"
maintainer="Andrew Benson <abenson+void@gmail.com>"
license="BSD-3-Clause"
homepage="https://www.bro.org"
distfiles="https://download.zeek.org/bro-${version}.tar.gz"
checksum=a47a9cdcef0ea14d5f70c390ab266f0333063ff96f3869a5f1609581a1d1ceb7

case "$XBPS_TARGET_MACHINE" in
	*-musl)
		makedepends+=" musl-fts-devel"
		;;
esac

pre_configure() {
	if [ "$XBPS_TARGET_LIBC" = musl ]; then
		vsed -i '/set(broxygen_SRCS/i link_libraries("-lfts")' \
			src/broxygen/CMakeLists.txt
	fi
	if [ "$CROSS_BUILD" ]; then
		mkdir -p native
		cd native
		CC=$CC_FOR_BUILD CFLAGS="$CFLAGS_FOR_BUILD" \
		CXX=$CXX_FOR_BUILD CXXFLAGS="$CXXFLAGS_FOR_BUILD" \
		LD=$LD_FOR_BUILD LDFLAGS="$LDFLAGS_FOR_BUILD" \
		cmake ..
		make ${makejobs} binpac bifcl
		configure_args+="
		 -DBIFCL_EXE_PATH:PATH=${wrksrc}/native/aux/bifcl/bifcl
		 -DBINPAC_EXE_PATH:PATH=${wrksrc}/native/aux/binpac/src/binpac"
		cd ..
	fi
}

post_install() {
	vsv bro
	vlicense COPYING
}

binpac_package() {
	short_desc+=" - protocol parser compiler"
	pkg_install() {
		vmove /usr/bin/binpac
	}
}

binpac-devel_package() {
	short_desc+=" - protocol parser compiler library"
	pkg_install() {
		vmove usr/bin/bro-config
		vmove usr/include
		vmove "usr/lib/*.a"
		vmove "usr/lib/*.so"
		vmove usr/share/bro/cmake
	}
}
