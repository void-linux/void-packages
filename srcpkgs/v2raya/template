# Template file for 'v2raya'
pkgname=v2raya
version=1.5.9.1698.1
revision=1
wrksrc="v2rayA-${version}"
build_wrksrc="service"
build_style="go"
go_import_path="github.com/v2rayA/v2rayA"
go_ldflags="-X github.com/v2rayA/v2rayA/conf.Version=${version} -s -w"
hostmakedepends="go nodejs yarn"
depends="v2ray>=4.37.0_1"
short_desc="Web GUI client of Project V which supports various protocals"
maintainer="ketlrznt <tansuanyinliao8888@gmail.com>"
license="AGPL-3.0-only"
homepage="https://github.com/v2rayA/v2rayA"
distfiles="https://github.com/v2rayA/v2rayA/archive/v${version}.tar.gz"
checksum="247a357230c616bf48309c61d119686e4ad56939c05afef584c45051e9dc6220"

# build for i686
# issue: https://go.dev/issue/52919
# fix: https://go-review.googlesource.com/c/go/+/421935/
#
export CGO_CFLAGS="-fno-stack-protector"

pre_build() {
	cd ${wrksrc}/gui
	yarn --check-files
	OUTPUT_DIR="${wrksrc}/service/server/router/web" yarn build
}

post_install() {
	# default go build style generates `v2rayA` file,
	# change it to `v2raya` to keep lowercase consistent
	vbin ${DESTDIR}/usr/bin/v2rayA v2raya
	rm ${DESTDIR}/usr/bin/v2rayA
	cd ${wrksrc}
	vinstall install/universal/v2raya.desktop 0644 usr/share/applications
	vsv v2raya
	vinstall gui/public/img/icons/android-chrome-512x512.png \
	0644 usr/share/icons/hicolor/512x512/apps/ v2raya.png
	vlicense LICENSE
}
