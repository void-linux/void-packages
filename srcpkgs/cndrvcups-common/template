# Template file for 'cndrvcups-common'
pkgname=cndrvcups-common
version=4.00
revision=1
_SOURCES_NAME="linux-UFRII-drv-v360-uken"
wrksrc="${_SOURCES_NAME}"
build_wrksrc="Sources/${pkgname}-${version}"
hostmakedepends="pkg-config"
makedepends="cups-devel glib-devel libtool automake autoconf libxml2-devel
libglade-devel gtk+-devel"
short_desc="Common files for Canon drivers"
maintainer="1is7ac3 <isaac.qa13@gmail.com>"
license="Canon-UFR-II"
homepage="https://www.canon-europe.com/support/products/"
distfiles="http://gdlp01.c-wss.com/gds/0/0100009240/02/${_SOURCES_NAME}.tar.gz"
checksum=a5bf2c2d53049ad64acf2ed8b6dc954ff261c4b996ce1cc81471e5baaf5e40cd

only_for_archs="i686 x86_64 x86_64-musl"

nostrip_files="c3pldrv"
_setvars() {
	declare -A _lib32dirs=([i686]='lib' [x86_64]='lib32')
	_vars=(
		_bindir='/usr/bin'
		libs32="/usr/${_lib32dirs[${XBPS_MACHINE}]}"
		_libdir='/usr/lib'
		_prefix='/usr'
		_includedir='/usr/include'
		locallibs='/usr/lib'
	)
}

post_extract() {
	cd ${wrksrc}/Sources
	tar xf "${pkgname}-${version}"-1.tar.gz
}

do_build() {
	export LIBS="-lgtk-x11-2.0 -lgobject-2.0 -lglib-2.0 -lgmodule-2.0"
	local _vars; _setvars
	export "${_vars[@]}"
	cd buftool
	autoreconf -i
	./autogen.sh --prefix="${_prefix}" --enable-progpath="${_bindir}" \
	--libdir="${_libdir}"

	cd ../cngplp
	autoreconf -i
	./autogen.sh --prefix="${_prefix}" --libdir="${locallibs}"

	cd ../backend
	autoreconf -i
	./autogen.sh --prefix="${_prefix}" --libdir="${_libdir}"

	cd ..
	make

	cd c3plmod_ipc
	make

	}

	do_install() {
	local _vars; _setvars
	export "${_vars[@]}"
	make install STRIP="true" PREFIX=/usr DESTDIR="${DESTDIR}"
	cd c3plmod_ipc
	make install STRIP="true" PREFIX=/usr DESTDIR="${DESTDIR}" LIBDIR=${_libdir}
	cd ..
	vmkdir ${_prefix}/share/caepcm
	vmkdir ${_prefix}/share/cups/usb
	vcopy Rule/*.usb-quirks ${_prefix}/share/cups/usb
	vcopy data/* ${_prefix}/share/caepcm
	vbin libs/c3pldrv
	vinstall libs/libcaiowrap.so.1.0.0 755 ${_libdir}
	vinstall libs/libcaiousb.so.1.0.0 755 ${_libdir}
	vinstall libs/libc3pl.so.0.0.1 755 ${_libdir}
	vinstall libs/libcaepcm.so.1.0 755 ${_libdir}
	vinstall libs/libColorGear.so.0.0.0 755 ${_libdir}
	vinstall libs/libColorGearC.so.1.0.0 755 ${_libdir}
	vinstall libs/libcanon_slim.so.1.0.0 755 ${_libdir}
	cd "${DESTDIR}"${_libdir}
	for lib in *.so.?.?.?; do
		ln -s "${lib}" "${lib%.?.?}"
		ln -s "${lib}" ""${lib%.?.?.?}""
	done
	ln -s libcaepcm.so.1.0 libcaepcm.so.1
	ln -s libcaepcm.so.1.0 libcaepcm.so
	}
