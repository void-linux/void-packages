# Template file for 'brother-dcp8410-cups'
pkgname=brother-dcp8410-cups
version=1.5.0
revision=1
archs="i686 x86_64"
create_wrksrc=yes
hostmakedepends="curl"
depends="brother-dcp8410-lpr cups cups-filters"
short_desc="CUPS wrapper driver for the Brother DCP-L8410CDW machines"
maintainer="Shahab Vahedi <list+void@vahedi.org>"
license="custom:BrotherEULA"
homepage="https://support.brother.com/g/b/producttop.aspx?c=eu_ot&lang=en&prod=dcpl8410cdw_eu"
distfiles="https://download.brother.com/welcome/dlf103248/dcpl8410cdwcupswrapper-${version}-0.i386.deb"
checksum="b9deb04a6b8f7dd800e04cd90dcd3fa6129214bf36d63649b1710915fd8b549a"
repository="nonfree"
_license_checksum=4ab8b9269a74377ee85458cc4dfbacfbf6d26665426572fe16f7102af214bd3c

# Copied from brother-brscan3/template
post_extract() {
	curl -sk https://support.brother.com/g/s/agreement/English_lpr/agree.html | \
		sed -n \
			-e 's,</\?p>,,' \
			-e 's/\&quot;/"/g' \
			-e 's, \?^M,,' \
			-e 's,^[ \t]\+,,' \
			-e '14,18p' \
			-e '28,45p' \
		> LICENSE

	filesum="$(xbps-digest LICENSE)"
	if [ "$filesum" != "$_license_checksum" ]; then
		msg_error "SHA256 mismatch for LICENSE:\n$filesum\n"
	fi
}

do_install() {
	vmkdir opt/brother/Printers/dcpl8410cdw/cupswrapper 755

	vinstall opt/brother/Printers/dcpl8410cdw/cupswrapper/brother_dcpl8410cdw_printer_en.ppd \
		644 opt/brother/Printers/dcpl8410cdw/cupswrapper
	vinstall opt/brother/Printers/dcpl8410cdw/cupswrapper/brother_lpdwrapper_dcpl8410cdw \
		755 opt/brother/Printers/dcpl8410cdw/cupswrapper
	vinstall opt/brother/Printers/dcpl8410cdw/cupswrapper/cupswrapperdcpl8410cdw \
		755 opt/brother/Printers/dcpl8410cdw/cupswrapper

	# Copy the PPD file to its rightful place
	vmkdir usr/share/cups/model/Brother 755
	vinstall opt/brother/Printers/dcpl8410cdw/cupswrapper/brother_dcpl8410cdw_printer_en.ppd \
		644 usr/share/cups/model/Brother

	# Create a link to lpdwrapper in CUPS filter directory
	vmkdir usr/lib/cups/filter 755
	ln -sf /opt/brother/Printers/dcpl8410cdw/cupswrapper/brother_lpdwrapper_dcpl8410cdw \
		${DESTDIR}/usr/lib/cups/filter/brother_lpdwrapper_dcpl8410cdw

	vlicense LICENSE
	vdoc "${FILESDIR}/README.maintainer"
}
