# Template file for 'mir'
pkgname=mir
version=1.0.0
revision=1
build_style=cmake
configure_args="-DMIR_ENABLE_TESTS=OFF"
hostmakedepends="pkg-config"
makedepends="MesaLib-devel boost-devel capnproto-devel freetype-devel
 gflags-devel glm glog-devel libatomic-devel libepoxy-devel libinput-devel
 libxkbcommon-devel libxml++-devel lttng-ust-devel nettle-devel protobuf-devel
 python3-Pillow wayland-devel libXcursor-devel libXrender-devel yaml-cpp-devel"
depends="dbus qt5-wayland"
short_desc="Cross-platform display manager"
maintainer="maxice8 <thinkabit.ukim@gmail.com>"
license="GPL-3.0-only"
homepage="https://mir-server.io/"
distfiles="https://github.com/MirServer/mir/releases/download/v${version}/mir-${version}.tar.xz"
checksum=4fab613954e4afc3964b1b397fc1edf4fd0f7b9ad5e63391e6cf2c08194136a0
nocross="src/protobuf/CMakeFiles/mirprotobuf.dir/build.make:61: *** target pattern contains no '%'. "

case "$XBPS_TARGET_MACHINE" in
	*-musl) broken="dlvsym usage" ;;
esac

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" capnproto python3-Pillow"
fi

pre_configure() {
	sed -i 's|-Werror||g' CMakeLists.txt
}

post_install() {
	# Remove demo and stess testing stuff
	rm -rf -- ${DESTDIR}/usr/bin/mir_demo*
	rm -rf -- ${DESTDIR}/usr/lib/libmir_demo*
	rm -rf -- "${DESTDIR}/usr/lib/mir/tools"
}

libmirserver_package() {
	short_desc+=" - server library"
	pkg_install() {
		vmove "usr/lib/libmirserver.so.*"
	}
}

libmirserver-devel_package() {
	depends="libmirserver-${version}_${revision} glm libuuid-devel
	 libmirplatform-devel-${version}_${revision}
	 libmircommon-devel-${version}_${revision}"
	short_desc+=" - server development headers"
	pkg_install() {
		vmove usr/include/mirserver
		vmove usr/lib/pkgconfig/mirserver.pc
		vmove usr/lib/libmirserver.so
	}
}

mir-utils_package() {
	short_desc+=" - utilities"
	pkg_install() {
		vmove usr/bin/mirout
		vmove usr/bin/mirin
		vmove usr/bin/mirscreencast
		vmove usr/bin/mirbacklight
		vmove usr/bin/mirrun
	}
}

libmiral_package() {
	short_desc+=" - abstraction layer"
	pkg_install() {
		vmove "usr/lib/libmiral.so.*"
	}
}

libmiral-devel_package() {
	depends="libmiral-${version}_${revision}
	 libmirclient-devel-${version}_${revision}"
	short_desc+=" - development headers for abstraction layers"
	pkg_install() {
		vmove usr/include/miral/miral
		vmove usr/lib/pkgconfig/miral.pc
		vmove usr/lib/libmiral.so
	}
}

libmirclient_package() {
	short_desc+=" - client libraries"
	pkg_install() {
		vmove "usr/lib/libmirclient.so.*"
	}
}

libmirclient-devel_package() {
	depends="libmirclient-${version}_${revision} protobuf-devel
	 libmircommon-devel-${version}_${revision}
	 libmircookie-devel-${version}_${revision}"
	short_desc+=" - development headers for clients"
	pkg_install() {
		vmove "usr/include/mirclient/mir_toolkit/*.h"
		vmove "usr/include/mirclient/mir_toolkit/extensions/*.h"
		vmove "usr/include/mirclient/mir/client/*.h"
		vmove "usr/include/mirclient/mir/events/*.h"
		vmove usr/include/mirclient/mir/event_printer.h
		vmove usr/include/mirclient/mir_toolkit/events
		vmove usr/include/mirclient/mir_toolkit/rs/mir_render_surface.h
		vmove usr/lib/pkgconfig/mirclient.pc
		vmove usr/lib/pkgconfig/mirclientcpp.pc
		vmove usr/lib/libmirclient.so
	}
}

libmircore_package() {
	short_desc+=" - core library"
	pkg_install() {
		vmove "usr/lib/libmircore.so.*"
	}
}

libmircore-devel_package() {
	short_desc+=" - development headers for core library"
	pkg_install() {
		vmove usr/include/mircore
		vmove usr/lib/libmircore.so
		vmove usr/lib/pkgconfig/mircore.pc
	}
}

libmircommon_package() {
	short_desc+=" - common libraries"
	pkg_install() {
		vmove "usr/lib/libmircommon.so.*"
	}
}

libmircommon-devel_package() {
	depends="libmircommon-${version}_${revision} libxkbcomon-devel
	 libmircore-devel-${version}_${revision} protobuf-devel"
	short_desc+=" - development headers for common libraries"
	pkg_install() {
		vmove usr/include/mircommon
		vmove usr/lib/libmircommon.so
	}
}

libmirprotobuf_package() {
	short_desc+=" - protobuf library"
	pkg_install() {
		vmove "usr/lib/libmirprotobuf.so.*"
		vmove usr/lib/libmirprotobuf.so
	}
}

libmirplatform_package() {
	short_desc+=" - libraries for hardware interaction"
	pkg_install() {
		vmove "usr/lib/libmirplatform.so.*"
	}
}

libmirplatform-devel_package() {
	depends="libmirplatform-${version}_${revision}
	 libmircommon-devel-${version}_${revision} boost-devel"
	short_desc+=" - development headers for hardware interaction"
	pkg_install() {
		vmove usr/include/mirplatform
		vmove usr/lib/pkgconfig/mirplatform.pc
		vmove usr/lib/libmirplatform.so
	}
}

libmircookie_package() {
	short_desc+=" - library for timestamp management"
	pkg_install() {
		vmove "usr/lib/libmircookie.so.*"
	}
}

libmircookie-devel_package() {
	depends="libmircookie-${version}_${revision}"
	short_desc+=" - development headers for timestamp management"
	pkg_install() {
		vmove usr/include/mircookie
		vmove usr/lib/libmircookie.so
		vmove usr/lib/pkgconfig/mircookie.pc
	}
}

libmirrenderer-devel_package() {
	depends="libmircommon-devel-${version}_${revision}
	 libmirplatform-${version}_${revision}"
	short_desc+=" - development headers for renderer"
	pkg_install() {
		vmove "usr/include/mirrenderer/mir/renderer/*.h"
		vmove usr/lib/pkgconfig/mirrenderer.pc
	}
}

libmirclient-debug-extension_package() {
	short_desc+=" - debugging interfaces"
	pkg_install() {
		vmove "usr/lib/libmirclient-debug-extension.so.*"
	}
}

libmirclient-debug-extension-devel_package() {
	depends="libmirclient-debug-extension-${version}_${revision}"
	short_desc+=" - development headers for debugging interfaces"
	pkg_install() {
		vmove usr/include/mirclient/mir_toolkit/debug
		vmove usr/lib/pkgconfig/mirclient-debug-extension.pc
		vmove usr/lib/libmirclient-debug-extension.so
	}
}

mir-renderer-gl-devel_package() {
	short_desc+=" - development headers for GL rendering"
	pkg_install() {
		vmove usr/include/mirrenderer/mir/renderer/gl
		vmove usr/lib/pkgconfig/mir-renderer-gl-dev.pc
	}
}

mir-client-platform-mesa-devel_package() {
	depends="libmirclient-devel-${version}_${revision}"
	short_desc+=" - development headers for Mir Mesa backend"
	pkg_install() {
		vmove usr/include/mirplatforms/mir_toolkit/mesa
		vmove usr/lib/pkgconfig/mir-client-platform-mesa.pc
	}
}
