# Template file for 'gnome-shell'
pkgname=gnome-shell
version=3.36.3
revision=1
build_style=meson
build_helper=gir
configure_args="-Dsystemd=false"
hostmakedepends="gettext gobject-introspection gtk-doc libxslt pkg-config python3 sassc
 asciidoc perl gjs-devel glib-devel mutter-devel"
makedepends="at-spi2-atk caribou-devel evolution-data-server-devel folks-devel
 gcr-devel gjs-devel gnome-bluetooth-devel gnome-control-center-devel gnome-desktop-devel
 gnome-menus-devel gsettings-desktop-schemas-devel gstreamer1-devel gtk+3-devel
 ibus-devel json-glib-devel libcanberra-devel libcroco-devel libglib-devel
 libsecret-devel libsoup-devel libX11-devel libxml2-devel mutter-devel
 network-manager-applet-devel polkit-devel pulseaudio-devel
 startup-notification-devel telepathy-logger-devel gnome-autoar-devel"
depends="caribou elogind glxinfo gnome-control-center gsettings-desktop-schemas upower"
checkdepends="$depends accountsservice gdm xorg-server-xvfb pipewire mesa-dri dbus-x11"
short_desc="GNOME core user interface"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="GPL-2.0-or-later"
homepage="https://wiki.gnome.org/Projects/GnomeShell"
changelog="https://raw.githubusercontent.com/GNOME/gnome-shell/gnome-3-30/NEWS"
distfiles="${GNOME_SITE}/${pkgname}/${version%.*}/${pkgname}-${version}.tar.xz"
checksum=86d8abf70fab89d5d939dd7e38c59872492f444272a8524db79450a5180d45bb

do_check() {
	local _pid
	export DISPLAY=:1
	export XDG_RUNTIME_DIR=/tmp
	Xvfb :1 -screen 0 1366x768x24 &
	_pid=$!
	trap "kill $_pid" EXIT
	trap 'exit 1' INT HUP TERM
	eval $(dbus-launch)
	export DBUS_SESSION_BUS_ADDRESS
	ninja test -C build
	# trap is hanging on normal exit, dbus?
	trap - EXIT INT HUP TERM
	kill $_pid || true
}
