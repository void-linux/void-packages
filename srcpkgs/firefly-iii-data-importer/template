# Template file for 'firefly-iii-data-importer'
pkgname=firefly-iii-data-importer
version=0.9.17
revision=1
wrksrc="data-importer-${version}"
conf_files="/etc/webapps/firefly-iii-data-importer/data-importer.conf"
hostmakedepends="composer8.0 unzip"
depends="php8.0"
short_desc="Can import data into Firefly III"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="AGPL-3.0-or-later"
homepage="https://github.com/firefly-iii/data-importer"
changelog="https://raw.githubusercontent.com/firefly-iii/data-importer/main/changelog.md"
distfiles="https://github.com/firefly-iii/data-importer/archive/refs/tags/${version}.tar.gz"
checksum=f1bc84bab6b957f03be674d1b6429b0f25ce5960606f33abf3f7f9d24479998b
make_dirs="/var/lib/firefly-iii-data-importer/storage/app/public 0750 http http
 /var/lib/firefly-iii-data-importer/storage/configurations 0750 http http
 /var/lib/firefly-iii-data-importer/storage/conversion-routines 0750 http http
 /var/lib/firefly-iii-data-importer/storage/debugbar 0750 http http
 /var/lib/firefly-iii-data-importer/storage/framework/cache/data 0750 http http
 /var/lib/firefly-iii-data-importer/storage/framework/sessions 0750 http http
 /var/lib/firefly-iii-data-importer/storage/framework/testing 0750 http http
 /var/lib/firefly-iii-data-importer/storage/framework/views 0750 http http
 /var/lib/firefly-iii-data-importer/storage/jobs 0750 http http
 /var/lib/firefly-iii-data-importer/storage/logs 0750 http http
 /var/lib/firefly-iii-data-importer/storage/submission-routines 0750 http http
 /var/lib/firefly-iii-data-importer/storage/uploads 0750 http http
 /var/cache/firefly-iii-data-importer 0750 http http"

do_build() {
	composer8.0 install --no-scripts --no-dev --ignore-platform-reqs
}

do_install() {
	vmkdir usr/share/webapps/firefly-iii-data-importer
	for i in app artisan bootstrap composer.json config database phpunit.xml \
	 public resources routes server.php vendor webpack.mix.js; do
		vcopy "$i" usr/share/webapps/firefly-iii-data-importer
	done

	vsconf .env.example data-importer.conf

	vinstall .env.example 644 /etc/webapps/firefly-iii-data-importer data-importer.conf
	ln -s /etc/webapps/firefly-iii-data-importer/data-importer.conf \
	 "${DESTDIR}"/usr/share/webapps/firefly-iii-data-importer/.env

	ln -s /var/lib/firefly-iii-data-importer/storage \
	 "${DESTDIR}"/usr/share/webapps/firefly-iii-data-importer

	rm -rf "${DESTDIR}"/usr/share/webapps/firefly-iii-data-importer/bootstrap/cache
	ln -s /var/cache/firefly-iii-data-importer \
	 "${DESTDIR}"/usr/share/webapps/firefly-iii-data-importer/bootstrap/cache

	vlicense LICENSE
}
