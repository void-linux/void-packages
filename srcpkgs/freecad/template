# Template file for 'freecad'
pkgname=freecad
version=0.17
revision=10
wrksrc="FreeCAD-${version}"
build_style=cmake

# CMAKE_INSTALL_LIBDIR by default doesn't use PREFIX, so set it manually
_inst_prefix=/usr/lib/${pkgname}
configure_args="
 -DBUILD_QT5=ON
 -DCMAKE_INSTALL_PREFIX=${_inst_prefix}
 -DCMAKE_INSTALL_LIBDIR=${_inst_prefix}/lib
 -DMEDFILE_INCLUDE_DIRS=/usr/include/med"
hostmakedepends="pkg-config swig doxygen graphviz dos2unix"
makedepends="python3-devel boost-devel libxerces-c-devel zlib-devel occt-devel
 vtk-devel hdf5-devel openmpi-devel libmed-devel eigen double-conversion-devel
 coin3-devel libshiboken2-python3-devel libspnav-devel pyside2-tools liblz4-devel
 libpyside2-python3-devel python3-matplotlib netcdf-devel jsoncpp-devel
 qt5-devel qt5-svg-devel qt5-tools-devel qt5-webkit-devel coin3-doc"

# FreeCAD help: qt5/assistant with datas in SQLite format
depends="python3-pyside2 python3-matplotlib qt5-plugin-sqlite python3-pivy"

pycompile_version="$py3_ver"
pycompile_dirs="usr/lib/${pkgname}/Mod usr/lib/${pkgname}/data/Mod"

short_desc="General purpose 3D CAD modeler"
maintainer="yopito <pierre.bourgin@free.fr>"
license="LGPL-2.0-or-later"
homepage="https://freecadweb.org/"
distfiles="https://github.com/FreeCAD/FreeCAD/archive/${version}.tar.gz"
checksum=ae017393476b6dc7f1192bcaf91ceedc2f9b791f2495307ce7c45efadb5266fb

post_extract() {
	find $wrksrc -type f -exec dos2unix -q {} +

	# instead of "unknown" as reported by SubWCRev.py (SCM check)
	sed -i -e "s,\${PACKAGE_WCREF},${revision}_voidlinux," \
	       -e "s,\${PACKAGE_WCDATE},(from release)," \
	       -e "s,\${PACKAGE_WCURL},VoidLinux package ${pkgname}," \
	       src/Build/Version.h.cmake
}

post_install() {
	# AppHomePath is computed with binary's realpath:
	# do not move binaries but symlink them instead.
	vmkdir usr/bin
	for f in FreeCAD FreeCADCmd; do
		ln -s ${_inst_prefix}/bin/${f} ${DESTDIR}/usr/bin/${f}
	done

	# desktop integration
	vmkdir usr/share/applications
	vcopy ${FILESDIR}/freecad.desktop usr/share/applications
	sed -i -e "s,@_inst_prefix@,${_inst_prefix}," ${DESTDIR}/usr/share/applications/freecad.desktop
	vmkdir usr/share/appdata
	vcopy ${FILESDIR}/freecad.appdata.xml usr/share/appdata
	vmkdir usr/share/mime/packages
	vcopy ${FILESDIR}/freecad.xml usr/share/mime/packages
	for s in 16 32 48 64; do
		_dest_icon=usr/share/icons/hicolor/${s}x${s}/apps
		vmkdir ${_dest_icon}
		ln -s ${_inst_prefix}/data/freecad-icon-${s}.png ${DESTDIR}/${_dest_icon}/freecad.png
		ln -s ${_inst_prefix}/data/freecad.xpm ${DESTDIR}/${_dest_icon}/freecad.xpm
	done
	vmkdir usr/share/icons/scalable/apps
	ln -s ${_inst_prefix}/data/freecad.svg ${DESTDIR}/usr/share/icons/scalable/apps/freecad.svg
}
