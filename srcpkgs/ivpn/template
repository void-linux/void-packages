# Template file for 'ivpn'
pkgname=ivpn
version=3.4.5
revision=1
_ivpndir="desktop-app-${version}"
archs="x86_64"
create_wrksrc=yes
hostmakedepends="curl libcurl git go wireless_tools-devel"
depends="openvpn wireless_tools glibc lsof"
short_desc="IVPN Command Line Interface"
maintainer="b-l-a-i-n-e <blaine.gilbreth@gmail.com>"
license="GPL3-only"
homepage="https://www.ivpn.net"
distfiles="https://github.com/ivpn/desktop-app/archive/v${version}.tar.gz"
checksum=e6837cb653dc9089afa50281bc11df5da99da0b6edd597220f50646db0c8cccd
nopie=yes

do_build() {
	(cd "${_ivpndir}/daemon" && \
		./References/Linux/scripts/build-all.sh -v "${pkgver}" -c "${pkgver}_stamped")

	(cd "${_ivpndir}/cli" && \
		./References/Linux/compile-cli.sh -v "${pkgver}" -c "${pkgver}_stamped")
}

do_install() {
	local daemonlinuxdir="${_ivpndir}/daemon/References/Linux"
	local clilinuxdir="${_ivpndir}/cli/References/Linux"

	vmkdir usr/bin
	vinstall "${daemonlinuxdir}/scripts/_out_bin/ivpn-service" 755 usr/bin
	vinstall "${clilinuxdir}/_out_bin/ivpn" 755 usr/bin

	vmkdir opt/ivpn
	vmkdir opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/client.down" 700 opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/client.up" 700 opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/firewall.sh" 700 opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/servers.json" 600 opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/ca.crt" 400 opt/ivpn/etc
	vinstall "${daemonlinuxdir}/etc/ta.key" 400 opt/ivpn/etc

	vmkdir opt/ivpn/wireguard-tools
	vinstall "${daemonlinuxdir}/_deps/wireguard-tools_inst/wg-quick" 755 opt/ivpn/wireguard-tools
	vinstall "${daemonlinuxdir}/_deps/wireguard-tools_inst/wg" 755 opt/ivpn/wireguard-tools

	vmkdir opt/ivpn/obfsproxy
	vinstall "${daemonlinuxdir}/_deps/obfs4proxy_inst/obfs4proxy" 755 opt/ivpn/obfsproxy

	vsv ivpn-service
}
